---
import { sanityClient as client } from 'sanity:client';
import { siteSettingsQuery } from '@lib/sanity/queries';
import { createTranslator } from '@lib/i18n/translations';
import { urlForImage } from '@lib/sanity/image';
import { resolveLinkUrl } from '@lib/sanity/linkResolver';
import LanguageSwitcher from '@components/i18n/LanguageSwitcher.astro';

const currentLang = Astro.locals.lang || 'en';
const t = createTranslator(currentLang);

const settings = await client.fetch(siteSettingsQuery);
const navigation = settings?.navigation || [];

// Header display logic
const displayMode = settings?.header?.displayMode || 'text';
const logoVariant = settings?.header?.logoVariant;
const logo = logoVariant ? settings?.logos?.[logoVariant] : null;
const hasLogo = !!logo;
const logoUrl = hasLogo ? urlForImage(logo).width(200).url() : null;
const showLogo = (displayMode === 'logo' || displayMode === 'both') && hasLogo;
const showText =
  displayMode === 'text' ||
  displayMode === 'both' ||
  (displayMode === 'logo' && !hasLogo);
---

<header class="site-header">
  <div class="container">
    <nav aria-label={t('aria.main_navigation')}>
      <div class="nav-row">
        <a href="/" class="logo">
          {
            showLogo && (
              <img
                src={logoUrl}
                alt={settings?.title || 'Site Logo'}
                class="logo-image"
                width="200"
                height="auto"
              />
            )
          }
          {
            showText && (
              <span class="logo-text">{settings?.title || 'Site Title'}</span>
            )
          }
        </a>
        <button
          class="hamburger"
          aria-label="Toggle menu"
          aria-expanded="false"
        >
          <span class="hamburger__line"></span>
          <span class="hamburger__line"></span>
          <span class="hamburger__line"></span>
        </button>
      </div>
      <div class="nav-actions">
        <ul class="nav-list">
          {
            navigation.map((item: any) => {
              const href = resolveLinkUrl(item);
              const isExternal =
                item.openInNewTab || item.linkType === 'external';
              const externalAttrs = isExternal
                ? {
                    target: '_blank',
                    rel: 'noopener noreferrer',
                    'aria-label': `${item.text} (${t('aria.external_link')})`,
                  }
                : {};
              return (
                <li>
                  <a href={href} {...externalAttrs}>
                    {item.text}
                  </a>
                </li>
              );
            })
          }
        </ul>
        <LanguageSwitcher />
      </div>
    </nav>
  </div>
</header>

<style>
  .site-header {
    padding-block: var(--space-md);
    position: sticky;
    inset-block-start: 0;
    z-index: var(--z-sticky);
    background-color: rgba(255, 255, 255, 0.8);
    -webkit-backdrop-filter: blur(12px);
    backdrop-filter: blur(12px);
  }

  @media (min-width: 769px) {
    .site-header {
      height: var(--header-height);
      padding-block: 0;
      display: flex;
      align-items: center;
    }
  }

  nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: var(--space-lg);
  }

  .nav-row {
    display: contents;
  }

  .logo {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    color: var(--color-text);
  }

  .logo-image {
    display: block;
    max-height: 3rem;
    width: auto;
    object-fit: contain;
  }

  .logo-text {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-bold);
  }

  .nav-actions {
    display: flex;
    align-items: center;
    gap: var(--space-md);
  }

  .nav-list {
    display: flex;
    gap: var(--space-md);
    list-style: none;
  }

  .nav-list a {
    color: var(--color-text);
    transition: opacity var(--transition-fast);
  }

  .nav-list a:hover {
    opacity: 0.8;
  }

  /* Hamburger button - hidden on desktop */
  .hamburger {
    display: none;
    flex-direction: column;
    justify-content: center;
    gap: 5px;
    width: 32px;
    height: 32px;
    padding: 4px;
    background: transparent;
    border: none;
    cursor: pointer;
    z-index: 10;
  }

  .hamburger__line {
    display: block;
    width: 100%;
    height: 2px;
    background-color: var(--color-text);
    border-radius: 1px;
    transition:
      transform 0.3s ease,
      opacity 0.3s ease;
  }

  /* Hamburger animation to X */
  .hamburger.is-open .hamburger__line:nth-child(1) {
    transform: translateY(7px) rotate(45deg);
  }

  .hamburger.is-open .hamburger__line:nth-child(2) {
    opacity: 0;
  }

  .hamburger.is-open .hamburger__line:nth-child(3) {
    transform: translateY(-7px) rotate(-45deg);
  }

  @media (max-width: 768px) {
    .site-header {
      position: sticky;
    }

    nav {
      position: relative;
    }

    /* Top row with logo and hamburger */
    .nav-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
    }

    /* Show hamburger on mobile */
    .hamburger {
      display: flex;
    }

    /* Menu overlays content below header */
    .nav-actions {
      display: none;
      flex-direction: column;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background-color: rgba(255, 255, 255, 0.95);
      -webkit-backdrop-filter: blur(12px);
      backdrop-filter: blur(12px);
      padding: var(--space-md);
      gap: var(--space-md);
    }

    /* Show when open */
    .nav-actions.is-open {
      display: flex;
    }

    .nav-list {
      flex-direction: column;
      text-align: center;
      width: 100%;
      gap: var(--space-sm);
    }

    .nav-list a {
      display: block;
      padding: var(--space-sm) 0;
    }
  }
</style>

<script>
  import { setupAnimationLifecycle, gsap, ScrollTrigger } from '@lib/animation';

  setupAnimationLifecycle(() => {
    const header = document.querySelector('.site-header');
    const hamburger = document.querySelector('.hamburger');
    if (!header) return;

    // Use ScrollTrigger to handle scroll direction
    ScrollTrigger.create({
      onUpdate: (self) => {
        // Don't hide header when mobile menu is open
        if (hamburger?.classList.contains('is-open')) return;

        // Use self.scroll() to get current scroll position (works with Lenis)
        const scrollTop = self.scroll();
        const direction = self.direction;

        // Direction: 1 = down, -1 = up
        // Show if scrolling up OR at the very top (within first 50px)
        const shouldShow = direction === -1 || scrollTop < 50;

        gsap.to(header, {
          yPercent: shouldShow ? 0 : -100,
          duration: 0.3,
          ease: 'power2.out',
          overwrite: true,
        });
      },
    });
  });

  // Mobile menu toggle
  const hamburger = document.querySelector('.hamburger');
  const navActions = document.querySelector('.nav-actions');

  if (hamburger && navActions) {
    hamburger.addEventListener('click', () => {
      const isOpen = hamburger.classList.toggle('is-open');
      navActions.classList.toggle('is-open');
      hamburger.setAttribute('aria-expanded', String(isOpen));
    });

    // Close menu when clicking a nav link
    navActions.querySelectorAll('a').forEach((link) => {
      link.addEventListener('click', () => {
        hamburger.classList.remove('is-open');
        navActions.classList.remove('is-open');
        hamburger.setAttribute('aria-expanded', 'false');
      });
    });

    // Close menu on Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && hamburger.classList.contains('is-open')) {
        hamburger.classList.remove('is-open');
        navActions.classList.remove('is-open');
        hamburger.setAttribute('aria-expanded', 'false');
      }
    });
  }
</script>
