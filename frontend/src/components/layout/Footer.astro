---
import { sanityClient as client } from 'sanity:client';
import { siteSettingsQuery } from '@lib/sanity/queries';
import { createTranslator } from '@lib/i18n/translations';
import { resolveLinkUrl } from '@lib/sanity/linkResolver';
import { urlForImage } from '@lib/sanity/image';

const currentLang = Astro.locals.lang || 'en';
const t = createTranslator(currentLang);

const settings = await client.fetch(siteSettingsQuery);
const footerLinks = settings?.footer?.links || [];
const currentYear = new Date().getFullYear();

// Footer logo logic
const footerLogoVariant = settings?.footer?.logoVariant;
const footerLogo =
  footerLogoVariant && footerLogoVariant !== 'none'
    ? settings?.logos?.[footerLogoVariant]
    : null;
const footerLogoUrl = footerLogo
  ? urlForImage(footerLogo).width(800).url()
  : null;
---

<footer class="site-footer">
  <!-- Grain texture overlay -->
  <div class="footer-grain" aria-hidden="true"></div>

  <div class="container">
    {
      footerLogoUrl && (
        <div class="footer-logo" data-parallax-logo>
          <a href="/">
            <img
              src={footerLogoUrl}
              alt={settings?.title || 'Site Logo'}
              class="footer-logo-image"
              width="200"
              height="auto"
            />
          </a>
        </div>
      )
    }
    {
      footerLinks.length > 0 && (
        <nav class="footer-content" aria-label={t('aria.footer_navigation')}>
          <ul class="footer-links">
            {footerLinks.map((link: any) => {
              const href = resolveLinkUrl(link);
              const isExternal =
                link.openInNewTab || link.linkType === 'external';
              return (
                <li>
                  <a
                    href={href}
                    {...(isExternal && {
                      target: '_blank',
                      rel: 'noopener noreferrer',
                      'aria-label': `${link.text} (${t('aria.external_link')})`,
                    })}
                  >
                    {link.text}
                  </a>
                </li>
              );
            })}
          </ul>
        </nav>
      )
    }

    <section class="footer-credit">
      <p>
        <small>&copy; {currentYear}. {t('footer.all_rights_reserved')}</small>
      </p>
      <p>
        <small>
          {t('footer.developed_by')}
          <a
            href="https://fabapps.dev/"
            class="underline-animation"
            target="_blank"
            rel="noopener noreferrer"
            aria-label={`fabulous Apps (${t('aria.external_link')})`}
            >fabulous Apps</a
          >
          <span class="dot">.</span>
        </small>
      </p>
    </section>
  </div>
</footer>

<style>
  .site-footer {
    background-color: var(--color-primary);
    color: var(--color-text);
    padding-block-start: 10rem;
    padding-block-end: var(--space-sm);
    position: relative;
    overflow: hidden;
  }

  /* Grain texture overlay for premium feel */
  .footer-grain {
    position: absolute;
    inset: 0;
    pointer-events: none;
    opacity: 0.03;
    z-index: 1;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
    background-repeat: repeat;
    background-size: 200px 200px;
  }

  .footer-logo {
    margin-block-end: var(--space-xl);
    text-align: center;
    position: relative;
    z-index: 2;
    will-change: transform;
  }

  .footer-logo-image {
    display: inline-block;
    max-width: 100%;
    width: auto;
    height: auto;
  }

  .footer-content {
    margin-block-end: var(--space-lg);
    position: relative;
    z-index: 2;
  }

  .footer-credit {
    position: relative;
    z-index: 2;
  }

  .site-footer .container {
    position: relative;
    z-index: 2;
  }

  .footer-links {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
    list-style: none;
  }

  .footer-links a {
    color: var(--color-text);
    transition: opacity var(--transition-fast);
  }

  .footer-links a:hover {
    opacity: 0.8;
  }

  .footer-credit {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding-block-start: var(--space-xs);
    border-block-start: var(--border-width-thin) solid
      var(--color-border, rgba(0, 0, 0, 0.1));
    font-size: 0.625rem;
    color: var(--color-text-secondary, rgba(0, 0, 0, 0.6));
  }

  .footer-credit p {
    margin: 0;
    line-height: 1;
    position: relative;
  }

  .footer-credit a {
    color: inherit;
    font-weight: inherit;
    text-decoration: none;
    position: relative;
    display: inline-block;
  }

  .underline-animation::after {
    content: '';
    position: absolute;
    left: 0;
    bottom: 0;
    width: 0;
    height: 1px;
    background-color: currentColor;
    transition: width 0.3s ease-in-out;
  }

  .underline-animation:hover::after {
    width: 100%;
  }

  .dot {
    font-size: 1.52rem;
    color: #0000ff;
    line-height: 1;
    position: absolute;
    bottom: 0;
    margin-inline-start: -0.01rem;
    margin-block-end: -0.13rem;
  }

  .footer-credit p:last-child {
    padding-inline-end: 0.25rem;
  }

  @media (max-width: 768px) {
    .footer-content {
      flex-direction: column;
    }
  }
</style>

<script>
  import { setupAnimationLifecycle, gsap } from '@lib/animation';

  setupAnimationLifecycle(() => {
    const logo = document.querySelector('[data-parallax-logo]');
    if (!logo) return;

    // Parallax effect: logo moves slower than scroll, creating depth
    // Since footer is fixed, we track when the page-content reveals the footer
    const pageContent = document.querySelector('.page-content');
    if (!pageContent) return;

    gsap.fromTo(
      logo,
      { y: 40 },
      {
        y: -20,
        ease: 'none',
        scrollTrigger: {
          trigger: pageContent,
          start: 'bottom bottom',
          end: 'bottom top',
          scrub: 1,
        },
      }
    );
  });
</script>
