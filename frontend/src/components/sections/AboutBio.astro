---
import { urlForImageWithSeoFilename } from '@lib/sanity/image';
import { resolveColorSelection } from '@lib/sanity/colorResolver';
import { sanityClient as client } from 'sanity:client';
import { siteSettingsQuery } from '@lib/sanity/queries';

interface ImageAsset {
  _id: string;
  url: string;
  metadata?: {
    lqip?: string;
    dimensions?: {
      width: number;
      height: number;
      aspectRatio: number;
    };
  };
}

interface SanityImage {
  asset?: ImageAsset;
  alt?: string;
  seoFilename?: string;
  hotspot?: { x: number; y: number };
  crop?: { top: number; bottom: number; left: number; right: number };
}

interface ColorData {
  label?: string;
  value: string;
}

interface GradientColorData {
  colorType?: 'primary' | 'secondary' | 'accent' | 'custom';
  shade?: number;
  customColor?: ColorData;
}

interface GradientData {
  direction?: string;
  startColor?: GradientColorData;
  endColor?: GradientColorData;
}

interface Props {
  image?: SanityImage;
  label?: string;
  labelColorType?: 'primary' | 'secondary' | 'accent' | 'custom';
  labelColorShade?: number;
  labelCustomColor?: ColorData;
  name?: string;
  nameColorType?: 'primary' | 'secondary' | 'accent' | 'custom';
  nameColorShade?: number;
  nameCustomColor?: ColorData;
  description?: string;
  descriptionColor?: 'base' | 'muted' | 'contrast';
  backgroundColorType?:
    | 'default'
    | 'primary'
    | 'secondary'
    | 'accent'
    | 'custom';
  backgroundColorMode?: 'solid' | 'gradient';
  backgroundColorShade?: number;
  backgroundCustomColor?: ColorData;
  backgroundGradient?: GradientData;
}

const {
  image,
  label,
  labelColorType = 'accent',
  labelColorShade = 0,
  labelCustomColor,
  name,
  nameColorType = 'primary',
  nameColorShade = 0,
  nameCustomColor,
  description,
  descriptionColor = 'muted',
  backgroundColorType = 'default',
  backgroundColorMode = 'solid',
  backgroundColorShade = 95,
  backgroundCustomColor,
  backgroundGradient,
} = Astro.props;

// Fetch site settings for colors
const settings = await client.fetch(siteSettingsQuery);
const siteColors = settings?.colors;

// Resolve background color
const backgroundColor =
  backgroundColorType === 'default'
    ? null
    : backgroundColorMode === 'gradient' && backgroundGradient
      ? `linear-gradient(${backgroundGradient.direction || '135deg'}, ${resolveColorSelection(backgroundGradient.startColor, siteColors)}, ${resolveColorSelection(backgroundGradient.endColor, siteColors)})`
      : resolveColorSelection(
          {
            colorType: backgroundColorType,
            shade: backgroundColorShade,
            customColor: backgroundCustomColor,
          },
          siteColors
        );

// Resolve label color
const labelColor = resolveColorSelection(
  {
    colorType: labelColorType,
    shade: labelColorShade,
    customColor: labelCustomColor,
  },
  siteColors
);

// Resolve name color
const nameColor = resolveColorSelection(
  {
    colorType: nameColorType,
    shade: nameColorShade,
    customColor: nameCustomColor,
  },
  siteColors
);

// Text color mapping
const textColorMap = {
  base: 'var(--color-text)',
  muted: 'var(--color-text-muted)',
  contrast: 'rgba(255, 255, 255, 0.9)',
};

const cssVars = [
  backgroundColor ? `--bio-bg: ${backgroundColor}` : null,
  `--bio-label-color: ${labelColor}`,
  `--bio-name-color: ${nameColor}`,
  `--bio-text-color: ${textColorMap[descriptionColor]}`,
]
  .filter(Boolean)
  .join('; ');

// Generate image URL
const imageUrl = image?.asset
  ? urlForImageWithSeoFilename(
      image as {
        asset?: { _ref?: string };
        alt?: string;
        seoFilename?: string;
      },
      { width: 800, quality: 85 }
    )
  : null;

const imageLqip = image?.asset?.metadata?.lqip;
---

<section class="about-bio" style={cssVars}>
  <div class="container">
    <div class="about-bio__layout">
      {
        imageUrl && (
          <div class="about-bio__image-wrapper">
            <img
              src={imageUrl}
              alt={image?.alt || name || ''}
              class="about-bio__image"
              loading="lazy"
              decoding="async"
              style={
                imageLqip
                  ? `background-image: url(${imageLqip}); background-size: cover;`
                  : ''
              }
            />
          </div>
        )
      }
      <div class="about-bio__content">
        {label && <span class="about-bio__label">{label}</span>}
        {name && <h1 class="about-bio__name">{name}</h1>}
        {description && <p class="about-bio__description">{description}</p>}
      </div>
    </div>
  </div>
</section>

<style>
  .about-bio {
    padding-block: var(--space-2xl);
    background: var(--bio-bg, transparent);
  }

  .about-bio__layout {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-xl);
    align-items: center;
  }

  @media (min-width: 768px) {
    .about-bio__layout {
      grid-template-columns: 1fr 1fr;
      gap: var(--space-2xl);
    }
  }

  .about-bio__image-wrapper {
    position: relative;
    aspect-ratio: 4 / 5;
    overflow: hidden;
    background-color: var(--color-border, #e5e5e5);
    max-width: 450px;
    width: 100%;
    margin: 0 auto;
    clip-path: inset(10% round 1rem);
    transition: clip-path 0.8s cubic-bezier(0.16, 1, 0.3, 1);
  }

  .about-bio__image-wrapper.is-revealed {
    clip-path: inset(0% round 0.75rem);
  }

  .about-bio__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .about-bio__content {
    padding: var(--space-md) 0;
  }

  .about-bio__label {
    display: block;
    font-size: 0.875rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--bio-label-color, var(--color-accent));
    margin-bottom: var(--space-sm);
  }

  .about-bio__name {
    font-family: var(--font-heading);
    font-size: clamp(2rem, 5vw, 3rem);
    line-height: 1.1;
    color: var(--bio-name-color, var(--color-primary));
    margin: 0 0 1.5rem;
    font-weight: 500;
  }

  .about-bio__description {
    font-size: 1.25rem;
    color: var(--bio-text-color, var(--color-text-muted));
    line-height: 1.7;
    margin: 0;
  }
</style>

<script>
  import { setupAnimationLifecycle, gsap } from '@lib/animation/utils';
  import { ANIMATION_CONFIG } from '@lib/animation/config';

  setupAnimationLifecycle(() => {
    const section = document.querySelector('.about-bio');
    const imageWrapper = document.querySelector('.about-bio__image-wrapper');
    const image = document.querySelector('.about-bio__image');
    const label = document.querySelector('.about-bio__label');
    const name = document.querySelector('.about-bio__name');
    const description = document.querySelector('.about-bio__description');

    if (!section) return;

    // Initial states for content elements
    if (label) gsap.set(label, { opacity: 0, y: 20 });
    if (name) gsap.set(name, { opacity: 0, y: 30 });
    if (description) gsap.set(description, { opacity: 0, y: 25 });
    if (image) gsap.set(image, { scale: 1.1 });

    // Image reveal with clip-path animation
    if (imageWrapper) {
      gsap.to(imageWrapper, {
        scrollTrigger: {
          trigger: imageWrapper,
          start: 'top 75%',
          once: true,
          markers: ANIMATION_CONFIG.scrollTrigger.markers,
          onEnter: () => imageWrapper.classList.add('is-revealed'),
        },
      });

      // Ken Burns effect on image
      if (image) {
        gsap.to(image, {
          scale: 1,
          duration: 1.2,
          ease: 'power2.out',
          scrollTrigger: {
            trigger: imageWrapper,
            start: 'top 75%',
            once: true,
            markers: ANIMATION_CONFIG.scrollTrigger.markers,
          },
        });
      }
    }

    // Create content timeline
    const contentTl = gsap.timeline({
      scrollTrigger: {
        trigger: '.about-bio__content',
        start: 'top 80%',
        once: true,
        markers: ANIMATION_CONFIG.scrollTrigger.markers,
      },
    });

    // Label fades in first
    if (label) {
      contentTl.to(label, {
        opacity: 1,
        y: 0,
        duration: 0.5,
        ease: 'power2.out',
      });
    }

    // Name follows
    if (name) {
      contentTl.to(
        name,
        {
          opacity: 1,
          y: 0,
          duration: 0.6,
          ease: 'power3.out',
        },
        '-=0.2'
      );
    }

    // Description
    if (description) {
      contentTl.to(
        description,
        {
          opacity: 1,
          y: 0,
          duration: 0.5,
          ease: 'power2.out',
        },
        '-=0.3'
      );
    }
  });
</script>
