---
import { resolveColorSelection } from '@lib/sanity/colorResolver';
import { sanityClient as client } from 'sanity:client';
import { siteSettingsQuery } from '@lib/sanity/queries';
import Image from '@components/media/Image.astro';
import PortableText from '@components/sanity/PortableText.astro';
import type { PortableTextBlock } from '@portabletext/types';

interface ColorData {
  label?: string;
  value: string;
}

interface IconImageData {
  asset?: { _id: string; url?: string };
  alt?: string;
  hotspot?: { x: number; y: number };
  crop?: { top: number; bottom: number; left: number; right: number };
}

interface CaseStudyRef {
  _id: string;
  client?: string;
}

interface Props {
  tag?: string;
  title: string;
  leadText?: string;
  description?: PortableTextBlock[];
  iconType?: 'svg' | 'image' | 'none';
  icon?: string;
  iconImage?: IconImageData;
  imagePosition?: 'left' | 'right';
  // Color settings
  backgroundColorType?:
    | 'default'
    | 'primary'
    | 'secondary'
    | 'accent'
    | 'custom';
  backgroundColorShade?: number;
  backgroundCustomColor?: ColorData;
  titleColorType?: 'primary' | 'secondary' | 'accent' | 'custom';
  titleColorShade?: number;
  titleCustomColor?: ColorData;
  tagColor?: 'primary' | 'secondary' | 'accent';
  leadTextColor?: 'base' | 'muted' | 'contrast';
  descriptionTextColor?: 'base' | 'muted' | 'contrast';
  iconColorType?: 'primary' | 'secondary' | 'accent' | 'custom';
  iconColorShade?: number;
  iconCustomColor?: ColorData;
  iconContainerColorType?:
    | 'default'
    | 'primary'
    | 'secondary'
    | 'accent'
    | 'custom';
  iconContainerColorShade?: number;
  iconContainerCustomColor?: ColorData;
  // List settings
  listStyle?: 'checkmark' | 'arrow' | 'bullet';
  listTitle?: string;
  listItems?: string[];
  listTextColor?: 'base' | 'muted' | 'contrast';
  listContainerColorType?:
    | 'default'
    | 'primary'
    | 'secondary'
    | 'accent'
    | 'custom';
  listContainerColorShade?: number;
  listContainerCustomColor?: ColorData;
  listIconColorType?: 'primary' | 'secondary' | 'accent' | 'custom';
  listIconColorShade?: number;
  listIconCustomColor?: ColorData;
  // Case Studies Section
  caseStudiesSectionTitle?: string;
  caseStudiesTitleColorType?: 'primary' | 'secondary' | 'accent' | 'custom';
  caseStudiesTitleColorShade?: number;
  caseStudiesTitleCustomColor?: ColorData;
  caseStudiesPillBgColorType?:
    | 'default'
    | 'primary'
    | 'secondary'
    | 'accent'
    | 'custom';
  caseStudiesPillBgColorShade?: number;
  caseStudiesPillBgCustomColor?: ColorData;
  caseStudiesPillTextColor?: 'base' | 'muted' | 'contrast';
  featuredCaseStudies?: CaseStudyRef[];
}

const {
  tag,
  title,
  leadText,
  description,
  iconType = 'svg',
  icon = 'settings',
  iconImage,
  imagePosition = 'left',
  // Color settings
  backgroundColorType = 'default',
  backgroundColorShade = 0,
  backgroundCustomColor,
  titleColorType = 'accent',
  titleColorShade = 0,
  titleCustomColor,
  tagColor = 'accent',
  leadTextColor = 'base',
  descriptionTextColor = 'muted',
  iconColorType = 'accent',
  iconColorShade = 0,
  iconCustomColor,
  iconContainerColorType = 'default',
  iconContainerColorShade = 0,
  iconContainerCustomColor,
  // List settings
  listStyle = 'checkmark',
  listTitle,
  listItems = [],
  listTextColor = 'base',
  listContainerColorType = 'default',
  listContainerColorShade = 0,
  listContainerCustomColor,
  listIconColorType = 'accent',
  listIconColorShade = 0,
  listIconCustomColor,
  // Case Studies Section
  caseStudiesSectionTitle,
  caseStudiesTitleColorType = 'accent',
  caseStudiesTitleColorShade = 0,
  caseStudiesTitleCustomColor,
  caseStudiesPillBgColorType = 'default',
  caseStudiesPillBgColorShade = 0,
  caseStudiesPillBgCustomColor,
  caseStudiesPillTextColor = 'base',
  featuredCaseStudies = [],
} = Astro.props;

// Fetch site settings for colors
const settings = await client.fetch(siteSettingsQuery);
const siteColors = settings?.colors;

// Resolve colors (null if default)
const backgroundColor =
  backgroundColorType === 'default' || !backgroundColorType
    ? null
    : resolveColorSelection(
        {
          colorType: backgroundColorType,
          shade: backgroundColorShade,
          customColor: backgroundCustomColor,
        },
        siteColors
      );

const titleColor = resolveColorSelection(
  {
    colorType: titleColorType,
    shade: titleColorShade,
    customColor: titleCustomColor,
  },
  siteColors
);

const resolvedTagColor = resolveColorSelection(
  { colorType: tagColor, shade: 0 },
  siteColors
);

const iconColor = resolveColorSelection(
  {
    colorType: iconColorType,
    shade: iconColorShade,
    customColor: iconCustomColor,
  },
  siteColors
);

const iconContainerColor =
  iconContainerColorType === 'default' || !iconContainerColorType
    ? null
    : resolveColorSelection(
        {
          colorType: iconContainerColorType,
          shade: iconContainerColorShade,
          customColor: iconContainerCustomColor,
        },
        siteColors
      );

const listContainerColor =
  listContainerColorType === 'default' || !listContainerColorType
    ? null
    : resolveColorSelection(
        {
          colorType: listContainerColorType,
          shade: listContainerColorShade,
          customColor: listContainerCustomColor,
        },
        siteColors
      );

const listIconColor = resolveColorSelection(
  {
    colorType: listIconColorType,
    shade: listIconColorShade,
    customColor: listIconCustomColor,
  },
  siteColors
);

// Text color map
const textColorMap: Record<string, string> = {
  base: 'var(--color-text)',
  muted: 'var(--color-text-muted)',
  contrast: 'var(--color-text-contrast)',
};

const resolvedLeadTextColor = textColorMap[leadTextColor] || textColorMap.base;
const resolvedDescriptionTextColor =
  textColorMap[descriptionTextColor] || textColorMap.muted;
const resolvedListTextColor = textColorMap[listTextColor] || textColorMap.base;
const resolvedCaseStudiesPillTextColor =
  textColorMap[caseStudiesPillTextColor] || textColorMap.base;

// Resolve case studies title color
const caseStudiesTitleColor = resolveColorSelection(
  {
    colorType: caseStudiesTitleColorType,
    shade: caseStudiesTitleColorShade,
    customColor: caseStudiesTitleCustomColor,
  },
  siteColors
);

// Resolve case studies pill background color
const caseStudiesPillBgColor =
  caseStudiesPillBgColorType === 'default' || !caseStudiesPillBgColorType
    ? null
    : resolveColorSelection(
        {
          colorType: caseStudiesPillBgColorType,
          shade: caseStudiesPillBgColorShade,
          customColor: caseStudiesPillBgCustomColor,
        },
        siteColors
      );

// Build CSS variables (only include non-null values)
const cssVarParts: string[] = [];
if (backgroundColor) cssVarParts.push(`--service-bg: ${backgroundColor}`);
cssVarParts.push(`--service-title: ${titleColor}`);
cssVarParts.push(`--service-tag: ${resolvedTagColor}`);
cssVarParts.push(`--service-lead: ${resolvedLeadTextColor}`);
cssVarParts.push(`--service-description: ${resolvedDescriptionTextColor}`);
cssVarParts.push(`--service-icon: ${iconColor}`);
if (iconContainerColor)
  cssVarParts.push(`--service-icon-container: ${iconContainerColor}`);
if (listContainerColor)
  cssVarParts.push(`--service-list-container: ${listContainerColor}`);
cssVarParts.push(`--service-list-icon: ${listIconColor}`);
cssVarParts.push(`--service-list-text: ${resolvedListTextColor}`);
cssVarParts.push(`--service-case-studies-title: ${caseStudiesTitleColor}`);
if (caseStudiesPillBgColor)
  cssVarParts.push(`--service-case-studies-pill-bg: ${caseStudiesPillBgColor}`);
cssVarParts.push(
  `--service-case-studies-pill-text: ${resolvedCaseStudiesPillTextColor}`
);
const cssVars = cssVarParts.join('; ');

// Icon SVG paths
const iconPaths: Record<string, string> = {
  settings:
    '<circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>',
  target:
    '<circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle>',
  users:
    '<path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path>',
  chart:
    '<line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line>',
  lightbulb:
    '<line x1="9" y1="18" x2="15" y2="18"></line><line x1="10" y1="22" x2="14" y2="22"></line><path d="M15.09 14c.18-.98.65-1.74 1.41-2.5A4.65 4.65 0 0 0 18 8a6 6 0 1 0-12 0c0 1.54.64 2.89 1.68 3.86.63.61 1 1.25 1 2.14V14a2 2 0 0 0 2 2h2.82a2 2 0 0 0 2-2z"></path>',
  handshake:
    '<path d="M11 17a4 4 0 0 1-4-4V5a2 2 0 0 1 2-2h2"></path><path d="M13 3h2a2 2 0 0 1 2 2v8a4 4 0 0 1-4 4"></path><path d="m3 15 4-4"></path><path d="m17 11 4 4"></path><path d="M12 17v4"></path><path d="M8 21h8"></path>',
  compass:
    '<circle cx="12" cy="12" r="10"></circle><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"></polygon>',
  calendar:
    '<rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>',
  presentation:
    '<path d="M2 3h20"></path><path d="M21 3v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V3"></path><path d="m7 21 5-5 5 5"></path>',
};

const gridClasses = [
  'service-section__grid',
  imagePosition === 'right' ? 'service-section__grid--reversed' : '',
]
  .filter(Boolean)
  .join(' ');
---

<article
  class="service-section"
  style={cssVars}
  data-animate
  data-reversed={imagePosition === 'right'}
  data-no-image={iconType === 'none'}
>
  <div class="container">
    {
      iconType === 'none' ? (
        <>
          {/* No-image layout: content column | list column */}
          <div class="service-section__grid service-section__grid--no-image">
            <div class="service-section__content-column">
              {tag && <span class="service-section__tag">{tag}</span>}
              <h2 class="service-section__title">{title}</h2>
              {leadText && <p class="service-section__lead">{leadText}</p>}
              {description && description.length > 0 && (
                <div class="service-section__description">
                  <PortableText content={description} />
                </div>
              )}
            </div>
            <div class="service-section__list-column">
              {listItems.length > 0 && (
                <div
                  class={`service-section__list-wrapper ${listTitle || listContainerColor ? 'service-section__list-wrapper--boxed' : ''}`}
                >
                  {listTitle && (
                    <strong class="service-section__list-title">
                      {listTitle}
                    </strong>
                  )}
                  <ul
                    class={`service-section__list service-section__list--${listStyle}`}
                  >
                    {listItems.map((item) => (
                      <li>
                        {listStyle === 'checkmark' && (
                          <svg
                            class="service-section__list-icon"
                            viewBox="0 0 24 24"
                          >
                            <polyline points="20 6 9 17 4 12" />
                          </svg>
                        )}
                        {listStyle === 'arrow' && (
                          <span class="service-section__list-arrow">
                            &rarr;
                          </span>
                        )}
                        {listStyle === 'bullet' && (
                          <span class="service-section__list-bullet">
                            &bull;
                          </span>
                        )}
                        {item}
                      </li>
                    ))}
                  </ul>
                </div>
              )}
            </div>
          </div>
          {/* Case studies below for no-image layout */}
          {featuredCaseStudies && featuredCaseStudies.length > 0 && (
            <div class="service-section__case-studies service-section__case-studies--below">
              {caseStudiesSectionTitle && (
                <p class="service-section__case-studies-title">
                  {caseStudiesSectionTitle}
                </p>
              )}
              <div class="service-section__case-studies-list">
                {featuredCaseStudies.map((caseStudy) => (
                  <a
                    href={`/case-studies#${caseStudy._id}`}
                    class="service-section__case-study-pill"
                  >
                    {caseStudy.client || 'Untitled'}
                  </a>
                ))}
              </div>
            </div>
          )}
        </>
      ) : (
        /* Standard layout with image/icon */
        <div class={gridClasses}>
          <div class="service-section__media-column">
            <div class="service-section__image-container">
              {iconType === 'image' && iconImage?.asset ? (
                <Image
                  image={iconImage}
                  alt={iconImage.alt || title}
                  class="service-section__image"
                  sizes="(max-width: 768px) 100vw, 50vw"
                />
              ) : (
                <svg
                  class="service-section__icon"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  aria-hidden="true"
                  set:html={iconPaths[icon] || iconPaths.settings}
                />
              )}
            </div>

            {featuredCaseStudies && featuredCaseStudies.length > 0 && (
              <div class="service-section__case-studies">
                {caseStudiesSectionTitle && (
                  <p class="service-section__case-studies-title">
                    {caseStudiesSectionTitle}
                  </p>
                )}
                <div class="service-section__case-studies-list">
                  {featuredCaseStudies.map((caseStudy) => (
                    <a
                      href={`/case-studies#${caseStudy._id}`}
                      class="service-section__case-study-pill"
                    >
                      {caseStudy.client || 'Untitled'}
                    </a>
                  ))}
                </div>
              </div>
            )}
          </div>
          <div class="service-section__content">
            {tag && <span class="service-section__tag">{tag}</span>}
            <h2 class="service-section__title">{title}</h2>
            {leadText && <p class="service-section__lead">{leadText}</p>}
            {description && description.length > 0 && (
              <div class="service-section__description">
                <PortableText content={description} />
              </div>
            )}

            {listItems.length > 0 && (
              <div
                class={`service-section__list-wrapper ${listTitle || listContainerColor ? 'service-section__list-wrapper--boxed' : ''}`}
              >
                {listTitle && (
                  <strong class="service-section__list-title">
                    {listTitle}
                  </strong>
                )}
                <ul
                  class={`service-section__list service-section__list--${listStyle}`}
                >
                  {listItems.map((item) => (
                    <li>
                      {listStyle === 'checkmark' && (
                        <svg
                          class="service-section__list-icon"
                          viewBox="0 0 24 24"
                        >
                          <polyline points="20 6 9 17 4 12" />
                        </svg>
                      )}
                      {listStyle === 'arrow' && (
                        <span class="service-section__list-arrow">&rarr;</span>
                      )}
                      {listStyle === 'bullet' && (
                        <span class="service-section__list-bullet">&bull;</span>
                      )}
                      {item}
                    </li>
                  ))}
                </ul>
              </div>
            )}
          </div>
        </div>
      )
    }
  </div>
</article>

<style>
  .service-section {
    padding-block: clamp(6rem, 10vw, 8rem);
    background-color: var(--service-bg, var(--color-background));
  }

  .service-section__grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-xl);
    align-items: start;
  }

  @media (min-width: 768px) {
    .service-section__grid {
      grid-template-columns: 1fr 1fr;
      gap: var(--space-2xl);
    }

    .service-section__grid--reversed {
      direction: rtl;
    }

    .service-section__grid--reversed > * {
      direction: ltr;
    }
  }

  /* No-image layout */
  .service-section__grid--no-image {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-xl);
    align-items: start;
  }

  @media (min-width: 768px) {
    .service-section__grid--no-image {
      grid-template-columns: 1fr 1fr;
      gap: var(--space-2xl);
    }
  }

  .service-section__content-column {
    /* Inherits text styling from parent */
  }

  .service-section__list-column {
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  /* Case studies when below content (no-image mode) */
  .service-section__case-studies--below {
    margin-top: var(--space-xl);
  }

  .service-section__media-column {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
    justify-content: center;
    height: 100%;
  }

  .service-section__media-column:has(.service-section__case-studies) {
    justify-content: space-between;
  }

  .service-section__image-container {
    display: flex;
    align-items: center;
    justify-content: center;
    aspect-ratio: 1;
    max-height: 27.375rem;
    background-color: var(--service-icon-container, var(--color-background));
    border: 1px solid var(--color-border, #e5e5e5);
    border-radius: 0.75rem;
  }

  .service-section__icon {
    width: 80px;
    height: 80px;
    color: var(--service-icon, var(--color-accent));
    opacity: 0.6;
  }

  .service-section__image-container:has(.service-section__image) {
    aspect-ratio: auto;
    background-color: transparent;
    border: none;
    overflow: hidden;
  }

  .service-section__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 0.75rem;
  }

  .service-section__content {
  }

  .service-section__tag {
    display: inline-block;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--service-tag, var(--color-accent));
    margin-bottom: var(--space-sm);
  }

  .service-section__title {
    font-family: var(--font-heading);
    font-size: clamp(1.75rem, 4vw, 2.5rem);
    font-weight: 500;
    line-height: 1.2;
    color: var(--service-title, var(--color-accent));
    margin: 0 0 var(--space-md);
  }

  .service-section__lead {
    font-size: var(--font-size-lg);
    color: var(--service-lead, var(--color-text));
    line-height: 1.6;
    margin: 0 0 var(--space-sm);
    font-weight: 500;
  }

  .service-section__description {
    font-size: var(--font-size-base);
    color: var(--service-description, var(--color-text-muted));
    line-height: 1.7;
    margin: 0 0 var(--space-lg);
  }

  .service-section__description :global(.portable-text) {
    color: inherit;
    line-height: inherit;
  }

  .service-section__description :global(.portable-text p) {
    color: inherit;
  }

  /* List wrapper */
  .service-section__list-wrapper {
  }

  .service-section__list-wrapper--boxed {
    background-color: var(
      --service-list-container,
      color-mix(in srgb, var(--color-surface) 50%, transparent)
    );
    padding: var(--space-md);
    border-radius: 0.75rem;
  }

  .service-section__list-title {
    display: block;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--service-list-text, var(--color-text));
    margin-bottom: var(--space-sm);
  }

  /* Lists */
  .service-section__list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .service-section__list li {
    display: flex;
    align-items: flex-start;
    gap: var(--space-sm);
    padding: var(--space-xs) 0;
    color: var(--service-list-text, var(--color-text));
    line-height: 1.5;
  }

  .service-section__list-icon {
    flex-shrink: 0;
    width: 1.25rem;
    height: 1.25rem;
    color: var(--service-list-icon, var(--color-accent));
    stroke-width: 2;
    fill: none;
    stroke: currentColor;
  }

  .service-section__list-arrow,
  .service-section__list-bullet {
    flex-shrink: 0;
    color: var(--service-list-icon, var(--color-accent));
    font-weight: 600;
    line-height: 1.5;
  }

  .service-section__list-arrow {
    font-size: 1rem;
  }

  .service-section__list-bullet {
    font-size: 1.25rem;
    margin-top: -2px;
  }

  /* Case Studies Section */
  .service-section__case-studies {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
  }

  .service-section__case-studies-title {
    font-size: var(--font-size-lg);
    font-weight: 700;
    color: var(--service-case-studies-title, var(--color-accent));
    margin: 0;
  }

  .service-section__case-studies-list {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-sm);
  }

  .service-section__case-study-pill {
    display: inline-flex;
    align-items: center;
    padding: 0.5rem 1.25rem;
    border-radius: 9999px;
    font-size: var(--font-size-sm);
    font-weight: 700;
    color: var(--service-case-studies-pill-text, var(--color-text));
    background-color: var(--service-case-studies-pill-bg, transparent);
    text-decoration: none;
    transition: background-color 0.2s ease;
  }

  /* Animation-ready states - simplified to main blocks */
  .service-section[data-animate] .service-section__media-column,
  .service-section[data-animate] .service-section__content,
  .service-section[data-animate] .service-section__content-column,
  .service-section[data-animate] .service-section__list-column,
  .service-section[data-animate] .service-section__case-studies--below {
    opacity: 0;
  }

  /* Word reveal clip container */
  .service-section__title :global(.editorial-word-wrapper) {
    display: inline-block;
    overflow: hidden;
    vertical-align: top;
    padding-bottom: 0.1em;
  }

  /* Reduced motion: show all immediately */
  @media (prefers-reduced-motion: reduce) {
    .service-section[data-animate] .service-section__media-column,
    .service-section[data-animate] .service-section__content,
    .service-section[data-animate] .service-section__content-column,
    .service-section[data-animate] .service-section__list-column,
    .service-section[data-animate] .service-section__case-studies--below {
      opacity: 1 !important;
      transform: none !important;
    }
  }
</style>

<script>
  import {
    setupAnimationLifecycle,
    gsap,
    SplitText,
  } from '@lib/animation/utils';
  import { ANIMATION_CONFIG } from '@lib/animation/config';
  import { createMagneticRepulsion } from '@lib/animation';

  setupAnimationLifecycle(() => {
    // Check for reduced motion preference
    const prefersReducedMotion = window.matchMedia(
      '(prefers-reduced-motion: reduce)'
    ).matches;

    const sections = document.querySelectorAll(
      '.service-section[data-animate]'
    );

    sections.forEach((section) => {
      // If reduced motion, show everything immediately
      if (prefersReducedMotion) {
        gsap.set(section.querySelectorAll('[class*="service-section__"]'), {
          opacity: 1,
          transform: 'none',
        });
        return;
      }

      // Check if this is a no-image layout
      const isNoImage = section.getAttribute('data-no-image') === 'true';

      // Get main elements based on layout type
      let columnsToAnimate: Element[] = [];

      if (isNoImage) {
        const contentColumn = section.querySelector(
          '.service-section__content-column'
        );
        const listColumn = section.querySelector(
          '.service-section__list-column'
        );
        const caseStudiesBelow = section.querySelector(
          '.service-section__case-studies--below'
        );
        columnsToAnimate = [contentColumn, listColumn, caseStudiesBelow].filter(
          Boolean
        ) as Element[];
      } else {
        const mediaColumn = section.querySelector(
          '.service-section__media-column'
        );
        const content = section.querySelector('.service-section__content');
        columnsToAnimate = [mediaColumn, content].filter(Boolean) as Element[];
      }

      const title = section.querySelector('.service-section__title');

      // Set initial states for columns
      columnsToAnimate.forEach((col) => {
        gsap.set(col, { opacity: 0, y: 20 });
      });

      // Split title into words for subtle editorial reveal
      let titleWords: HTMLElement[] = [];
      if (title) {
        const titleSplit = new SplitText(title, { type: 'words' });
        titleWords = titleSplit.words as HTMLElement[];

        // Wrap each word for clip overflow
        titleWords.forEach((word) => {
          const wrapper = document.createElement('span');
          wrapper.style.display = 'inline-block';
          wrapper.style.overflow = 'hidden';
          wrapper.style.verticalAlign = 'top';
          wrapper.style.paddingBottom = '0.1em';
          wrapper.classList.add('editorial-word-wrapper');

          word.parentNode?.insertBefore(wrapper, word);
          wrapper.appendChild(word);

          // Set initial state - subtle movement
          gsap.set(word, { y: '50%', opacity: 0 });
        });
      }

      // Create simple timeline
      const tl = gsap.timeline({
        scrollTrigger: {
          trigger: section,
          start: ANIMATION_CONFIG.triggers.editorialStyle.start,
          once: true,
          markers: ANIMATION_CONFIG.scrollTrigger.markers,
        },
      });

      // All columns fade in together - clean and simple
      tl.to(columnsToAnimate, {
        opacity: 1,
        y: 0,
        duration: 0.7,
        ease: 'power2.out',
      });

      // Title words reveal - quick, subtle stagger that runs alongside
      if (titleWords.length > 0) {
        tl.to(
          titleWords,
          {
            y: 0,
            opacity: 1,
            duration: 0.5,
            stagger: 0.02,
            ease: 'power2.out',
          },
          0.1 // Start shortly after the fade begins
        );
      }
    });

    // Magnetic repulsion effect for case study pills
    createMagneticRepulsion('.service-section__case-study-pill');
  });
</script>
