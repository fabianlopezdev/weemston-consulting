---
import { resolveColorSelection } from '@lib/sanity/colorResolver';
import { sanityClient as client } from 'sanity:client';
import { siteSettingsQuery } from '@lib/sanity/queries';
import { urlForImage } from '@lib/sanity/image';
import { slugify } from '@lib/utils/url';
import Image from '@components/media/Image.astro';
import PortableText from '@components/sanity/PortableText.astro';
import type { PortableTextBlock } from '@portabletext/types';

interface ColorData {
  label?: string;
  value: string;
}

interface IconImageData {
  asset?: { _id: string; url?: string };
  alt?: string;
  hotspot?: { x: number; y: number };
  crop?: { top: number; bottom: number; left: number; right: number };
}

interface ClientLogoImageData {
  asset?: {
    _id: string;
    url?: string;
    metadata?: {
      dimensions?: {
        width: number;
        height: number;
        aspectRatio: number;
      };
    };
  };
  alt?: string;
  hotspot?: { x: number; y: number };
  crop?: { top: number; bottom: number; left: number; right: number };
}

interface CaseStudyRef {
  _id: string;
  client?: string;
  logoVariant?: 'dark' | 'light';
  clientLogo?: ClientLogoImageData;
}

interface GradientColorData {
  colorType?: 'primary' | 'secondary' | 'accent' | 'custom';
  shade?: number;
  customColor?: ColorData;
}

interface GradientData {
  direction?: string;
  startColor?: GradientColorData;
  endColor?: GradientColorData;
}

interface Props {
  title: string;
  description?: PortableTextBlock[];
  iconType?: 'image' | 'none';
  iconImage?: IconImageData;
  imagePosition?: 'left' | 'right';
  subtitle?: string;
  subtitleColor?: 'base' | 'muted' | 'contrast';
  // Service index for catalogue numbering (01, 02, 03...)
  serviceIndex?: number;
  // Color settings
  backgroundColorType?:
    | 'default'
    | 'primary'
    | 'secondary'
    | 'accent'
    | 'custom';
  backgroundColorMode?: 'solid' | 'gradient';
  backgroundColorShade?: number;
  backgroundCustomColor?: ColorData;
  backgroundGradient?: GradientData;
  titleColorType?: 'primary' | 'secondary' | 'accent' | 'custom';
  titleColorShade?: number;
  titleCustomColor?: ColorData;
  descriptionTextColor?: 'base' | 'muted' | 'contrast';
  // Decorative colors
  decorativeNumberColorType?:
    | 'default'
    | 'primary'
    | 'secondary'
    | 'accent'
    | 'custom';
  decorativeNumberColorShade?: number;
  decorativeNumberCustomColor?: ColorData;
  decorativeNumberHoverColorType?:
    | 'default'
    | 'primary'
    | 'secondary'
    | 'accent'
    | 'custom';
  decorativeNumberHoverColorShade?: number;
  decorativeNumberHoverCustomColor?: ColorData;
  dividerColorType?: 'default' | 'primary' | 'secondary' | 'accent' | 'custom';
  dividerColorShade?: number;
  dividerCustomColor?: ColorData;
  // List settings
  listTitle?: string;
  listItems?: string[];
  listTextColor?: 'base' | 'muted' | 'contrast';
  // Case Studies Section
  caseStudiesSectionTitle?: string;
  caseStudiesTitleColorType?: 'primary' | 'secondary' | 'accent' | 'custom';
  caseStudiesTitleColorShade?: number;
  caseStudiesTitleCustomColor?: ColorData;
  logoDisplayMode?: 'base' | 'contrast';
  featuredCaseStudies?: CaseStudyRef[];
}

const {
  title,
  description,
  iconType = 'none',
  iconImage,
  imagePosition = 'left',
  subtitle,
  subtitleColor = 'base',
  serviceIndex = 0,
  // Color settings
  backgroundColorType = 'default',
  backgroundColorMode = 'solid',
  backgroundColorShade = 0,
  backgroundCustomColor,
  backgroundGradient,
  titleColorType = 'accent',
  titleColorShade = 0,
  titleCustomColor,
  descriptionTextColor = 'muted',
  // Decorative colors
  decorativeNumberColorType = 'default',
  decorativeNumberColorShade = 0,
  decorativeNumberCustomColor,
  decorativeNumberHoverColorType = 'default',
  decorativeNumberHoverColorShade = 0,
  decorativeNumberHoverCustomColor,
  dividerColorType = 'default',
  dividerColorShade = 0,
  dividerCustomColor,
  // List settings
  listTitle,
  listItems = [],
  listTextColor = 'base',
  // Case Studies Section
  caseStudiesSectionTitle,
  caseStudiesTitleColorType = 'accent',
  caseStudiesTitleColorShade = 0,
  caseStudiesTitleCustomColor,
  logoDisplayMode = 'base',
  featuredCaseStudies = [],
} = Astro.props;

// Filter case studies to only include those with logos
const caseStudiesWithLogos = featuredCaseStudies.filter(
  (cs) => cs.clientLogo?.asset
);

// Fetch site settings for colors
const settings = await client.fetch(siteSettingsQuery);
const siteColors = settings?.colors;

// Resolve colors (null if default)
const backgroundColor =
  backgroundColorType === 'default' || !backgroundColorType
    ? null
    : backgroundColorMode === 'gradient' && backgroundGradient
      ? `linear-gradient(${backgroundGradient.direction || '135deg'}, ${resolveColorSelection(backgroundGradient.startColor, siteColors)}, ${resolveColorSelection(backgroundGradient.endColor, siteColors)})`
      : resolveColorSelection(
          {
            colorType: backgroundColorType,
            shade: backgroundColorShade,
            customColor: backgroundCustomColor,
          },
          siteColors
        );

const titleColor = resolveColorSelection(
  {
    colorType: titleColorType,
    shade: titleColorShade,
    customColor: titleCustomColor,
  },
  siteColors
);

// Text color map
const textColorMap: Record<string, string> = {
  base: 'var(--color-text)',
  muted: 'var(--color-text-muted)',
  contrast: 'var(--color-text-contrast)',
};

const resolvedSubtitleColor = textColorMap[subtitleColor] || textColorMap.base;
const resolvedDescriptionTextColor =
  textColorMap[descriptionTextColor] || textColorMap.muted;
const resolvedListTextColor = textColorMap[listTextColor] || textColorMap.base;

// Resolve case studies title color
const caseStudiesTitleColor = resolveColorSelection(
  {
    colorType: caseStudiesTitleColorType,
    shade: caseStudiesTitleColorShade,
    customColor: caseStudiesTitleCustomColor,
  },
  siteColors
);

// Resolve decorative colors (null if default to use CSS fallbacks)
const decorativeNumberColor =
  decorativeNumberColorType === 'default' || !decorativeNumberColorType
    ? null
    : resolveColorSelection(
        {
          colorType: decorativeNumberColorType,
          shade: decorativeNumberColorShade,
          customColor: decorativeNumberCustomColor,
        },
        siteColors
      );

const decorativeNumberHoverColor =
  decorativeNumberHoverColorType === 'default' ||
  !decorativeNumberHoverColorType
    ? null
    : resolveColorSelection(
        {
          colorType: decorativeNumberHoverColorType,
          shade: decorativeNumberHoverColorShade,
          customColor: decorativeNumberHoverCustomColor,
        },
        siteColors
      );

const dividerColor =
  dividerColorType === 'default' || !dividerColorType
    ? null
    : resolveColorSelection(
        {
          colorType: dividerColorType,
          shade: dividerColorShade,
          customColor: dividerCustomColor,
        },
        siteColors
      );

// Helper to calculate CSS filters for a logo based on display mode and variant
// Returns both default and hover filters
function getLogoFilters(variant: 'dark' | 'light' | undefined): {
  filter: string;
  hoverFilter: string;
} {
  const isLight = variant === 'light';
  const isContrastMode = logoDisplayMode === 'contrast';

  // Logic table:
  // Dark logo + Base mode = grayscale (stays dark) → hover shows original
  // Dark logo + Contrast mode = invert (becomes light) → hover keeps invert (dark on dark = invisible)
  // Light logo + Base mode = invert (becomes dark) → hover keeps invert (light on light = invisible)
  // Light logo + Contrast mode = grayscale (stays light) → hover shows original
  const needsInvert = isContrastMode ? !isLight : isLight;

  // On hover, keep invert if removing it would make logo invisible
  // (i.e., light logos on light backgrounds or dark logos on dark backgrounds)
  const keepInvertOnHover = needsInvert;

  return {
    filter: needsInvert
      ? 'invert(1) grayscale(1) opacity(0.8)'
      : 'grayscale(1) opacity(0.7)',
    hoverFilter: keepInvertOnHover ? 'invert(1)' : 'none',
  };
}

// Build CSS variables (only include non-null values)
const cssVarParts: string[] = [];
if (backgroundColor) cssVarParts.push(`--service-bg: ${backgroundColor}`);
cssVarParts.push(`--service-title: ${titleColor}`);
cssVarParts.push(`--service-subtitle: ${resolvedSubtitleColor}`);
cssVarParts.push(`--service-description: ${resolvedDescriptionTextColor}`);
cssVarParts.push(`--service-list-text: ${resolvedListTextColor}`);
cssVarParts.push(`--service-case-studies-title: ${caseStudiesTitleColor}`);
// Decorative colors (only if not default)
if (decorativeNumberColor)
  cssVarParts.push(`--service-number-color: ${decorativeNumberColor}`);
if (decorativeNumberHoverColor)
  cssVarParts.push(
    `--service-number-hover-color: ${decorativeNumberHoverColor}`
  );
if (dividerColor) cssVarParts.push(`--service-divider-color: ${dividerColor}`);
const cssVars = cssVarParts.join('; ');

// Format service number for catalogue display (01, 02, 03...)
const serviceNumber = String(serviceIndex + 1).padStart(2, '0');
---

<article
  class="service-section"
  style={cssVars}
  data-animate
  data-reversed={imagePosition === 'right'}
  data-no-image={iconType === 'none'}
>
  <div class="container">
    {
      iconType === 'none' ? (
        <>
          {/* Label Row - same as with-image layout */}
          <div class="service-section__label-row">
            <span class="service-section__label-text">Service</span>
            <span class="service-section__label-number">{serviceNumber}</span>
            <div class="service-section__label-line" />
          </div>

          {/* Single text column - same structure as with-image, just full width */}
          <div class="service-section__text-column service-section__text-column--full">
            <h2 class="service-section__title service-section__title--serif">
              {title}
            </h2>
            {subtitle && <p class="service-section__subtitle">{subtitle}</p>}
            {description && description.length > 0 && (
              <div class="service-section__description">
                <PortableText content={description} />
              </div>
            )}

            {/* List - same as with-image */}
            {listItems.length > 0 && (
              <div class="service-section__list-wrapper">
                {listTitle && (
                  <strong class="service-section__list-title">
                    {listTitle}
                  </strong>
                )}
                <ul class="service-section__list service-section__list--numbered">
                  {listItems.map((item, idx) => (
                    <li class="service-section__list-item">
                      <span class="service-section__list-number">
                        {idx + 1}.
                      </span>
                      <span class="service-section__list-text">{item}</span>
                    </li>
                  ))}
                </ul>
              </div>
            )}

            {/* Case studies inline - same as with-image */}
            {caseStudiesWithLogos.length > 0 && (
              <div class="service-section__case-studies service-section__case-studies--inline">
                {caseStudiesSectionTitle && (
                  <p class="service-section__case-studies-title">
                    {caseStudiesSectionTitle}
                  </p>
                )}
                <div class="service-section__case-studies-logos">
                  {caseStudiesWithLogos.map((caseStudy) => {
                    const logoUrl = urlForImage(caseStudy.clientLogo!)
                      .height(96)
                      .auto('format')
                      .url();
                    const { filter, hoverFilter } = getLogoFilters(
                      caseStudy.logoVariant
                    );
                    return (
                      <a
                        href={`/case-studies#${slugify(caseStudy.client || '')}`}
                        class="service-section__case-study-logo"
                        title={caseStudy.client || 'View case study'}
                      >
                        <img
                          src={logoUrl}
                          alt={
                            caseStudy.clientLogo?.alt ||
                            `${caseStudy.client} logo`
                          }
                          class="service-section__logo-image"
                          style={`--logo-filter: ${filter}; --logo-filter-hover: ${hoverFilter}`}
                          loading="lazy"
                          decoding="async"
                        />
                      </a>
                    );
                  })}
                </div>
              </div>
            )}
          </div>
        </>
      ) : (
        /* Catalogue layout - editorial magazine style (matches React Variant F) */
        <>
          {/* Label Row - OUTSIDE grid like React */}
          <div class="service-section__label-row">
            <span class="service-section__label-text">Service</span>
            <span class="service-section__label-number">{serviceNumber}</span>
            <div class="service-section__label-line" />
          </div>

          {/* Grid - only text and image columns */}
          <div
            class={`service-section__grid service-section__grid--catalogue ${imagePosition === 'right' ? 'service-section__grid--reversed' : ''}`}
          >
            {/* Text Column */}
            <div class="service-section__text-column">
              <h2 class="service-section__title service-section__title--serif">
                {title}
              </h2>
              {subtitle && <p class="service-section__subtitle">{subtitle}</p>}
              {description && description.length > 0 && (
                <div class="service-section__description">
                  <PortableText content={description} />
                </div>
              )}

              {/* Outcomes list - ALWAYS numbered style for catalogue layout */}
              {listItems.length > 0 && (
                <div class="service-section__list-wrapper">
                  {listTitle && (
                    <strong class="service-section__list-title">
                      {listTitle}
                    </strong>
                  )}
                  <ul class="service-section__list service-section__list--numbered">
                    {listItems.map((item, idx) => (
                      <li class="service-section__list-item">
                        <span class="service-section__list-number">
                          {idx + 1}.
                        </span>
                        <span class="service-section__list-text">{item}</span>
                      </li>
                    ))}
                  </ul>
                </div>
              )}

              {/* Client logos - inline below content */}
              {caseStudiesWithLogos.length > 0 && (
                <div class="service-section__case-studies service-section__case-studies--inline">
                  {caseStudiesSectionTitle && (
                    <p class="service-section__case-studies-title">
                      {caseStudiesSectionTitle}
                    </p>
                  )}
                  <div class="service-section__case-studies-logos">
                    {caseStudiesWithLogos.map((caseStudy) => {
                      const logoUrl = urlForImage(caseStudy.clientLogo!)
                        .height(96)
                        .auto('format')
                        .url();
                      const { filter, hoverFilter } = getLogoFilters(
                        caseStudy.logoVariant
                      );
                      return (
                        <a
                          href={`/case-studies#${slugify(caseStudy.client || '')}`}
                          class="service-section__case-study-logo"
                          title={caseStudy.client || 'View case study'}
                        >
                          <img
                            src={logoUrl}
                            alt={
                              caseStudy.clientLogo?.alt ||
                              `${caseStudy.client} logo`
                            }
                            class="service-section__logo-image"
                            style={`--logo-filter: ${filter}; --logo-filter-hover: ${hoverFilter}`}
                            loading="lazy"
                            decoding="async"
                          />
                        </a>
                      );
                    })}
                  </div>
                </div>
              )}
            </div>

            {/* Image Column with decorative elements */}
            <div class="service-section__image-column">
              <div class="service-section__image-wrapper">
                <div class="service-section__image-container service-section__image-container--portrait">
                  {iconType === 'image' && iconImage?.asset && (
                    <Image
                      image={iconImage}
                      alt={iconImage.alt || title}
                      class="service-section__image"
                      sizes="(max-width: 768px) 100vw, 50vw"
                    />
                  )}
                  {/* Ring overlay for subtle depth */}
                  <div class="service-section__image-ring" />
                </div>
              </div>
            </div>
          </div>
        </>
      )
    }
  </div>
</article>

<style>
  .service-section {
    padding-block: clamp(6rem, 10vw, 8rem);
    background: var(--service-bg, var(--color-background));
    overflow: hidden; /* Prevent pinned image from overflowing into next section */
  }

  .service-section__grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-xl);
    align-items: start;
  }

  @media (min-width: 768px) {
    .service-section__grid {
      grid-template-columns: 1fr 1fr;
      gap: var(--space-2xl);
    }

    .service-section__grid--reversed {
      direction: rtl;
    }

    .service-section__grid--reversed > * {
      direction: ltr;
    }
  }

  .service-section__media-column {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
    justify-content: center;
    height: 100%;
  }

  .service-section__media-column:has(.service-section__case-studies) {
    justify-content: space-between;
  }

  .service-section__image-container {
    display: flex;
    align-items: center;
    justify-content: center;
    aspect-ratio: 1;
    max-height: 27.375rem;
    background-color: var(--service-icon-container, var(--color-background));
    border: 1px solid var(--color-border, #e5e5e5);
    border-radius: 0.75rem;
  }

  .service-section__image-container:has(.service-section__image) {
    aspect-ratio: auto;
    background-color: transparent;
    border: none;
    overflow: hidden;
    clip-path: inset(10% round 0.75rem);
    transition: clip-path 0.8s cubic-bezier(0.16, 1, 0.3, 1);
  }

  .service-section__image-container.is-revealed {
    clip-path: inset(0% round 0.75rem);
  }

  .service-section__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 0.75rem;
  }

  .service-section__content {
  }

  .service-section__title {
    font-family: var(--font-heading);
    font-size: clamp(1.75rem, 4vw, 2.5rem);
    font-weight: 500;
    line-height: 1.2;
    color: var(--service-title, var(--color-accent));
    margin: 0 0 var(--space-md);
  }

  .service-section__subtitle {
    font-size: var(--font-size-lg);
    color: var(--service-subtitle, var(--color-text));
    line-height: 1.6;
    margin: 0 0 var(--space-sm);
    font-weight: 500;
  }

  .service-section__description {
    font-size: var(--font-size-base);
    color: var(--service-description, var(--color-text-muted));
    line-height: 1.7;
    margin: 0 0 var(--space-lg);
  }

  .service-section__description :global(.portable-text) {
    color: inherit;
    line-height: inherit;
  }

  .service-section__description :global(.portable-text p) {
    color: inherit;
  }

  /* List wrapper */
  .service-section__list-wrapper {
  }

  .service-section__list-wrapper--boxed {
    background-color: color-mix(in srgb, var(--color-surface) 50%, transparent);
    padding: var(--space-md);
    border-radius: 0.75rem;
  }

  .service-section__list-title {
    display: block;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--service-list-text, var(--color-text));
    margin-bottom: var(--space-sm);
  }

  /* Lists */
  .service-section__list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .service-section__list li {
    display: flex;
    align-items: flex-start;
    gap: var(--space-sm);
    padding: var(--space-xs) 0;
    color: var(--service-list-text, var(--color-text));
    line-height: 1.5;
  }

  /* Case Studies Section */
  .service-section__case-studies {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
  }

  .service-section__case-studies-title {
    font-size: var(--font-size-lg);
    color: var(--service-case-studies-title, var(--color-accent));
    margin: 0;
    text-transform: uppercase;
  }

  /* Case Studies Logos Container */
  .service-section__case-studies-logos {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: var(--space-lg);
  }

  /* Individual Logo Link */
  .service-section__case-study-logo {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 48px;
    text-decoration: none;
    transition: transform 0.3s ease;
  }

  .service-section__case-study-logo:hover {
    transform: scale(1.05);
  }

  .service-section__case-study-logo:focus-visible {
    outline: 2px solid var(--color-accent);
    outline-offset: 4px;
    border-radius: 4px;
  }

  /* Logo Image */
  .service-section__logo-image {
    height: 100%;
    width: auto;
    max-width: 140px;
    object-fit: contain;
    filter: var(--logo-filter, grayscale(1) opacity(0.7));
    transition: filter 0.4s ease;
  }

  .service-section__case-study-logo:hover .service-section__logo-image {
    filter: var(--logo-filter-hover, none);
  }

  /* ============================================
     CATALOGUE LAYOUT - Matches React Variant F exactly
     ============================================ */

  /* Catalogue grid - matches React: grid-cols-12 gap-12 */
  .service-section__grid--catalogue {
    display: grid;
    grid-template-columns: 1fr;
    gap: 3rem; /* gap-12 in Tailwind */
  }

  @media (min-width: 768px) {
    .service-section__grid--catalogue {
      grid-template-columns: repeat(12, 1fr);
      gap: 3rem;
    }

    /* Text column: span 6 (50%) */
    .service-section__grid--catalogue .service-section__text-column {
      grid-column: span 6;
    }

    /* Image column: span 6 (50%) - NO flex display to preserve GSAP pin */
    .service-section__grid--catalogue .service-section__image-column {
      grid-column: span 6;
      position: relative;
      align-self: stretch; /* Required for pin - column must be taller than pinned element */
      overflow: hidden; /* Clip pinned image when it exceeds column bounds */
    }

    /* Reversed layout */
    .service-section__grid--catalogue.service-section__grid--reversed {
      direction: rtl;
    }

    .service-section__grid--catalogue.service-section__grid--reversed > * {
      direction: ltr;
    }
  }

  /* Service Label Row - decorative header */
  .service-section__label-row {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    margin-bottom: var(--space-lg);
  }

  .service-section__label-text {
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    color: var(--color-text-muted);
  }

  .service-section__label-number {
    font-family: var(--font-heading);
    font-size: clamp(2.5rem, 5vw, 4rem);
    font-style: italic;
    font-weight: 400;
    color: var(--service-number-color, #e7e5e4);
    line-height: 1;
    transition: color 0.5s ease;
  }

  /* Number goes solid on HOVER - matches React group-hover:text-stone-900 */
  .service-section:hover .service-section__label-number {
    color: var(--service-number-hover-color, #1c1917);
  }

  .service-section__label-line {
    flex-grow: 1;
    height: 1px;
    background-color: var(--service-divider-color, #f5f5f4);
    transition: background-color 0.5s ease;
  }

  /* Line goes darker on HOVER - matches React group-hover:bg-stone-300 */
  .service-section:hover .service-section__label-line {
    background-color: color-mix(
      in srgb,
      var(--service-divider-color, #f5f5f4) 60%,
      #000
    );
  }

  /* Text column */
  .service-section__text-column {
    display: flex;
    flex-direction: column;
  }

  /* Full-width text column (no-image layout) */
  .service-section__text-column--full {
    max-width: none;
  }

  /* Override global 65ch max-width for full-width layout */
  .service-section__text-column--full .service-section__subtitle,
  .service-section__text-column--full .service-section__description :global(p) {
    max-inline-size: none;
  }

  /* Equal spacing for no-image layout: match description-to-list spacing */
  .service-section__text-column--full .service-section__case-studies--inline {
    margin-top: var(--space-lg);
    padding-top: 0;
  }

  /* Serif title variant for catalogue */
  .service-section__title--serif {
    font-family: var(--font-heading);
    font-size: clamp(1.875rem, 4vw, 2.5rem);
    font-weight: 400;
    line-height: 1.15;
    color: var(--service-title, var(--color-text));
  }

  /* Image wrapper - pinned via GSAP ScrollTrigger (CSS sticky breaks with Lenis) */
  .service-section__image-wrapper {
    position: relative;
    width: 100%;
  }

  /* Portrait aspect ratio container for catalogue */
  .service-section__image-container--portrait {
    display: flex;
    align-items: center;
    justify-content: center;
    aspect-ratio: 4 / 5;
    background-color: var(--service-icon-container, var(--color-surface));
    border-radius: 0.5rem;
    overflow: hidden;
    position: relative;
  }

  .service-section__image-container--portrait .service-section__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* Portrait container image reveal animation */
  .service-section__image-container--portrait:has(.service-section__image) {
    clip-path: inset(8% round 0.5rem);
    transition: clip-path 0.8s cubic-bezier(0.16, 1, 0.3, 1);
  }

  .service-section__image-container--portrait.is-revealed {
    clip-path: inset(0% round 0.5rem);
  }

  /* Ring overlay for subtle depth */
  .service-section__image-ring {
    position: absolute;
    inset: 0;
    border-radius: inherit;
    box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.05);
    pointer-events: none;
    transition: box-shadow 0.4s ease;
  }

  .service-section:hover .service-section__image-ring {
    box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.1);
  }

  /* Numbered list variant */
  .service-section__list--numbered {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .service-section__list--numbered .service-section__list-item {
    display: flex;
    align-items: flex-start;
    gap: var(--space-md);
    padding: var(--space-md) 0;
    border-bottom: 1px solid var(--service-divider-color, #f5f5f4);
    font-size: var(--font-size-sm);
    color: var(--service-list-text, var(--color-text));
    line-height: 1.6;
  }

  .service-section__list--numbered .service-section__list-item:last-child {
    border-bottom: none;
  }

  .service-section__list-number {
    font-family: var(--font-heading);
    font-style: italic;
    font-weight: 400;
    color: var(--service-number-color, #d6d3d1);
    flex-shrink: 0;
    min-width: 1.5rem;
  }

  .service-section__list-text {
    flex: 1;
  }

  /* Inline client logos (below outcomes list) */
  .service-section__case-studies--inline {
    margin-top: var(--space-xl);
    padding-top: var(--space-lg);
  }

  .service-section__case-studies--inline .service-section__case-studies-logos {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 1.5rem; /* gap-6 in Tailwind */
    opacity: 0.5;
    filter: grayscale(1);
    transition:
      opacity 0.4s ease,
      filter 0.4s ease;
  }

  .service-section__case-studies--inline:hover
    .service-section__case-studies-logos {
    opacity: 1;
    filter: grayscale(0);
  }

  /* Smaller logos for catalogue layout */
  .service-section__case-studies--inline .service-section__case-study-logo {
    height: 36px;
  }

  .service-section__case-studies--inline .service-section__logo-image {
    max-width: 100px;
  }

  /* Animation-ready states - simplified to main blocks */
  /* Note: label-row is NOT included - always visible like React */
  .service-section[data-animate] .service-section__media-column,
  .service-section[data-animate] .service-section__content,
  .service-section[data-animate] .service-section__text-column {
    opacity: 0;
  }

  /* Image column: only hide the WRAPPER, not the column itself (to preserve sticky) */
  .service-section[data-animate] .service-section__image-wrapper {
    opacity: 0;
  }

  /* Only hide list items for catalogue layout (with image) - no-image layout shows them immediately */
  .service-section[data-animate]:not([data-no-image='true'])
    .service-section__list-item {
    opacity: 0;
  }

  /* Word reveal clip container */
  .service-section__title :global(.editorial-word-wrapper) {
    display: inline-block;
    overflow: hidden;
    vertical-align: top;
    padding-bottom: 0.1em;
  }

  /* Reduced motion: show all immediately */
  @media (prefers-reduced-motion: reduce) {
    .service-section__case-study-logo,
    .service-section__logo-image {
      transition: none;
    }

    .service-section[data-animate] .service-section__media-column,
    .service-section[data-animate] .service-section__content,
    .service-section[data-animate] .service-section__text-column,
    .service-section[data-animate] .service-section__image-wrapper,
    .service-section[data-animate]:not([data-no-image='true'])
      .service-section__list-item {
      opacity: 1 !important;
      transform: none !important;
    }
  }
</style>

<script>
  import {
    setupAnimationLifecycle,
    gsap,
    SplitText,
  } from '@lib/animation/utils';
  import { ANIMATION_CONFIG } from '@lib/animation/config';

  setupAnimationLifecycle(() => {
    // Check for reduced motion preference
    const prefersReducedMotion = window.matchMedia(
      '(prefers-reduced-motion: reduce)'
    ).matches;

    // Image reveal animations
    const imageContainers = document.querySelectorAll(
      '.service-section__image-container:has(.service-section__image)'
    );

    imageContainers.forEach((container) => {
      const image = container.querySelector('.service-section__image');

      if (prefersReducedMotion) {
        container.classList.add('is-revealed');
        if (image) gsap.set(image, { scale: 1 });
        return;
      }

      if (image) {
        // Set initial scale - more dramatic
        gsap.set(image, { scale: 1.15 });

        // Clip-path reveal trigger - later trigger point
        gsap.to(container, {
          scrollTrigger: {
            trigger: container,
            start: 'top 55%',
            once: true,
            markers: ANIMATION_CONFIG.scrollTrigger.markers,
            onEnter: () => container.classList.add('is-revealed'),
          },
        });

        // Ken Burns scale animation - slower for cinematic feel
        gsap.to(image, {
          scale: 1,
          duration: 1.5,
          ease: 'power2.out',
          scrollTrigger: {
            trigger: container,
            start: 'top 55%',
            once: true,
            markers: ANIMATION_CONFIG.scrollTrigger.markers,
          },
          onComplete: () => {
            // Add hover zoom animation (desktop only)
            const isDesktop = window.matchMedia('(min-width: 768px)').matches;
            if (!isDesktop) return;

            const section = container.closest('.service-section');
            if (!section) return;

            section.addEventListener('mouseenter', () => {
              gsap.to(image, {
                scale: 1.02,
                duration: 1.8,
                ease: 'power2.out',
              });
            });

            section.addEventListener('mouseleave', () => {
              gsap.to(image, {
                scale: 1,
                duration: 1.8,
                ease: 'power2.out',
              });
            });
          },
        });
      }
    });

    const sections = document.querySelectorAll(
      '.service-section[data-animate]'
    );

    sections.forEach((section) => {
      // If reduced motion, show everything immediately
      if (prefersReducedMotion) {
        gsap.set(section.querySelectorAll('[class*="service-section__"]'), {
          opacity: 1,
          transform: 'none',
        });
        return;
      }

      // Check layout type
      const isNoImage = section.getAttribute('data-no-image') === 'true';
      const isReversed = section.getAttribute('data-reversed') === 'true';
      const isCatalogue =
        section.querySelector('.service-section__grid--catalogue') !== null;

      // Get main elements based on layout type
      let columnsToAnimate: Element[] = [];

      if (isNoImage) {
        // No-image layout uses same structure as with-image, just full width
        const textColumn = section.querySelector(
          '.service-section__text-column'
        );
        columnsToAnimate = [textColumn].filter(Boolean) as Element[];
      } else if (isCatalogue) {
        // Catalogue layout - ONLY animate text column with transforms
        // Image column must NOT have transforms applied - they break CSS sticky positioning
        // Label row is always visible like React (no animation)
        const textColumn = section.querySelector(
          '.service-section__text-column'
        );
        columnsToAnimate = [textColumn].filter(Boolean) as Element[];

        // Set up image wrapper for opacity-only animation (no transforms)
        const imageWrapper = section.querySelector(
          '.service-section__image-wrapper'
        );
        if (imageWrapper) {
          gsap.set(imageWrapper, { opacity: 0 });
        }
      } else {
        const mediaColumn = section.querySelector(
          '.service-section__media-column'
        );
        const content = section.querySelector('.service-section__content');
        columnsToAnimate = [mediaColumn, content].filter(Boolean) as Element[];
      }

      const title = section.querySelector('.service-section__title');
      const listItems = section.querySelectorAll('.service-section__list-item');

      // Set initial states - dramatic offsets with alternating directions
      columnsToAnimate.forEach((col, index) => {
        // Alternate slide direction for visual interest
        let xOffset = index === 0 ? -40 : 40;
        if (isReversed) xOffset *= -1;

        gsap.set(col, {
          opacity: 0,
          y: 50,
          x: xOffset,
          scale: 0.97,
        });
      });

      // Set initial states for list items (for stagger animation)
      if (isCatalogue && listItems.length > 0) {
        gsap.set(listItems, {
          opacity: 0,
          x: -15,
        });
      }

      // Split title into words for subtle editorial reveal
      let titleWords: HTMLElement[] = [];
      if (title) {
        const titleSplit = new SplitText(title, { type: 'words' });
        titleWords = titleSplit.words as HTMLElement[];

        // Wrap each word for clip overflow
        titleWords.forEach((word) => {
          const wrapper = document.createElement('span');
          wrapper.style.display = 'inline-block';
          wrapper.style.overflow = 'hidden';
          wrapper.style.verticalAlign = 'top';
          wrapper.style.paddingBottom = '0.1em';
          wrapper.classList.add('editorial-word-wrapper');

          word.parentNode?.insertBefore(wrapper, word);
          wrapper.appendChild(word);

          // Set initial state - dramatic full clip reveal
          gsap.set(word, { y: '100%', opacity: 0 });
        });
      }

      // Create timeline with later trigger for dramatic reveal
      const tl = gsap.timeline({
        scrollTrigger: {
          trigger: section,
          start: 'top 60%',
          once: true,
          markers: ANIMATION_CONFIG.scrollTrigger.markers,
          onEnter: () => {
            // Add is-active class to trigger CSS transitions (line growth, number color)
            section.classList.add('is-active');
          },
        },
      });

      // Columns animate with stagger and dramatic movement
      tl.to(columnsToAnimate, {
        opacity: 1,
        y: 0,
        x: 0,
        scale: 1,
        duration: 0.9,
        ease: 'power3.out',
        stagger: 0.15,
        clearProps: 'transform', // Clear transforms so sticky positioning works on image column
      });

      // For catalogue layout: fade in image with OPACITY ONLY (no transforms)
      // This preserves CSS sticky positioning on the image wrapper
      if (isCatalogue) {
        const imageWrapper = section.querySelector(
          '.service-section__image-wrapper'
        );
        if (imageWrapper) {
          tl.to(
            imageWrapper,
            {
              opacity: 1,
              duration: 0.9,
              ease: 'power3.out',
            },
            0.15 // Start slightly after text column
          );
        }
      }

      // Title words reveal - pronounced word-by-word effect
      if (titleWords.length > 0) {
        tl.to(
          titleWords,
          {
            y: 0,
            opacity: 1,
            duration: 0.6,
            stagger: 0.04,
            ease: 'power3.out',
          },
          0.2
        );
      }

      // List items stagger animation (catalogue layout)
      if (isCatalogue && listItems.length > 0) {
        tl.to(
          listItems,
          {
            opacity: 1,
            x: 0,
            duration: 0.5,
            stagger: 0.08,
            ease: 'power2.out',
          },
          0.5
        );
      }

      // GSAP ScrollTrigger PIN for catalogue layout (replaces CSS sticky which breaks with Lenis)
      if (isCatalogue) {
        const imageWrapper = section.querySelector(
          '.service-section__image-wrapper'
        );
        const textColumn = section.querySelector(
          '.service-section__text-column'
        );

        if (imageWrapper && textColumn) {
          // Only pin on desktop (768px+)
          const mm = gsap.matchMedia();

          mm.add('(min-width: 768px)', () => {
            // Pin starts when image top reaches 128px from viewport top
            // Pin ends when text column bottom reaches image bottom position
            const imageHeight = imageWrapper.getBoundingClientRect().height;

            gsap.to(imageWrapper, {
              scrollTrigger: {
                trigger: imageWrapper,
                start: 'top 128px', // top-32 = 8rem = 128px from viewport top
                endTrigger: textColumn,
                end: `bottom ${128 + imageHeight}px`, // when text bottom reaches pinned image bottom
                pin: true,
                pinSpacing: false, // Don't add extra spacing
                markers: ANIMATION_CONFIG.scrollTrigger.markers,
              },
            });
          });
        }
      }
    });
  });
</script>
