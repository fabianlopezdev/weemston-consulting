---
import { resolveColorSelection } from '@lib/sanity/colorResolver';
import { sanityClient as client } from 'sanity:client';
import { siteSettingsQuery } from '@lib/sanity/queries';

interface ColorData {
  label?: string;
  value: string;
}

interface Props {
  heading: string;
  headingHighlight?: string;
  highlightColorType?: 'primary' | 'secondary' | 'accent' | 'custom';
  highlightColorShade?: number;
  highlightCustomColor?: ColorData;
  showDivider?: boolean;
  dividerColorType?: 'primary' | 'secondary' | 'accent' | 'custom';
  dividerColorShade?: number;
  dividerCustomColor?: ColorData;
  backgroundColorType?: 'primary' | 'secondary' | 'accent' | 'custom';
  backgroundColorShade?: number;
  backgroundCustomColor?: ColorData;
}

const {
  heading,
  headingHighlight,
  highlightColorType = 'accent',
  highlightColorShade = 0,
  highlightCustomColor,
  showDivider = true,
  dividerColorType = 'secondary',
  dividerColorShade = 0,
  dividerCustomColor,
  backgroundColorType = 'primary',
  backgroundColorShade = 90,
  backgroundCustomColor,
} = Astro.props;

// Fetch site settings for colors
const settings = await client.fetch(siteSettingsQuery);
const siteColors = settings?.colors;

// Resolve background color
const backgroundColor = resolveColorSelection(
  {
    colorType: backgroundColorType,
    shade: backgroundColorShade,
    customColor: backgroundCustomColor,
  },
  siteColors
);

// Resolve highlight color
let highlightColor: string;
if (highlightColorType === 'custom' && highlightCustomColor?.value) {
  highlightColor = highlightCustomColor.value;
} else {
  highlightColor = resolveColorSelection(
    {
      colorType: highlightColorType,
      shade: highlightColorShade,
      customColor: highlightCustomColor,
    },
    siteColors
  );
}

// Resolve divider color
let dividerColor: string;
if (dividerColorType === 'custom' && dividerCustomColor?.value) {
  dividerColor = dividerCustomColor.value;
} else {
  dividerColor = resolveColorSelection(
    {
      colorType: dividerColorType,
      shade: dividerColorShade,
      customColor: dividerCustomColor,
    },
    siteColors
  );
}

const cssVars = `--approach-hero-bg: ${backgroundColor}; --approach-hero-highlight: ${highlightColor}; --approach-hero-divider: ${dividerColor}`;

// Split heading into parts if highlight text is provided and found
function renderHeadingParts() {
  if (!headingHighlight || !heading.includes(headingHighlight)) {
    return { before: heading, highlight: null, after: null };
  }
  const index = heading.indexOf(headingHighlight);
  return {
    before: heading.slice(0, index),
    highlight: headingHighlight,
    after: heading.slice(index + headingHighlight.length),
  };
}

const parts = renderHeadingParts();
---

<section class="approach-hero" style={cssVars}>
  <div class="approach-hero__container">
    <h1 class="approach-hero__heading">
      {parts.highlight ? (
        <>
          {parts.before}<span class="approach-hero__highlight">{parts.highlight}</span>{parts.after}
        </>
      ) : (
        heading
      )}
    </h1>
    {showDivider && <div class="approach-hero__divider" />}
  </div>
</section>

<style>
  .approach-hero {
    background-color: var(--approach-hero-bg, var(--color-primary-light));
    padding: clamp(6rem, 10vw, 8rem) var(--space-md) clamp(4rem, 8vw, 6rem);
    text-align: center;
  }

  .approach-hero__container {
    max-width: 900px;
    margin: 0 auto;
  }

  .approach-hero__heading {
    font-family: var(--font-heading);
    font-size: clamp(2rem, 5vw, 3.5rem);
    font-weight: 500;
    line-height: 1.2;
    color: var(--color-accent);
    margin: 0 0 var(--space-lg);
  }

  .approach-hero__highlight {
    font-style: italic;
    color: var(--approach-hero-highlight, var(--color-text-muted));
  }

  .approach-hero__divider {
    width: 6rem;
    height: 0.25rem;
    background-color: var(--approach-hero-divider, var(--color-secondary));
    margin: 0 auto;
    border-radius: 9999px;
  }
</style>
