---
/**
 * AboutTitleWithSideImage - Section with title and side image
 * Image displays on either side with contain behavior
 * Background color fills the empty space
 */
import { PortableText } from 'astro-portabletext';
import type { PortableTextBlock } from '@portabletext/types';
import {
  resolveColorSelection,
  resolveGradient,
} from '@lib/sanity/colorResolver';
import { sanityClient as client } from 'sanity:client';
import { siteSettingsQuery } from '@lib/sanity/queries';
import { urlForImage } from '@lib/sanity/image';
import type { SanityImageSource } from '@sanity/image-url/lib/types/types';

interface ColorData {
  label?: string;
  value: string;
}

interface GradientColor {
  colorType?: 'primary' | 'secondary' | 'accent' | 'custom';
  shade?: number;
  customColor?: ColorData;
}

interface GradientData {
  direction?: string;
  startColor?: GradientColor;
  endColor?: GradientColor;
}

interface ImageData {
  asset: SanityImageSource;
  alt?: string;
  hotspot?: { x: number; y: number };
  crop?: { top: number; bottom: number; left: number; right: number };
}

interface Props {
  title?: PortableTextBlock[];
  image?: ImageData;
  imagePosition?: 'left' | 'right';
  // Background color
  backgroundColorMode?: 'solid' | 'gradient';
  backgroundColorType?:
    | 'default'
    | 'primary'
    | 'secondary'
    | 'accent'
    | 'custom';
  backgroundColorShade?: number;
  backgroundCustomColor?: ColorData;
  backgroundGradient?: GradientData;
  // Title color
  titleColorType?: 'primary' | 'secondary' | 'accent' | 'custom';
  titleColorShade?: number;
  titleCustomColor?: ColorData;
}

const {
  title,
  image,
  imagePosition = 'right',
  backgroundColorMode = 'solid',
  backgroundColorType = 'default',
  backgroundColorShade = 95,
  backgroundCustomColor,
  backgroundGradient,
  titleColorType = 'primary',
  titleColorShade = 0,
  titleCustomColor,
} = Astro.props;

// Fetch site settings for colors
const settings = await client.fetch(siteSettingsQuery);
const siteColors = settings?.colors;

// Resolve title color
const titleColor = resolveColorSelection(
  {
    colorType: titleColorType,
    shade: titleColorShade,
    customColor: titleCustomColor,
  },
  siteColors
);

// Resolve background color
let backgroundColor = '#ffffff';
if (backgroundColorMode === 'gradient' && backgroundGradient) {
  backgroundColor = resolveGradient(backgroundGradient, siteColors);
} else {
  backgroundColor = resolveColorSelection(
    {
      colorType: backgroundColorType,
      shade: backgroundColorShade,
      customColor: backgroundCustomColor,
    },
    siteColors
  );
}

// Generate optimized image URL
const imageUrl = image?.asset
  ? urlForImage(image).height(1000).quality(85).auto('format').url()
  : null;
const imageAlt = image?.alt || 'Section image';

const isGradient = backgroundColorMode === 'gradient';

const cssVars = [
  `--section-title-color: ${titleColor}`,
  `--section-bg: ${backgroundColor}`,
].join('; ');
---

{
  image?.asset && (
    <section class="title-side-image" style={cssVars}>
      <div
        class={`title-side-image__container${imagePosition === 'left' ? ' title-side-image__container--image-left' : ''}`}
        style={isGradient ? `background: ${backgroundColor}` : undefined}
      >
        <div class="title-side-image__text">
          {title && title.length > 0 && (
            <h2 class="title-side-image__heading">
              <PortableText value={title} />
            </h2>
          )}
        </div>
        <div class="title-side-image__image-wrapper">
          <img src={imageUrl} alt={imageAlt} loading="eager" />
        </div>
      </div>
    </section>
  )
}

<style>
  .title-side-image {
    overflow: hidden;
  }

  .title-side-image__container {
    display: flex;
    height: 500px;
    background-color: var(--section-bg);
    overflow: hidden;
  }

  .title-side-image__text {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-xl);
    text-align: center;
  }

  .title-side-image__heading {
    font-family: var(--font-heading);
    font-size: clamp(2rem, 5vw, 3.5rem);
    font-weight: var(--font-weight-normal);
    line-height: 1.2;
    color: var(--section-title-color);
    margin: 0;
    text-align: center;
  }

  .title-side-image__heading :global(p) {
    margin: 0;
    font: inherit;
    color: inherit;
    text-align: center;
  }

  .title-side-image__heading :global(em) {
    font-family: var(--font-script, 'Cormorant Garamond'), Georgia, serif;
    font-size: 1.2em;
    font-style: italic;
  }

  .title-side-image__heading :global(strong) {
    font-weight: var(--font-weight-bold, 700);
  }

  .title-side-image__image-wrapper {
    flex-shrink: 0;
    display: flex;
    align-items: flex-start;
    justify-content: flex-end;
    height: 500px;
  }

  .title-side-image__image-wrapper img {
    object-fit: contain;
    object-position: top right;
    height: 100%;
    width: auto;
    max-height: 500px;
  }

  /* Image on left */
  .title-side-image__container--image-left {
    flex-direction: row-reverse;
  }

  .title-side-image__container--image-left .title-side-image__image-wrapper {
    justify-content: flex-start;
  }

  .title-side-image__container--image-left
    .title-side-image__image-wrapper
    img {
    object-position: top left;
  }

  /* Responsive */
  @media (max-width: 767px) {
    .title-side-image__container {
      flex-direction: column;
      height: auto;
      min-height: 400px;
    }

    .title-side-image__text {
      padding: var(--space-lg);
      order: 1;
    }

    .title-side-image__image-wrapper {
      order: 2;
      width: 100%;
      justify-content: center;
      min-height: 300px;
    }

    .title-side-image__heading {
      font-size: clamp(1.5rem, 5vw, 2.5rem);
    }
  }
</style>

<script>
  import { gsap } from 'gsap';

  const prefersReducedMotion = window.matchMedia(
    '(prefers-reduced-motion: reduce)'
  ).matches;

  if (!prefersReducedMotion) {
    const container = document.querySelector('.title-side-image__container');
    const text = document.querySelector('.title-side-image__text');
    const imageWrapper = document.querySelector(
      '.title-side-image__image-wrapper'
    );

    if (container) {
      gsap.from(container, {
        opacity: 0,
        duration: 0.6,
        ease: 'power2.out',
      });
    }

    if (text) {
      gsap.from(text, {
        opacity: 0,
        x: -20,
        duration: 0.6,
        delay: 0.2,
        ease: 'power2.out',
      });
    }

    if (imageWrapper) {
      gsap.from(imageWrapper, {
        opacity: 0,
        x: 20,
        duration: 0.6,
        delay: 0.3,
        ease: 'power2.out',
      });
    }
  }
</script>
