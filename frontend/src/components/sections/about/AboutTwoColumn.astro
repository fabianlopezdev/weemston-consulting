---
/**
 * AboutTwoColumn - Two-column section with images and text
 * Supports 1-3 images, configurable image position (left/right)
 * Matches PDF design with asymmetric layouts
 */
import Image from '@components/media/Image.astro';
import PortableText from '@components/sanity/PortableText.astro';
import { resolveColorSelection } from '@lib/sanity/colorResolver';
import { sanityClient as client } from 'sanity:client';
import { siteSettingsQuery } from '@lib/sanity/queries';
import type { PortableTextBlock } from '@portabletext/types';
import type { SanityImageSource } from '@sanity/image-url/lib/types/types';

interface ColorData {
  label?: string;
  value: string;
}

interface GradientColorData {
  colorType?: 'primary' | 'secondary' | 'accent' | 'custom';
  shade?: number;
  customColor?: ColorData;
}

interface GradientData {
  direction?: string;
  startColor?: GradientColorData;
  endColor?: GradientColorData;
}

interface ImageData {
  asset: SanityImageSource;
  alt?: string;
  hotspot?: { x: number; y: number };
  crop?: { top: number; bottom: number; left: number; right: number };
}

interface Props {
  title?: string;
  titleScriptPortion?: string;
  subtitle?: string;
  content?: PortableTextBlock[];
  images?: ImageData[];
  secondaryImage?: ImageData;
  imagePosition?: 'left' | 'right';
  titlePosition?: 'image' | 'text';
  verticalAlign?: 'start' | 'center' | 'end';
  titleColorType?: 'primary' | 'secondary' | 'accent' | 'custom';
  titleColorShade?: number;
  titleCustomColor?: ColorData;
  textColor?: 'base' | 'muted' | 'contrast';
  backgroundColorMode?: 'solid' | 'gradient';
  backgroundColorType?:
    | 'default'
    | 'primary'
    | 'secondary'
    | 'accent'
    | 'custom';
  backgroundColorShade?: number;
  backgroundCustomColor?: ColorData;
  backgroundGradient?: GradientData;
}

const {
  title,
  titleScriptPortion,
  subtitle,
  content,
  images = [],
  secondaryImage,
  imagePosition = 'left',
  titlePosition = 'image',
  verticalAlign = 'center',
  titleColorType = 'primary',
  titleColorShade = 0,
  titleCustomColor,
  textColor = 'muted',
  backgroundColorMode = 'solid',
  backgroundColorType = 'default',
  backgroundColorShade = 95,
  backgroundCustomColor,
  backgroundGradient,
} = Astro.props;

// Fetch site settings for colors
const settings = await client.fetch(siteSettingsQuery);
const siteColors = settings?.colors;

// Resolve background color
let backgroundColor = 'transparent';
if (backgroundColorType !== 'default') {
  backgroundColor =
    backgroundColorMode === 'gradient' && backgroundGradient
      ? `linear-gradient(${backgroundGradient.direction || '135deg'}, ${resolveColorSelection(backgroundGradient.startColor, siteColors)}, ${resolveColorSelection(backgroundGradient.endColor, siteColors)})`
      : resolveColorSelection(
          {
            colorType: backgroundColorType,
            shade: backgroundColorShade,
            customColor: backgroundCustomColor,
          },
          siteColors
        );
}

// Resolve title color
const titleColor = resolveColorSelection(
  {
    colorType: titleColorType,
    shade: titleColorShade,
    customColor: titleCustomColor,
  },
  siteColors
);

// Text color mapping
const textColorMap = {
  base: 'var(--color-text)',
  muted: 'var(--color-text-muted)',
  contrast: 'var(--color-text-contrast)',
};

// Process title for script portion
const renderTitle = () => {
  if (!title) return null;
  if (!titleScriptPortion || !title.includes(titleScriptPortion)) {
    return { full: title };
  }
  const parts = title.split(titleScriptPortion);
  return {
    before: parts[0] || '',
    script: titleScriptPortion,
    after: parts[1] || '',
  };
};

const titleParts = renderTitle();
const hasScriptPortion = titleParts && 'script' in titleParts;

// Determine image layout based on count
const imageCount = images.length;
const imageLayoutClass = `two-column__images--count-${Math.min(imageCount, 3)}`;

const cssVars = [
  `--two-column-bg: ${backgroundColor}`,
  `--two-column-title-color: ${titleColor}`,
  `--two-column-text-color: ${textColorMap[textColor]}`,
  `--two-column-align: ${verticalAlign}`,
].join('; ');
---

<section
  class:list={['two-column', `two-column--image-${imagePosition}`]}
  style={cssVars}
>
  <div class="container">
    <div class="two-column__grid">
      <div class:list={['two-column__images', imageLayoutClass]}>
        {
          titleParts && titlePosition === 'image' && (
            <h3 class="two-column__title">
              {hasScriptPortion ? (
                <>
                  {titleParts.before}
                  <span class="two-column__title-script">
                    {titleParts.script}
                  </span>
                  {titleParts.after}
                </>
              ) : (
                titleParts.full
              )}
            </h3>
          )
        }
        {
          images.map((image, index) => (
            <figure class={`two-column__image two-column__image--${index + 1}`}>
              <Image
                image={image}
                alt={image?.alt || `Image ${index + 1}`}
                sizes="(max-width: 768px) 100vw, 50vw"
              />
            </figure>
          ))
        }
      </div>
      <div class="two-column__content">
        <div class="two-column__content-text">
          {
            titleParts && titlePosition === 'text' && (
              <h3 class="two-column__title">
                {hasScriptPortion ? (
                  <>
                    {titleParts.before}
                    <span class="two-column__title-script">
                      {titleParts.script}
                    </span>
                    {titleParts.after}
                  </>
                ) : (
                  titleParts.full
                )}
              </h3>
            )
          }
          {subtitle && <p class="two-column__subtitle">{subtitle}</p>}
          {
            content && (
              <div class="two-column__text">
                <PortableText content={content} />
              </div>
            )
          }
        </div>
        {
          secondaryImage?.asset && (
            <figure class="two-column__secondary-image">
              <Image
                image={secondaryImage}
                alt={secondaryImage?.alt || 'Secondary image'}
                sizes="(max-width: 768px) 100vw, 45vw"
              />
            </figure>
          )
        }
      </div>
    </div>
  </div>
</section>

<style>
  .two-column {
    background: var(--two-column-bg);
    padding: var(--space-2xl) 0;
  }

  .container {
    max-width: var(--container-max-width);
    margin-inline: auto;
    padding-inline: var(--container-padding);
  }

  .two-column__grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-xl);
    align-items: stretch; /* Both columns same height */
  }

  @media (min-width: 768px) {
    .two-column__grid {
      grid-template-columns: 1fr 1fr;
      gap: var(--space-2xl);
    }

    .two-column--image-right .two-column__images {
      order: 2;
    }

    .two-column--image-right .two-column__content {
      order: 1;
    }
  }

  /* Image container */
  .two-column__images {
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    gap: var(--space-sm);
  }

  /* Single image layout */
  .two-column__images--count-1 {
    /* Single image takes natural height up to max */
  }

  .two-column__images--count-1 .two-column__image {
    aspect-ratio: 3 / 4;
    overflow: hidden;
  }

  /* Two image layout */
  .two-column__images--count-2 {
    grid-template-columns: 1fr 1fr;
    grid-template-rows: auto;
  }

  .two-column__images--count-2 .two-column__image--1 {
    grid-column: span 2;
    min-height: 250px;
  }

  .two-column__images--count-2 .two-column__image--2 {
    grid-column: 2;
    min-height: 180px;
  }

  @media (min-width: 768px) {
    .two-column__images--count-2 {
      grid-template-rows: 1fr 1fr;
    }

    .two-column__images--count-2 .two-column__image--1 {
      grid-row: span 2;
      grid-column: 1;
      min-height: 100%;
    }

    .two-column__images--count-2 .two-column__image--2 {
      grid-column: 2;
      min-height: 100%;
    }
  }

  /* Three image layout */
  .two-column__images--count-3 {
    grid-template-columns: 1fr 1fr;
    grid-template-rows: auto auto;
  }

  .two-column__images--count-3 .two-column__image--1 {
    grid-row: span 2;
    min-height: 300px;
  }

  .two-column__images--count-3 .two-column__image--2,
  .two-column__images--count-3 .two-column__image--3 {
    min-height: 140px;
  }

  @media (min-width: 768px) {
    .two-column__images--count-3 .two-column__image--1 {
      min-height: 100%;
    }

    .two-column__images--count-3 .two-column__image--2,
    .two-column__images--count-3 .two-column__image--3 {
      min-height: 100%;
    }
  }

  .two-column__image {
    margin: 0;
    overflow: hidden;
    border-radius: var(--border-radius-md);
  }

  .two-column__image :global(img),
  .two-column__image :global(.image-blur-wrapper) {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.5s ease;
  }

  .two-column__image:hover :global(img) {
    transform: scale(1.03);
  }

  /* Content */
  .two-column__content {
    display: flex;
    flex-direction: column;
  }

  /* Text wrapper - vertically centered */
  .two-column__content-text {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  .two-column__title {
    font-family: var(--font-heading);
    font-size: var(--font-size-3xl);
    font-weight: var(--font-weight-normal);
    color: var(--two-column-title-color);
    margin: 0 0 var(--space-md);
    line-height: 1.3;
  }

  /* When title is in images column, push it to top */
  .two-column__images .two-column__title {
    margin-bottom: auto;
  }

  .two-column__title-script {
    font-family: var(--font-script, 'Cormorant Garamond'), Georgia, serif;
    font-style: italic;
  }

  .two-column__subtitle {
    font-family: var(--font-script, 'Cormorant Garamond'), Georgia, serif;
    font-size: clamp(1.25rem, 2.5vw, 1.75rem);
    font-style: italic;
    color: var(--two-column-title-color);
    margin: -0.5rem 0 var(--space-lg);
    opacity: 0.8;
  }

  .two-column__text {
    color: var(--two-column-text-color);
  }

  .two-column__text :global(p) {
    font-size: var(--font-size-base);
    line-height: var(--line-height-relaxed);
    margin: 0 0 var(--space-md);
  }

  .two-column__text :global(p:last-child) {
    margin-bottom: 0;
  }

  /* Match Centered Text - all paragraphs same size */
  .two-column__text :global(p) {
    font-size: var(--font-size-lg);
    color: var(--color-text);
  }

  /* Secondary image - fixed landscape aspect ratio */
  .two-column__secondary-image {
    margin: var(--space-lg) 0 0;
    overflow: hidden;
    border-radius: var(--border-radius-md);
    aspect-ratio: 4 / 3;
  }

  .two-column__secondary-image :global(img),
  .two-column__secondary-image :global(.image-blur-wrapper) {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.5s ease;
  }

  .two-column__secondary-image:hover :global(img) {
    transform: scale(1.03);
  }
</style>

<script>
  import { gsap } from 'gsap';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';

  gsap.registerPlugin(ScrollTrigger);

  const prefersReducedMotion = window.matchMedia(
    '(prefers-reduced-motion: reduce)'
  ).matches;

  if (!prefersReducedMotion) {
    const sections = gsap.utils.toArray('.two-column') as HTMLElement[];
    sections.forEach((section) => {
      const title = section.querySelector(
        '.two-column__images .two-column__title'
      );
      const images = section.querySelectorAll('.two-column__image');
      const content = section.querySelector('.two-column__content');

      // Animate title in images column
      if (title) {
        gsap.from(title, {
          scrollTrigger: {
            trigger: section,
            start: 'top 80%',
            once: true,
          },
          opacity: 0,
          y: 20,
          duration: 0.6,
          ease: 'power2.out',
        });
      }

      // Animate images
      if (images.length) {
        gsap.from(images, {
          scrollTrigger: {
            trigger: section,
            start: 'top 80%',
            once: true,
          },
          opacity: 0,
          y: 30,
          duration: 0.7,
          stagger: 0.1,
          delay: title ? 0.1 : 0,
          ease: 'power2.out',
        });
      }

      // Animate content
      if (content) {
        gsap.from(content.children, {
          scrollTrigger: {
            trigger: section,
            start: 'top 80%',
            once: true,
          },
          opacity: 0,
          y: 20,
          duration: 0.6,
          stagger: 0.1,
          delay: 0.2,
          ease: 'power2.out',
        });
      }
    });
  }
</script>
