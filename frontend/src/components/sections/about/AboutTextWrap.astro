---
/**
 * AboutTextWrap - Magazine-style photo collage with overlapping images
 * Two images on the right: top (narrower) and bottom (wider, overlaps top)
 * Text flows on the left, wrapping around each image
 */
import Image from '@components/media/Image.astro';
import PortableText from '@components/sanity/PortableText.astro';
import { resolveColorSelection } from '@lib/sanity/colorResolver';
import { sanityClient as client } from 'sanity:client';
import { siteSettingsQuery } from '@lib/sanity/queries';
import type { PortableTextBlock } from '@portabletext/types';
import type { SanityImageSource } from '@sanity/image-url/lib/types/types';

interface ColorData {
  label?: string;
  value: string;
}

interface GradientColorData {
  colorType?: 'primary' | 'secondary' | 'accent' | 'custom';
  shade?: number;
  customColor?: ColorData;
}

interface GradientData {
  direction?: string;
  startColor?: GradientColorData;
  endColor?: GradientColorData;
}

interface ImageData {
  asset: SanityImageSource;
  alt?: string;
  hotspot?: { x: number; y: number };
  crop?: { top: number; bottom: number; left: number; right: number };
}

interface Props {
  title?: string;
  content?: PortableTextBlock[];
  images?: ImageData[];
  titleColorType?: 'primary' | 'secondary' | 'accent' | 'custom';
  titleColorShade?: number;
  titleCustomColor?: ColorData;
  textColor?: 'base' | 'muted' | 'contrast';
  backgroundColorMode?: 'solid' | 'gradient';
  backgroundColorType?:
    | 'default'
    | 'primary'
    | 'secondary'
    | 'accent'
    | 'custom';
  backgroundColorShade?: number;
  backgroundCustomColor?: ColorData;
  backgroundGradient?: GradientData;
  headingLevel?: 'h2' | 'h3';
}

const {
  title,
  content,
  images = [],
  titleColorType = 'primary',
  titleColorShade = 0,
  titleCustomColor,
  textColor = 'muted',
  backgroundColorMode = 'solid',
  backgroundColorType = 'default',
  backgroundColorShade = 95,
  backgroundCustomColor,
  backgroundGradient,
  headingLevel = 'h3',
} = Astro.props;

// Fetch site settings for colors
const settings = await client.fetch(siteSettingsQuery);
const siteColors = settings?.colors;

// Resolve background color
let backgroundColor = 'transparent';
if (backgroundColorType !== 'default') {
  backgroundColor =
    backgroundColorMode === 'gradient' && backgroundGradient
      ? `linear-gradient(${backgroundGradient.direction || '135deg'}, ${resolveColorSelection(backgroundGradient.startColor, siteColors)}, ${resolveColorSelection(backgroundGradient.endColor, siteColors)})`
      : resolveColorSelection(
          {
            colorType: backgroundColorType,
            shade: backgroundColorShade,
            customColor: backgroundCustomColor,
          },
          siteColors
        );
}

// Resolve title color
const titleColor = resolveColorSelection(
  {
    colorType: titleColorType,
    shade: titleColorShade,
    customColor: titleCustomColor,
  },
  siteColors
);

// Text color mapping
const textColorMap = {
  base: 'var(--color-text)',
  muted: 'var(--color-text-muted)',
  contrast: 'var(--color-text-contrast)',
};

const cssVars = [
  `--text-wrap-bg: ${backgroundColor}`,
  `--text-wrap-title-color: ${titleColor}`,
  `--text-wrap-text-color: ${textColorMap[textColor]}`,
].join('; ');
---

<section class="text-wrap" style={cssVars}>
  <div class="container">
    <div class="text-wrap__flow">
      {
        /* Images in a container with shape-outside for proper text wrapping around overlap */
      }
      <div class="text-wrap__images">
        {
          images.map((image, index) => (
            <figure class={`text-wrap__image text-wrap__image--${index + 1}`}>
              <Image
                image={image}
                alt={image?.alt || ''}
                sizes="(max-width: 768px) 100vw, 50vw"
              />
            </figure>
          ))
        }
      </div>

      {/* Title flows beside images (not full width) */}
      {
        title &&
          (headingLevel === 'h2' ? (
            <h2 class="text-wrap__title">{title}</h2>
          ) : (
            <h3 class="text-wrap__title">{title}</h3>
          ))
      }

      {/* Text flows around the floated images */}
      {
        content && (
          <div class="text-wrap__text">
            <PortableText content={content} />
          </div>
        )
      }
    </div>
  </div>
</section>

<style>
  .text-wrap {
    background: var(--text-wrap-bg);
  }

  .container {
    max-width: var(--container-max-width);
    margin-inline: auto;
    padding-inline: var(--container-padding);
  }

  .text-wrap__flow {
    position: relative;
    /* Clearfix to contain floated children */
    &::after {
      content: '';
      display: table;
      clear: both;
    }
  }

  /* Images container - floats right with custom shape for text wrap */
  .text-wrap__images {
    float: right;
    width: 55%;
    margin: 0 0 var(--space-md) var(--space-xl);
    /* Define stepped shape: narrower at top (image-1), wider at bottom (image-2) */
    shape-outside: polygon(
      27% 0%,
      100% 0%,
      100% 38%,
      0% 38%,
      0% 100%,
      100% 100%,
      100% 38%,
      27% 38%
    );
    shape-margin: var(--space-lg);
  }

  /* Base image styles */
  .text-wrap__image {
    border-radius: var(--border-radius-md);
    overflow: hidden;
    margin: 0;
  }

  .text-wrap__image :global(img),
  .text-wrap__image :global(.image-blur-wrapper) {
    width: 100%;
    height: 100%;
    display: block;
    object-fit: cover;
    transition: transform 0.5s ease;
  }

  .text-wrap__image:hover :global(img) {
    transform: scale(1.03);
  }

  /* Top image - narrower, aligned to right of container */
  .text-wrap__image--1 {
    width: 72.7%; /* 40% / 55% of container */
    margin-left: auto; /* Push to right */
    aspect-ratio: 4 / 3;
  }

  /* Bottom image - full width, overlaps top image */
  .text-wrap__image--2 {
    width: 100%;
    margin-top: calc(
      -1 * var(--space-md)
    ); /* Overlap upward - minimal for more visibility of top image */
    aspect-ratio: 4 / 3;
    position: relative;
    z-index: 1;
  }

  .text-wrap__title {
    font-family: var(--font-heading);
    font-size: var(--font-size-3xl);
    font-weight: var(--font-weight-normal);
    color: var(--text-wrap-title-color);
    margin: 0 0 var(--space-lg);
    line-height: 1.3;
    /* Title does NOT clear floats - it flows beside images */
  }

  .text-wrap__text {
    color: var(--text-wrap-text-color);
  }

  .text-wrap__text :global(p) {
    font-size: var(--font-size-lg);
    line-height: var(--line-height-relaxed);
    margin: 0 0 var(--space-md);
  }

  .text-wrap__text :global(p:last-child) {
    margin-bottom: 0;
  }

  /* Mobile: Stack images above text */
  @media (max-width: 768px) {
    .text-wrap__images {
      float: none;
      width: 100%;
      margin: 0 0 var(--space-xl) 0;
      shape-outside: none;
    }

    .text-wrap__image--1 {
      width: 100%;
      margin-left: 0;
    }

    .text-wrap__image--2 {
      margin-top: var(--space-md);
    }
  }
</style>

<script>
  import { gsap } from 'gsap';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';

  gsap.registerPlugin(ScrollTrigger);

  const prefersReducedMotion = window.matchMedia(
    '(prefers-reduced-motion: reduce)'
  ).matches;

  if (!prefersReducedMotion) {
    const sections = gsap.utils.toArray('.text-wrap') as HTMLElement[];
    sections.forEach((section) => {
      const title = section.querySelector('.text-wrap__title');
      const images = section.querySelectorAll('.text-wrap__image');
      const text = section.querySelector('.text-wrap__text');

      // Animate title
      if (title) {
        gsap.from(title, {
          scrollTrigger: {
            trigger: section,
            start: 'top 80%',
            once: true,
          },
          opacity: 0,
          y: 20,
          duration: 0.6,
          ease: 'power2.out',
        });
      }

      // Animate images
      if (images.length) {
        gsap.from(images, {
          scrollTrigger: {
            trigger: section,
            start: 'top 80%',
            once: true,
          },
          opacity: 0,
          x: 30,
          duration: 0.7,
          stagger: 0.15,
          delay: 0.1,
          ease: 'power2.out',
        });
      }

      // Animate text
      if (text) {
        gsap.from(text.children, {
          scrollTrigger: {
            trigger: section,
            start: 'top 80%',
            once: true,
          },
          opacity: 0,
          y: 20,
          duration: 0.6,
          stagger: 0.1,
          delay: 0.2,
          ease: 'power2.out',
        });
      }
    });
  }
</script>
