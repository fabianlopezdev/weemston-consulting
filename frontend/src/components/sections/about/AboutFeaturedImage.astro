---
/**
 * AboutFeaturedImage - Full-width image with portable text overlay
 * Text appears top-left on desktop, centered below on mobile
 * Use italic in the editor for script font styling
 */
import { PortableText } from 'astro-portabletext';
import type { PortableTextBlock } from '@portabletext/types';
import { resolveColorSelection } from '@lib/sanity/colorResolver';
import { sanityClient as client } from 'sanity:client';
import { siteSettingsQuery } from '@lib/sanity/queries';
import { urlForImage } from '@lib/sanity/image';
import type { SanityImageSource } from '@sanity/image-url/lib/types/types';

interface ColorData {
  label?: string;
  value: string;
}

interface ImageData {
  asset: SanityImageSource;
  alt?: string;
  hotspot?: { x: number; y: number };
  crop?: { top: number; bottom: number; left: number; right: number };
}

interface Props {
  image?: ImageData;
  overlayText?: PortableTextBlock[];
  textPosition?: 'left' | 'center' | 'right';
  textColorType?: 'primary' | 'secondary' | 'accent' | 'custom';
  textColorShade?: number;
  textCustomColor?: ColorData;
}

const {
  image,
  overlayText,
  textPosition = 'left',
  textColorType = 'primary',
  textColorShade = 0,
  textCustomColor,
} = Astro.props;

// Fetch site settings for colors
const settings = await client.fetch(siteSettingsQuery);
const siteColors = settings?.colors;

// Resolve text color
const textColor = resolveColorSelection(
  {
    colorType: textColorType,
    shade: textColorShade,
    customColor: textCustomColor,
  },
  siteColors
);

// Generate optimized image URL
const imageUrl = image?.asset
  ? urlForImage(image).width(1800).quality(85).auto('format').url()
  : null;
const imageAlt = image?.alt || 'Featured image';

const cssVars = [`--featured-text-color: ${textColor}`].join('; ');
---

{
  image?.asset && (
    <section class="featured-image" style={cssVars}>
      <div class="featured-image__container">
        <figure class="featured-image__photo">
          <img src={imageUrl} alt={imageAlt} loading="eager" />
          {overlayText && overlayText.length > 0 && (
            <div
              class={`featured-image__overlay featured-image__overlay--${textPosition}`}
            >
              <PortableText value={overlayText} />
            </div>
          )}
        </figure>
      </div>
    </section>
  )
}

<style>
  .featured-image {
    padding-top: var(--space-lg);
  }

  .featured-image__container {
    position: relative;
    /* Full bleed - no max-width or padding */
    max-width: none;
    margin: 0;
    padding: 0;
  }

  .featured-image__photo {
    position: relative;
    margin: 0;
    overflow: hidden;
    /* No border-radius for edge-to-edge */
    border-radius: 0;
    /* Full width, fixed height */
    width: 100%;
    height: 500px;
  }

  .featured-image__photo img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: top left;
    display: block;
  }

  /* Text overlay base styles - vertically centered */
  .featured-image__overlay {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    max-width: 50%;
    z-index: 1;
    pointer-events: none;
    text-align: center;
  }

  /* Position: Left */
  .featured-image__overlay--left {
    left: var(--space-xl);
  }

  /* Position: Center */
  .featured-image__overlay--center {
    left: 50%;
    transform: translate(-50%, -50%);
  }

  /* Position: Right */
  .featured-image__overlay--right {
    right: var(--space-xl);
    left: auto;
  }

  /* Portable text styling for overlay */
  .featured-image__overlay :global(p) {
    font-family: var(--font-heading);
    font-size: clamp(1.5rem, 3.5vw, 2.5rem);
    font-weight: var(--font-weight-normal);
    line-height: 1.3;
    color: var(--featured-text-color);
    margin: 0;
    text-shadow: 0 2px 10px rgba(255, 255, 255, 0.9);
  }

  /* Italic text renders in script font */
  .featured-image__overlay :global(em) {
    font-family: var(--font-script, 'Cormorant Garamond'), Georgia, serif;
    font-size: 1.2em;
    font-style: italic;
  }

  /* Mobile: smaller height, text still overlays */
  @media (max-width: 767px) {
    .featured-image__photo {
      height: 350px;
    }

    .featured-image__overlay {
      max-width: 70%;
    }

    .featured-image__overlay--left {
      left: var(--space-md);
    }

    .featured-image__overlay--right {
      right: var(--space-md);
    }

    .featured-image__overlay :global(p) {
      font-size: clamp(1.25rem, 5vw, 1.75rem);
    }
  }
</style>

<script>
  import { gsap } from 'gsap';

  const prefersReducedMotion = window.matchMedia(
    '(prefers-reduced-motion: reduce)'
  ).matches;

  if (!prefersReducedMotion) {
    const photo = document.querySelector('.featured-image__photo');
    const overlay = document.querySelector('.featured-image__overlay');

    // Image entrance
    if (photo) {
      gsap.from(photo, {
        opacity: 0,
        y: 30,
        scale: 0.98,
        duration: 0.8,
        ease: 'power2.out',
      });
    }

    // Text entrance
    if (overlay) {
      gsap.from(overlay, {
        opacity: 0,
        y: 20,
        duration: 0.6,
        delay: 0.3,
        ease: 'power2.out',
      });
    }
  }
</script>
