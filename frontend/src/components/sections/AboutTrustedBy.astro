---
import { resolveColorSelection } from '@lib/sanity/colorResolver';
import { sanityClient as client } from 'sanity:client';
import { siteSettingsQuery } from '@lib/sanity/queries';
import { urlForImageWithSeoFilename } from '@lib/sanity/image';

interface ColorData {
  label?: string;
  value: string;
}

interface GradientColorData {
  colorType?: 'primary' | 'secondary' | 'accent' | 'custom';
  shade?: number;
  customColor?: ColorData;
}

interface GradientData {
  direction?: string;
  startColor?: GradientColorData;
  endColor?: GradientColorData;
}

interface ClientLogo {
  asset?: {
    _id: string;
    url: string;
    metadata?: {
      dimensions?: {
        width: number;
        height: number;
        aspectRatio: number;
      };
    };
  };
  alt?: string;
  hotspot?: { x: number; y: number };
  crop?: { top: number; bottom: number; left: number; right: number };
}

interface CaseStudy {
  _id: string;
  client: string;
  clientLogo?: ClientLogo;
}

interface Props {
  title?: string;
  showTitle?: boolean;
  titleColorType?: 'primary' | 'secondary' | 'accent' | 'custom';
  titleColorShade?: number;
  titleCustomColor?: ColorData;
  caseStudies?: CaseStudy[];
  backgroundColorType?:
    | 'default'
    | 'primary'
    | 'secondary'
    | 'accent'
    | 'custom';
  backgroundColorMode?: 'solid' | 'gradient';
  backgroundColorShade?: number;
  backgroundCustomColor?: ColorData;
  backgroundGradient?: GradientData;
}

const {
  title = 'Trusted By Teams At',
  showTitle = true,
  titleColorType = 'primary',
  titleColorShade = 50,
  titleCustomColor,
  caseStudies = [],
  backgroundColorType = 'default',
  backgroundColorMode = 'solid',
  backgroundColorShade = 95,
  backgroundCustomColor,
  backgroundGradient,
} = Astro.props;

// Fetch site settings for colors
const settings = await client.fetch(siteSettingsQuery);
const siteColors = settings?.colors;

// Resolve background color
const backgroundColor =
  backgroundColorType === 'default'
    ? null
    : backgroundColorMode === 'gradient' && backgroundGradient
      ? `linear-gradient(${backgroundGradient.direction || '135deg'}, ${resolveColorSelection(backgroundGradient.startColor, siteColors)}, ${resolveColorSelection(backgroundGradient.endColor, siteColors)})`
      : resolveColorSelection(
          {
            colorType: backgroundColorType,
            shade: backgroundColorShade,
            customColor: backgroundCustomColor,
          },
          siteColors
        );

// Resolve title color
const titleColor = resolveColorSelection(
  {
    colorType: titleColorType,
    shade: titleColorShade,
    customColor: titleCustomColor,
  },
  siteColors
);

const cssVars = [
  backgroundColor ? `--trusted-by-bg: ${backgroundColor}` : null,
  `--trusted-by-title-color: ${titleColor}`,
]
  .filter(Boolean)
  .join('; ');

// Filter case studies that have logos
const caseStudiesWithLogos = caseStudies?.filter(
  (cs) => cs.clientLogo?.asset
) || [];
---

{
  caseStudiesWithLogos.length > 0 && (
    <section class="about-trusted-by" style={cssVars}>
      <div class="container">
        {showTitle && title && (
          <p class="about-trusted-by__title">{title}</p>
        )}
        <div class="about-trusted-by__logos">
          {caseStudiesWithLogos.map((caseStudy) => {
            const logoUrl = caseStudy.clientLogo?.asset
              ? urlForImageWithSeoFilename(
                  caseStudy.clientLogo as {
                    asset?: { _ref?: string };
                    alt?: string;
                    seoFilename?: string;
                  },
                  { height: 60, quality: 90 }
                )
              : null;

            return (
              logoUrl && (
                <div class="about-trusted-by__logo-wrapper">
                  <img
                    src={logoUrl}
                    alt={caseStudy.clientLogo?.alt || `${caseStudy.client} logo`}
                    class="about-trusted-by__logo"
                    loading="lazy"
                    decoding="async"
                  />
                </div>
              )
            );
          })}
        </div>
      </div>
    </section>
  )
}

<style>
  .about-trusted-by {
    background: var(--trusted-by-bg, var(--color-background-muted, #f8fafc));
    padding: clamp(2rem, 4vw, 3rem) 0;
    border-top: 1px solid var(--color-border, #e2e8f0);
    border-bottom: 1px solid var(--color-border, #e2e8f0);
  }

  .about-trusted-by__title {
    text-align: center;
    color: var(--trusted-by-title-color, var(--color-text-muted));
    font-size: 0.875rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin: 0 0 2rem;
  }

  .about-trusted-by__logos {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    align-items: center;
    gap: 2rem 3rem;
  }

  @media (min-width: 768px) {
    .about-trusted-by__logos {
      gap: 2rem 4rem;
    }
  }

  .about-trusted-by__logo-wrapper {
    opacity: 0.7;
    transition: opacity 0.2s ease;
  }

  .about-trusted-by__logo-wrapper:hover {
    opacity: 1;
  }

  .about-trusted-by__logo {
    height: 40px;
    width: auto;
    object-fit: contain;
    filter: grayscale(100%);
    transition: filter 0.2s ease;
  }

  .about-trusted-by__logo-wrapper:hover .about-trusted-by__logo {
    filter: grayscale(0%);
  }

  @media (min-width: 768px) {
    .about-trusted-by__logo {
      height: 48px;
    }
  }
</style>

<script>
  import { setupAnimationLifecycle, gsap } from '@lib/animation/utils';
  import { ANIMATION_CONFIG } from '@lib/animation/config';

  setupAnimationLifecycle(() => {
    const section = document.querySelector('.about-trusted-by');
    const title = document.querySelector('.about-trusted-by__title');
    const logos = document.querySelectorAll('.about-trusted-by__logo-wrapper');

    if (!section) return;

    // Initial states
    if (title) gsap.set(title, { opacity: 0, y: 15 });
    gsap.set(logos, { opacity: 0, y: 20 });

    // Create timeline
    const tl = gsap.timeline({
      scrollTrigger: {
        trigger: section,
        start: 'top 85%',
        once: true,
        markers: ANIMATION_CONFIG.scrollTrigger.markers,
      },
    });

    // Title fades in
    if (title) {
      tl.to(title, {
        opacity: 1,
        y: 0,
        duration: 0.5,
        ease: 'power2.out',
      });
    }

    // Logos stagger in
    if (logos.length > 0) {
      tl.to(
        logos,
        {
          opacity: 0.7, // Match the default opacity
          y: 0,
          duration: 0.4,
          ease: 'power2.out',
          stagger: 0.08,
        },
        '-=0.2'
      );
    }
  });
</script>
