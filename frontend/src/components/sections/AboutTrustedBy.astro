---
import { resolveColorSelection } from '@lib/sanity/colorResolver';
import { sanityClient as client } from 'sanity:client';
import { siteSettingsQuery } from '@lib/sanity/queries';
import { urlForImageWithSeoFilename } from '@lib/sanity/image';
import { slugify } from '@lib/utils/url';

interface ColorData {
  label?: string;
  value: string;
}

interface GradientColorData {
  colorType?: 'primary' | 'secondary' | 'accent' | 'custom';
  shade?: number;
  customColor?: ColorData;
}

interface GradientData {
  direction?: string;
  startColor?: GradientColorData;
  endColor?: GradientColorData;
}

interface ClientLogo {
  asset?: {
    _id: string;
    url: string;
    metadata?: {
      dimensions?: {
        width: number;
        height: number;
        aspectRatio: number;
      };
    };
  };
  alt?: string;
  hotspot?: { x: number; y: number };
  crop?: { top: number; bottom: number; left: number; right: number };
}

interface CaseStudy {
  _id: string;
  client: string;
  clientLogo?: ClientLogo;
}

interface Props {
  title?: string;
  showTitle?: boolean;
  titleColorType?: 'primary' | 'secondary' | 'accent' | 'custom';
  titleColorShade?: number;
  titleCustomColor?: ColorData;
  caseStudies?: CaseStudy[];
  backgroundColorType?:
    | 'default'
    | 'primary'
    | 'secondary'
    | 'accent'
    | 'custom';
  backgroundColorMode?: 'solid' | 'gradient';
  backgroundColorShade?: number;
  backgroundCustomColor?: ColorData;
  backgroundGradient?: GradientData;
}

const {
  title = 'Trusted By Teams At',
  showTitle = true,
  titleColorType = 'primary',
  titleColorShade = 50,
  titleCustomColor,
  caseStudies = [],
  backgroundColorType = 'default',
  backgroundColorMode = 'solid',
  backgroundColorShade = 95,
  backgroundCustomColor,
  backgroundGradient,
} = Astro.props;

// Fetch site settings for colors
const settings = await client.fetch(siteSettingsQuery);
const siteColors = settings?.colors;

// Resolve background color
const backgroundColor =
  backgroundColorType === 'default'
    ? null
    : backgroundColorMode === 'gradient' && backgroundGradient
      ? `linear-gradient(${backgroundGradient.direction || '135deg'}, ${resolveColorSelection(backgroundGradient.startColor, siteColors)}, ${resolveColorSelection(backgroundGradient.endColor, siteColors)})`
      : resolveColorSelection(
          {
            colorType: backgroundColorType,
            shade: backgroundColorShade,
            customColor: backgroundCustomColor,
          },
          siteColors
        );

// Resolve title color
const titleColor = resolveColorSelection(
  {
    colorType: titleColorType,
    shade: titleColorShade,
    customColor: titleCustomColor,
  },
  siteColors
);

const cssVars = [
  backgroundColor ? `--trusted-by-bg: ${backgroundColor}` : null,
  `--trusted-by-title-color: ${titleColor}`,
]
  .filter(Boolean)
  .join('; ');

// Filter case studies that have logos
const caseStudiesWithLogos =
  caseStudies?.filter((cs) => cs.clientLogo?.asset) || [];
---

{
  caseStudiesWithLogos.length > 0 && (
    <section class="about-trusted-by" style={cssVars}>
      {showTitle && title && (
        <div class="container">
          <p class="about-trusted-by__title">{title}</p>
        </div>
      )}
      <div class="about-trusted-by__marquee">
        <div class="about-trusted-by__track">
          {/* First set of logos */}
          {caseStudiesWithLogos.map((caseStudy) => {
            const logoUrl = caseStudy.clientLogo?.asset
              ? urlForImageWithSeoFilename(
                  caseStudy.clientLogo as {
                    asset?: { _ref?: string };
                    alt?: string;
                    seoFilename?: string;
                  },
                  { height: 60, quality: 90 }
                )
              : null;

            return (
              logoUrl && (
                <a
                  href={`/case-studies#${slugify(caseStudy.client || '')}`}
                  class="about-trusted-by__logo-wrapper"
                  title={`View ${caseStudy.client} case study`}
                >
                  <img
                    src={logoUrl}
                    alt={
                      caseStudy.clientLogo?.alt || `${caseStudy.client} logo`
                    }
                    class="about-trusted-by__logo"
                    loading="lazy"
                    decoding="async"
                  />
                </a>
              )
            );
          })}
          {/* Duplicate set for seamless loop */}
          {caseStudiesWithLogos.map((caseStudy) => {
            const logoUrl = caseStudy.clientLogo?.asset
              ? urlForImageWithSeoFilename(
                  caseStudy.clientLogo as {
                    asset?: { _ref?: string };
                    alt?: string;
                    seoFilename?: string;
                  },
                  { height: 60, quality: 90 }
                )
              : null;

            return (
              logoUrl && (
                <a
                  href={`/case-studies#${slugify(caseStudy.client || '')}`}
                  class="about-trusted-by__logo-wrapper"
                  aria-hidden="true"
                  tabindex="-1"
                >
                  <img
                    src={logoUrl}
                    alt=""
                    class="about-trusted-by__logo"
                    loading="lazy"
                    decoding="async"
                  />
                </a>
              )
            );
          })}
        </div>
      </div>
    </section>
  )
}

<style>
  .about-trusted-by {
    --marquee-speed: 30s;
    --marquee-gap: 4rem;

    background: var(--trusted-by-bg, var(--color-background-muted, #f8fafc));
    padding: clamp(2rem, 4vw, 3rem) 0;
    border-top: 1px solid var(--color-border, #e2e8f0);
    border-bottom: 1px solid var(--color-border, #e2e8f0);
    overflow: hidden;
  }

  .about-trusted-by :global(.container) {
    display: flex;
    justify-content: center;
  }

  .about-trusted-by__title {
    text-align: center;
    color: var(--trusted-by-title-color, var(--color-text-muted));
    font-size: 0.875rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin: 0 0 1.5rem;
  }

  .about-trusted-by__marquee {
    position: relative;
    width: 100%;
    overflow: hidden;
    /* Fade edges for smooth visual transition */
    mask-image: linear-gradient(
      to right,
      transparent 0%,
      black 10%,
      black 90%,
      transparent 100%
    );
    -webkit-mask-image: linear-gradient(
      to right,
      transparent 0%,
      black 10%,
      black 90%,
      transparent 100%
    );
  }

  .about-trusted-by__track {
    display: flex;
    align-items: center;
    gap: var(--marquee-gap);
    width: max-content;
    animation: marquee-scroll var(--marquee-speed) linear infinite;
  }

  /* Pause animation on hover for accessibility */
  .about-trusted-by__marquee:hover .about-trusted-by__track {
    animation-play-state: paused;
  }

  @keyframes marquee-scroll {
    0% {
      transform: translateX(0);
    }
    100% {
      transform: translateX(calc(-50% - var(--marquee-gap) / 2));
    }
  }

  .about-trusted-by__logo-wrapper {
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0.6;
    cursor: pointer;
    text-decoration: none;
    transition:
      opacity 0.3s ease,
      transform 0.3s ease;
  }

  .about-trusted-by__logo-wrapper:hover {
    opacity: 1;
    transform: scale(1.05);
  }

  .about-trusted-by__logo-wrapper:focus-visible {
    outline: 2px solid var(--color-accent, #0066cc);
    outline-offset: 4px;
    border-radius: 4px;
    opacity: 1;
  }

  .about-trusted-by__logo {
    height: 36px;
    width: auto;
    object-fit: contain;
    filter: grayscale(100%);
    transition: filter 0.3s ease;
  }

  .about-trusted-by__logo-wrapper:hover .about-trusted-by__logo {
    filter: grayscale(0%);
  }

  @media (min-width: 768px) {
    .about-trusted-by {
      --marquee-gap: 5rem;
    }

    .about-trusted-by__logo {
      height: 44px;
    }
  }

  @media (min-width: 1024px) {
    .about-trusted-by {
      --marquee-gap: 6rem;
    }

    .about-trusted-by__logo {
      height: 48px;
    }
  }

  /* Respect reduced motion preferences */
  @media (prefers-reduced-motion: reduce) {
    .about-trusted-by__track {
      animation: none;
    }

    .about-trusted-by__marquee {
      mask-image: none;
      -webkit-mask-image: none;
      overflow-x: auto;
      padding: 0 1rem;
    }
  }
</style>

<script>
  import { setupAnimationLifecycle, gsap } from '@lib/animation/utils';
  import { ANIMATION_CONFIG } from '@lib/animation/config';

  setupAnimationLifecycle(() => {
    const section = document.querySelector('.about-trusted-by');
    const title = document.querySelector('.about-trusted-by__title');
    const marquee = document.querySelector('.about-trusted-by__marquee');

    if (!section) return;

    // Initial states
    if (title) gsap.set(title, { opacity: 0, y: 15 });
    if (marquee) gsap.set(marquee, { opacity: 0 });

    // Create timeline
    const tl = gsap.timeline({
      scrollTrigger: {
        trigger: section,
        start: 'top 85%',
        once: true,
        markers: ANIMATION_CONFIG.scrollTrigger.markers,
      },
    });

    // Title fades in
    if (title) {
      tl.to(title, {
        opacity: 1,
        y: 0,
        duration: 0.5,
        ease: 'power2.out',
      });
    }

    // Marquee fades in
    if (marquee) {
      tl.to(
        marquee,
        {
          opacity: 1,
          duration: 0.6,
          ease: 'power2.out',
        },
        title ? '-=0.3' : 0
      );
    }
  });
</script>
