---
import { urlForImage } from '@lib/sanity/image';

interface CollageImage {
  _key: string;
  asset: any;
  alt: string;
  hotspot?: { x: number; y: number };
}

interface Props {
  enabled?: boolean;
  tagline: string;
  taglineSize?: 'medium' | 'large' | 'xlarge';
  images: CollageImage[];
  overlayStyle?: 'frosted' | 'gradient' | 'solid';
  overlayOpacity?: number;
}

const {
  tagline,
  taglineSize = 'large',
  images = [],
  overlayStyle = 'frosted',
  overlayOpacity = 60,
} = Astro.props;

// Generate optimized image URLs
const imageUrls = images.map((img) => ({
  url: urlForImage(img).width(800).height(450).url(),
  alt: img.alt || '',
  hotspot: img.hotspot,
}));

// Duplicate images for seamless infinite scroll effect
const duplicatedImages = [...imageUrls, ...imageUrls];

// Calculate card styles based on settings (now applied to the floating card, not full overlay)
const getCardStyles = () => {
  const opacity = overlayOpacity / 100;

  switch (overlayStyle) {
    case 'frosted':
      return `
        background: rgba(12, 12, 12, ${opacity * 0.4});
        backdrop-filter: blur(20px) saturate(1.3);
        -webkit-backdrop-filter: blur(20px) saturate(1.3);
      `;
    case 'gradient':
      return `
        background: linear-gradient(
          135deg,
          rgba(8, 8, 8, ${opacity * 0.85}) 0%,
          rgba(20, 20, 20, ${opacity * 0.7}) 100%
        );
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
      `;
    case 'solid':
    default:
      return `background: rgba(10, 10, 10, ${opacity * 0.85});`;
  }
};

const taglineSizeClass = `collage__tagline--${taglineSize}`;
---

<section class="collage" data-overlay-style={overlayStyle}>
  <div class="collage__track">
    {
      duplicatedImages.map((img, index) => (
        <div
          class="collage__image-wrapper"
          data-index={index % imageUrls.length}
          style={
            img.hotspot
              ? `--hotspot-x: ${img.hotspot.x * 100}%; --hotspot-y: ${img.hotspot.y * 100}%;`
              : ''
          }
        >
          <img
            src={img.url}
            alt={img.alt}
            class="collage__image"
            loading="lazy"
            decoding="async"
          />
        </div>
      ))
    }
  </div>

  <!-- Subtle vignette gradients at edges for depth -->
  <div class="collage__vignette"></div>

  <!-- Soft blur covering entire collage -->
  <div class="collage__blur-overlay"></div>

  <div class="collage__overlay">
    <div class="collage__content" style={getCardStyles()}>
      <p class={`collage__tagline ${taglineSizeClass}`}>
        <span class="collage__tagline-text">{tagline}</span>
      </p>
    </div>
  </div>

  <!-- Decorative accent lines -->
  <div class="collage__accent collage__accent--top"></div>
  <div class="collage__accent collage__accent--bottom"></div>
</section>

<style>
  .collage {
    --collage-height: clamp(280px, 35vh, 420px);
    --image-gap: 0;
    --accent-color: var(--color-accent, #c9a87c);

    position: relative;
    height: var(--collage-height);
    overflow: hidden;
    background: #0a0a0a;
  }

  .collage__track {
    display: flex;
    gap: var(--image-gap);
    height: 100%;
    will-change: transform;
  }

  .collage__image-wrapper {
    flex: 0 0 auto;
    height: 100%;
    aspect-ratio: 16 / 9;
    overflow: hidden;
    position: relative;
  }

  .collage__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: var(--hotspot-x, 50%) var(--hotspot-y, 50%);
    will-change: transform;
    transform: scale(1.1);
    filter: grayscale(0.15) contrast(1.05);
    transition: filter 0.6s ease;
  }

  /* Subtle vignette on each image */
  .collage__image-wrapper::after {
    content: '';
    position: absolute;
    inset: 0;
    background: radial-gradient(
      ellipse at center,
      transparent 50%,
      rgba(0, 0, 0, 0.1) 100%
    );
    pointer-events: none;
  }

  /* Edge vignettes for depth without obscuring images */
  .collage__vignette {
    position: absolute;
    inset: 0;
    z-index: 1;
    pointer-events: none;
    background:
      linear-gradient(to bottom, rgba(0, 0, 0, 0.3) 0%, transparent 15%),
      linear-gradient(to top, rgba(0, 0, 0, 0.4) 0%, transparent 20%);
  }

  /* Soft blur covering entire collage - sits above images but below content */
  .collage__blur-overlay {
    position: absolute;
    inset: 0;
    z-index: 1.5; /* Between vignette (1) and overlay (2) */
    pointer-events: none;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    background: rgba(10, 10, 10, 0.05); /* Subtle tint to enhance blur */
  }

  .collage__overlay {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2;
    /* No background/blur here - it's on the card */
    padding: var(--space-md);
  }

  /* Floating glass card - the star of the show */
  .collage__content {
    text-align: center;
    padding: clamp(2rem, 5vw, 4rem) clamp(4rem, 10vw, 8rem);
    max-width: min(900px, 95%);
    border-radius: 1rem;
    box-shadow:
      0 8px 32px rgba(0, 0, 0, 0.3),
      0 2px 8px rgba(0, 0, 0, 0.15);
    position: relative;
    overflow: hidden;
    /* Edge fade on all sides */
    mask-image:
      linear-gradient(
        to right,
        transparent 0%,
        black 10%,
        black 90%,
        transparent 100%
      ),
      linear-gradient(
        to bottom,
        transparent 0%,
        black 15%,
        black 85%,
        transparent 100%
      );
    mask-composite: intersect;
    -webkit-mask-image:
      linear-gradient(
        to right,
        transparent 0%,
        black 10%,
        black 90%,
        transparent 100%
      ),
      linear-gradient(
        to bottom,
        transparent 0%,
        black 15%,
        black 85%,
        transparent 100%
      );
    -webkit-mask-composite: source-in;
  }

  /* Subtle shine effect on the card */
  .collage__content::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(
      90deg,
      transparent,
      rgba(255, 255, 255, 0.03),
      transparent
    );
    transition: left 0.8s ease;
  }

  .collage__content:hover::before {
    left: 100%;
  }

  .collage__tagline {
    margin: 0;
    font-family: var(--font-heading);
    font-weight: 400;
    line-height: 1.2;
    color: #ffffff;
    letter-spacing: -0.01em;
    text-shadow:
      0 2px 20px rgba(0, 0, 0, 0.5),
      0 4px 40px rgba(0, 0, 0, 0.3);
  }

  .collage__tagline--medium {
    font-size: clamp(1.5rem, 4vw, 2rem);
  }

  .collage__tagline--large {
    font-size: clamp(1.75rem, 5vw, 2.75rem);
  }

  .collage__tagline--xlarge {
    font-size: clamp(2rem, 6vw, 3.5rem);
  }

  .collage__tagline-text {
    display: inline;
    background: linear-gradient(
      135deg,
      #ffffff 0%,
      rgba(255, 255, 255, 0.92) 50%,
      #ffffff 100%
    );
    background-clip: text;
    -webkit-background-clip: text;
    opacity: 0;
    transform: translateY(20px) translateZ(0);
    will-change: transform, opacity;
  }

  /* GPU acceleration for animated card */
  .collage__content {
    will-change: transform, opacity;
    transform: translateZ(0);
  }

  /* Decorative accent lines */
  .collage__accent {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    width: 60px;
    height: 1px;
    background: linear-gradient(
      90deg,
      transparent,
      var(--accent-color),
      transparent
    );
    opacity: 0;
    z-index: 3;
  }

  .collage__accent--top {
    top: var(--space-md);
  }

  .collage__accent--bottom {
    bottom: var(--space-md);
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .collage {
      --collage-height: clamp(240px, 35vh, 340px);
    }

    .collage__content {
      padding: var(--space-md) var(--space-md);
      border-radius: 0.75rem;
    }

    .collage__image-wrapper {
      aspect-ratio: 4 / 3;
    }

    .collage__vignette {
      background:
        linear-gradient(to bottom, rgba(0, 0, 0, 0.35) 0%, transparent 20%),
        linear-gradient(to top, rgba(0, 0, 0, 0.45) 0%, transparent 25%);
    }
  }

  /* Reduced motion preference */
  @media (prefers-reduced-motion: reduce) {
    .collage__image {
      transform: none;
    }

    .collage__tagline-text {
      opacity: 1;
      transform: none;
    }
  }
</style>

<script>
  import {
    setupAnimationLifecycle,
    gsap,
    ANIMATION_CONFIG,
  } from '@lib/animation';

  setupAnimationLifecycle(() => {
    const sections = document.querySelectorAll('.collage');

    sections.forEach((section) => {
      const track = section.querySelector('.collage__track') as HTMLElement;
      const images = section.querySelectorAll('.collage__image');
      const taglineText = section.querySelector('.collage__tagline-text');
      const accents = section.querySelectorAll('.collage__accent');

      if (!track) return;

      // Calculate the width needed for seamless loop
      const imageWrappers = track.querySelectorAll('.collage__image-wrapper');
      const singleSetWidth = Array.from(imageWrappers)
        .slice(0, imageWrappers.length / 2)
        .reduce(
          (acc, wrapper) => acc + (wrapper as HTMLElement).offsetWidth,
          0
        );

      // Entrance animation timeline - delay until section is fully visible
      const entranceTl = gsap.timeline({
        scrollTrigger: {
          trigger: section,
          start: 'center 60%',
          end: 'center 40%',
          scrub: 1.5, // Smoother updates
          markers: ANIMATION_CONFIG.scrollTrigger.markers,
        },
      });

      // Animate floating card with scale and opacity
      const contentCard = section.querySelector('.collage__content');
      if (contentCard) {
        gsap.set(contentCard, { scale: 0.95, opacity: 0, force3D: true });
        entranceTl.to(
          contentCard,
          {
            scale: 1,
            opacity: 1,
            duration: 1,
            ease: 'power2.out',
            force3D: true,
          },
          0
        );
      }

      // Fade in tagline with elegant reveal - use force3D for GPU acceleration
      entranceTl.to(
        taglineText,
        {
          opacity: 1,
          y: 0,
          duration: 1,
          ease: 'power3.out',
          force3D: true,
        },
        0.1
      );

      // Fade in accent lines
      entranceTl.to(
        accents,
        {
          opacity: 0.6,
          duration: 0.8,
          stagger: 0.1,
          ease: 'power2.out',
        },
        0.3
      );

      // Horizontal scroll parallax - images move left as you scroll down
      gsap.to(track, {
        x: -singleSetWidth * 0.3, // Move 30% of one set
        ease: 'none',
        scrollTrigger: {
          trigger: section,
          start: 'top bottom',
          end: 'bottom top',
          scrub: 0.5,
          markers: ANIMATION_CONFIG.scrollTrigger.markers,
        },
      });

      // Subtle Ken Burns effect on individual images
      images.forEach((img, index) => {
        const direction = index % 2 === 0 ? 1 : -1;
        const scaleStart = 1.1;
        const scaleEnd = 1.15 + (index % 3) * 0.02;

        gsap.fromTo(
          img,
          {
            scale: scaleStart,
            x: direction * 5,
          },
          {
            scale: scaleEnd,
            x: direction * -5,
            ease: 'none',
            scrollTrigger: {
              trigger: section,
              start: 'top bottom',
              end: 'bottom top',
              scrub: 1.5,
              markers: ANIMATION_CONFIG.scrollTrigger.markers,
            },
          }
        );
      });

      // Note: Removed overlay parallax animation to prevent height mismatch
    });
  });
</script>
