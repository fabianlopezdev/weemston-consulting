---
import { Icon } from 'astro-icon/components';
import { urlForImage } from '@lib/sanity/image';
import {
  resolveColorSelection,
  resolveButtonColor,
  resolveButtonTextColor,
} from '@lib/sanity/colorResolver';
import { resolveLinkUrl } from '@lib/sanity/linkResolver';
import { sanityClient as client } from 'sanity:client';
import { siteSettingsQuery } from '@lib/sanity/queries';

interface IconData {
  name: string;
}

interface ImageData {
  asset: any;
  alt?: string;
}

interface IconOrImage {
  type: 'icon' | 'image';
  icon?: IconData;
  image?: ImageData;
}

interface ExperienceCard {
  _key: string;
  number: string;
  title: string;
  description: string;
  iconOrImage: IconOrImage;
  iconBackgroundColorType?: 'primary' | 'secondary' | 'accent' | 'custom';
  iconBackgroundColorShade?: number;
  iconBackgroundCustomColor?: ColorData;
}

interface ColorData {
  label?: string;
  value: string;
}

interface LinkData {
  linkType: 'internal' | 'external';
  internalPageType?: string;
  serviceReference?: { slug: { current: string } };
  caseStudyReference?: { slug: { current: string } };
  legalReference?: { slug: { current: string } };
  externalUrl?: string;
  text: string;
  openInNewTab?: boolean;
  buttonColor?: any;
}

interface Props {
  title: string;
  description?: string;
  cards: ExperienceCard[];
  // Color settings
  descriptionColor?: 'base' | 'contrast';
  backgroundColorType?: 'primary' | 'secondary' | 'accent' | 'custom';
  backgroundColorShade?: number;
  backgroundCustomColor?: ColorData;
  selectedItemColorType?: 'primary' | 'secondary' | 'accent' | 'custom';
  selectedItemColorShade?: number;
  selectedItemCustomColor?: ColorData;
  cardDescriptionColor?: 'base' | 'contrast';
  ctaButton?: LinkData;
}

const {
  title,
  description,
  cards,
  descriptionColor = 'base',
  backgroundColorType = 'default',
  backgroundColorShade = 0,
  backgroundCustomColor,
  selectedItemColorType = 'accent',
  selectedItemColorShade = 0,
  selectedItemCustomColor,
  cardDescriptionColor = 'base',
  ctaButton,
} = Astro.props;

// Fetch site settings for colors
const settings = await client.fetch(siteSettingsQuery);
const siteColors = settings?.colors;

// Resolve background color (null if default)
const backgroundColor =
  backgroundColorType === 'default' || !backgroundColorType
    ? null
    : resolveColorSelection(
        {
          colorType: backgroundColorType,
          shade: backgroundColorShade,
          customColor: backgroundCustomColor,
        },
        siteColors
      );

// Resolve selected item color
const selectedItemBgColor = resolveColorSelection(
  {
    colorType: selectedItemColorType,
    shade: selectedItemColorShade,
    customColor: selectedItemCustomColor,
  },
  siteColors
);

// Resolve CTA button
const ctaHref = ctaButton ? resolveLinkUrl(ctaButton) : null;
const ctaOpenInNewTab =
  ctaButton?.openInNewTab || ctaButton?.linkType === 'external';
const ctaBgColor = ctaButton
  ? resolveButtonColor(ctaButton.buttonColor, siteColors)
  : null;
const ctaTextColor = ctaButton
  ? resolveButtonTextColor(ctaButton.buttonColor)
  : null;

// Generate image URLs - use larger size for the new layout
const cardImages = cards.map((card) => {
  const hasImage = card.iconOrImage?.type === 'image' && card.iconOrImage.image;
  return hasImage && card.iconOrImage?.image
    ? urlForImage(card.iconOrImage.image).width(800).height(600).url()
    : null;
});

// Resolve icon background colors for each card
const cardIconBgColors = cards.map((card) => {
  if (card.iconOrImage?.type !== 'icon') return null;

  // For custom color or when no selection, use custom color or fallback to original
  if (
    !card.iconBackgroundColorType ||
    card.iconBackgroundColorType === 'custom'
  ) {
    return card.iconBackgroundCustomColor?.value || null;
  }

  return resolveColorSelection(
    {
      colorType: card.iconBackgroundColorType,
      shade: card.iconBackgroundColorShade ?? 500,
      customColor: card.iconBackgroundCustomColor,
    },
    siteColors
  );
});

// Define CSS variables for dynamic colors
const cssVars: Record<string, string> = {
  '--experience-desc-color':
    descriptionColor === 'contrast'
      ? 'var(--color-text-contrast)'
      : 'var(--color-text-muted)',
  '--experience-selected-bg': selectedItemBgColor,
  '--experience-card-desc-color':
    cardDescriptionColor === 'contrast'
      ? 'var(--color-text-contrast)'
      : 'var(--color-text-muted)',
};

// Only set background if not default
if (backgroundColor) {
  cssVars['--experience-bg'] = backgroundColor;
}

const cssVarsString = Object.entries(cssVars)
  .map(([key, value]) => `${key}: ${value}`)
  .join('; ');
---

<section class="experience-section" style={cssVarsString}>
  <div class="experience-section__container">
    <!-- Header -->
    <header class="experience-section__header">
      <h2 class="experience-section__title">{title}</h2>
      {
        description && (
          <p class="experience-section__description">{description}</p>
        )
      }
    </header>

    <!-- Desktop: Two-column layout -->
    <div class="experience-section__content">
      <!-- Left Column: Navigation Items -->
      <nav class="experience-nav" aria-label="Service navigation">
        {
          cards.map((card, index) => (
            <button
              type="button"
              class="experience-nav__item"
              data-index={index}
              data-active={index === 0 ? 'true' : 'false'}
              aria-pressed={index === 0 ? 'true' : 'false'}
            >
              <span class="experience-nav__number">{card.number}</span>
              <span class="experience-nav__title">{card.title}</span>
            </button>
          ))
        }
      </nav>

      <!-- Right Column: Detail Cards -->
      <div class="experience-cards-wrapper">
        <div class="experience-cards">
          {
            cards.map((card, index) => (
              <article
                class="experience-card"
                data-index={index}
                data-active={index === 0 ? 'true' : 'false'}
                aria-hidden={index !== 0 ? 'true' : 'false'}
              >
                <div class="experience-card__image-wrapper">
                  {cardImages[index] ? (
                    <img
                      src={cardImages[index]}
                      alt={card.iconOrImage?.image?.alt || card.title}
                      class="experience-card__image"
                      loading="lazy"
                    />
                  ) : (
                    <div
                      class="experience-card__image-placeholder"
                      style={
                        cardIconBgColors[index]
                          ? `--icon-bg: ${cardIconBgColors[index]}`
                          : undefined
                      }
                    >
                      {card.iconOrImage?.type === 'icon' &&
                        card.iconOrImage.icon?.name && (
                          <Icon name={card.iconOrImage.icon.name} is:inline />
                        )}
                    </div>
                  )}
                </div>
                <div class="experience-card__content">
                  <h3 class="experience-card__title">{card.title}</h3>
                  <p class="experience-card__description">{card.description}</p>
                </div>
              </article>
            ))
          }
        </div>
        {
          ctaButton && ctaHref && (
            <a
              href={ctaHref}
              class="experience-section__cta"
              style={
                ctaBgColor || ctaTextColor
                  ? `${ctaBgColor ? `background: ${ctaBgColor};` : ''} ${ctaTextColor ? `color: ${ctaTextColor};` : ''}`.trim()
                  : undefined
              }
              target={ctaOpenInNewTab ? '_blank' : undefined}
              rel={ctaOpenInNewTab ? 'noopener noreferrer' : undefined}
            >
              {ctaButton.text}
            </a>
          )
        }
      </div>
    </div>

    <!-- Mobile: Accordion layout -->
    <div class="experience-accordion">
      {
        cards.map((card, index) => (
          <div
            class="experience-accordion__item"
            data-index={index}
            data-active={index === 0 ? 'true' : 'false'}
          >
            <button
              type="button"
              class="experience-accordion__header"
              aria-expanded={index === 0 ? 'true' : 'false'}
            >
              <span class="experience-accordion__number">{card.number}</span>
              <span class="experience-accordion__title">{card.title}</span>
              <span class="experience-accordion__icon" aria-hidden="true">
                +
              </span>
            </button>
            <div class="experience-accordion__content">
              <div class="experience-accordion__image-wrapper">
                {cardImages[index] ? (
                  <img
                    src={cardImages[index]}
                    alt={card.iconOrImage?.image?.alt || card.title}
                    class="experience-accordion__image"
                    loading="lazy"
                  />
                ) : (
                  <div
                    class="experience-accordion__image-placeholder"
                    style={
                      cardIconBgColors[index]
                        ? `--icon-bg: ${cardIconBgColors[index]}`
                        : undefined
                    }
                  >
                    {card.iconOrImage?.type === 'icon' &&
                      card.iconOrImage.icon?.name && (
                        <Icon name={card.iconOrImage.icon.name} is:inline />
                      )}
                  </div>
                )}
              </div>
              <p class="experience-accordion__description">
                {card.description}
              </p>
              {ctaButton && ctaHref && (
                <a
                  href={ctaHref}
                  class="experience-accordion__cta"
                  style={
                    ctaBgColor || ctaTextColor
                      ? `${ctaBgColor ? `background: ${ctaBgColor};` : ''} ${ctaTextColor ? `color: ${ctaTextColor};` : ''}`.trim()
                      : undefined
                  }
                  target={ctaOpenInNewTab ? '_blank' : undefined}
                  rel={ctaOpenInNewTab ? 'noopener noreferrer' : undefined}
                >
                  {ctaButton.text}
                </a>
              )}
            </div>
          </div>
        ))
      }
    </div>
  </div>
</section>

<style>
  /* ========================================
     BASE SECTION STYLES
     ======================================== */
  .experience-section {
    padding: var(--space-2xl) 0;
    background: var(--experience-bg, var(--color-background, #ffffff));
  }

  .experience-section__container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 var(--space-lg, 2rem);
  }

  /* ========================================
     HEADER STYLES
     ======================================== */
  .experience-section__header {
    text-align: center;
    margin-block-end: var(--space-2xl, 4rem);
  }

  .experience-section__title {
    font-family: var(--font-serif, Georgia, serif);
    font-size: clamp(2rem, 5vw, 3.5rem);
    font-weight: 400;
    color: var(--color-accent);
    margin: 0 0 var(--space-md, 1rem) 0;
    line-height: 1.2;
  }

  .experience-section__description {
    font-size: var(--font-size-lg, 1.125rem);
    color: var(--experience-desc-color, var(--color-text-muted, #94877c));
    max-width: 700px;
    margin: 0 auto;
    line-height: 1.6;
  }

  /* ========================================
     DESKTOP: TWO-COLUMN LAYOUT
     ======================================== */
  .experience-section__content {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-2xl, 4rem);
    align-items: start;
  }

  /* ----------------------------------------
     Left Column: Navigation
     ---------------------------------------- */
  .experience-nav {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm, 0.5rem);
  }

  .experience-nav__item {
    display: flex;
    align-items: baseline;
    gap: var(--space-sm, 0.5rem);
    padding: 16px 32px 20px 16px;
    border: none;
    border-radius: 24px;
    background: transparent;
    cursor: pointer;
    text-align: left;
    transition:
      background-color 0.3s ease,
      padding 0.3s ease;
  }

  .experience-nav__item[data-active='true'] {
    background: var(--experience-selected-bg, var(--color-accent, #4ecdc4));
    padding-left: 32px;
  }

  .experience-nav__item:focus-visible {
    outline: 2px solid var(--color-primary, #2b180a);
    outline-offset: 2px;
  }

  .experience-nav__title {
    font-family: var(--font-serif, Georgia, serif);
    font-size: clamp(2.5rem, 4vw, 3.5rem);
    font-weight: 400;
    color: var(--color-text-muted, #94877c);
    transition: color 0.3s ease;
    line-height: 1.1;
  }

  .experience-nav__item[data-active='true'] .experience-nav__title {
    color: white;
  }

  .experience-nav__number {
    font-family: var(--font-serif, Georgia, serif);
    font-size: clamp(2.5rem, 4vw, 3.5rem);
    font-weight: 400;
    color: var(--color-text-muted, #94877c);
    transition: color 0.3s ease;
    line-height: 1.1;
  }

  .experience-nav__item[data-active='true'] .experience-nav__number {
    color: white;
  }

  /* ----------------------------------------
     Right Column: Cards
     ---------------------------------------- */
  .experience-cards-wrapper {
    display: flex;
    flex-direction: column;
  }

  .experience-cards {
    position: relative;
    min-height: 450px;
  }

  .experience-card {
    position: absolute;
    inset: 0;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.4s ease;
    display: flex;
    flex-direction: column;
  }

  .experience-card[data-active='true'] {
    opacity: 1;
    pointer-events: auto;
  }

  .experience-card__image-wrapper {
    position: relative;
    border-radius: 28px;
    overflow: hidden;
    margin-block-end: var(--space-lg, 1.5rem);
    aspect-ratio: 4 / 3;
  }

  .experience-card__image-wrapper::after {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: inherit;
    box-shadow:
      inset 0 0 60px 30px
        color-mix(
          in srgb,
          var(--experience-bg, var(--color-primary, #0066cc)) 25%,
          transparent
        ),
      inset 0 0 120px 60px
        color-mix(
          in srgb,
          var(--experience-bg, var(--color-primary, #0066cc)) 15%,
          transparent
        );
    pointer-events: none;
  }

  .experience-card__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .experience-card__image-placeholder {
    width: 100%;
    height: 100%;
    background: var(
      --icon-bg,
      linear-gradient(135deg, #e0d5c9 0%, #c9bfb3 100%)
    );
    display: flex;
    align-items: center;
    justify-content: center;
    color: color-mix(in srgb, var(--icon-bg, #c9bfb3) 80%, black);
  }

  .experience-card__image-placeholder :global(svg) {
    width: 50%;
    height: 50%;
    max-width: 180px;
    max-height: 180px;
  }

  .experience-card__image-placeholder :global(svg),
  .experience-card__image-placeholder :global(svg *) {
    color: color-mix(in srgb, var(--icon-bg, #c9bfb3) 80%, black);
    stroke: color-mix(in srgb, var(--icon-bg, #c9bfb3) 60%, black);
  }

  .experience-card__content {
    flex: 1;
    min-height: 100px; /* Prevent text overlap with CTA */
  }

  .experience-card__title {
    font-family: var(--font-serif, Georgia, serif);
    font-size: var(--font-size-xl, 1.5rem);
    font-weight: 500;
    color: var(--color-accent, #4ecdc4);
    margin: 0 0 var(--space-sm, 0.5rem) 0;
  }

  .experience-card__description {
    font-size: var(--font-size-md, 1rem);
    color: var(--experience-card-desc-color, var(--color-text-muted, #94877c));
    line-height: 1.6;
    margin: 0;
  }

  /* Single CTA outside cards - never re-renders on card switch */
  .experience-section__cta {
    align-self: flex-start;
    margin-top: var(--space-xl, 2.5rem);
    padding: var(--button-padding-vertical, var(--space-md))
      var(--button-padding-horizontal, var(--space-lg));
    background: var(--color-accent, #4ecdc4);
    color: white;
    text-decoration: none;
    border-radius: var(--button-border-radius, 4px);
    font-weight: 600;
  }

  .experience-section__cta:hover {
    transform: translateY(-2px);
    filter: brightness(1.1);
    transition:
      transform 0.2s,
      filter 0.2s;
  }

  /* ========================================
     MOBILE: ACCORDION LAYOUT
     Hidden by default on desktop (>900px)
     ======================================== */
  .experience-accordion {
    display: none !important;
  }

  @media (max-width: 900px) {
    .experience-accordion {
      display: block !important;
    }
  }

  .experience-accordion__item {
    border-bottom: 1px solid rgba(148, 135, 124, 0.2);
  }

  .experience-accordion__item:first-child {
    border-top: 1px solid rgba(148, 135, 124, 0.2);
  }

  .experience-accordion__header {
    display: flex;
    align-items: baseline;
    width: 100%;
    padding: var(--space-lg, 1.5rem) 0;
    border: none;
    background: transparent;
    cursor: pointer;
    text-align: left;
  }

  .experience-accordion__title {
    font-family: var(--font-serif, Georgia, serif);
    font-size: clamp(1.5rem, 6vw, 2rem);
    font-weight: 400;
    color: var(--color-text-muted, #94877c);
    flex: 1;
    transition: color 0.3s ease;
    text-align: left;
  }

  .experience-accordion__item[data-active='true'] .experience-accordion__title {
    color: var(--color-text, #2b180a);
  }

  .experience-accordion__number {
    font-family: var(--font-serif, Georgia, serif);
    font-size: clamp(1.5rem, 6vw, 2rem);
    font-weight: 400;
    color: var(--color-text-muted, #94877c);
    transition: color 0.3s ease;
    margin-right: var(--space-sm, 0.5rem);
  }

  .experience-accordion__item[data-active='true']
    .experience-accordion__number {
    color: var(--color-text, #2b180a);
  }

  .experience-accordion__icon {
    font-size: 1.5rem;
    color: var(--color-text-muted, #94877c);
    transition: transform 0.3s ease;
    margin-left: var(--space-md, 1rem);
  }

  .experience-accordion__item[data-active='true'] .experience-accordion__icon {
    transform: rotate(45deg);
  }

  .experience-accordion__content {
    max-height: 0;
    overflow: hidden;
    transition:
      max-height 0.4s ease,
      padding 0.4s ease;
    padding: 0;
  }

  .experience-accordion__item[data-active='true']
    .experience-accordion__content {
    max-height: 600px;
    padding-bottom: var(--space-lg, 1.5rem);
  }

  .experience-accordion__image-wrapper {
    position: relative;
    border-radius: 20px;
    overflow: hidden;
    margin-block-end: var(--space-md, 1rem);
    aspect-ratio: 4 / 3;
  }

  .experience-accordion__image-wrapper::after {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: inherit;
    box-shadow:
      inset 0 0 50px 25px
        color-mix(
          in srgb,
          var(--experience-bg, var(--color-primary, #0066cc)) 25%,
          transparent
        ),
      inset 0 0 100px 50px
        color-mix(
          in srgb,
          var(--experience-bg, var(--color-primary, #0066cc)) 15%,
          transparent
        );
    pointer-events: none;
  }

  .experience-accordion__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .experience-accordion__image-placeholder {
    width: 100%;
    height: 100%;
    background: var(
      --icon-bg,
      linear-gradient(135deg, #e0d5c9 0%, #c9bfb3 100%)
    );
    display: flex;
    align-items: center;
    justify-content: center;
    color: color-mix(in srgb, var(--icon-bg, #c9bfb3) 80%, black);
  }

  .experience-accordion__image-placeholder :global(svg) {
    width: 50%;
    height: 50%;
    max-width: 140px;
    max-height: 140px;
  }

  .experience-accordion__image-placeholder :global(svg),
  .experience-accordion__image-placeholder :global(svg *) {
    color: color-mix(in srgb, var(--icon-bg, #c9bfb3) 80%, black);
    stroke: color-mix(in srgb, var(--icon-bg, #c9bfb3) 60%, black);
  }

  .experience-accordion__description {
    font-size: var(--font-size-md, 1rem);
    color: var(--experience-card-desc-color, var(--color-text-muted, #94877c));
    line-height: 1.6;
    margin: 0 0 var(--space-md, 1rem) 0;
  }

  .experience-accordion__cta {
    display: inline-block;
    align-self: flex-start;
    padding: var(--button-padding-vertical, var(--space-md))
      var(--button-padding-horizontal, var(--space-lg));
    background: var(--color-accent, #4ecdc4);
    color: white;
    text-decoration: none;
    border-radius: var(--button-border-radius, 4px);
    font-weight: 600;
  }

  .experience-accordion__cta:hover {
    transform: translateY(-2px);
    filter: brightness(1.1);
    transition:
      transform 0.2s,
      filter 0.2s;
  }

  /* ========================================
     RESPONSIVE BREAKPOINTS
     ======================================== */
  @media (max-width: 900px) {
    /* Hide desktop layout on mobile */
    .experience-section__content {
      display: none !important;
    }
  }

  /* Tablet adjustments */
  @media (min-width: 901px) and (max-width: 1100px) {
    .experience-section__content {
      gap: var(--space-xl, 3rem);
    }

    .experience-nav__title {
      font-size: 2.5rem;
    }

    .experience-cards {
      min-height: 450px;
    }
  }
</style>

<script>
  import { setupAnimationLifecycle, createFadeIn } from '@lib/animation';

  setupAnimationLifecycle(() => {
    // ========================================
    // DESKTOP: Hover-based card switching
    // ========================================
    const navItems = document.querySelectorAll('.experience-nav__item');
    const cards = document.querySelectorAll('.experience-card');

    function setActiveCard(index: number) {
      // Update nav items
      navItems.forEach((item, i) => {
        const isActive = i === index;
        item.setAttribute('data-active', String(isActive));
        item.setAttribute('aria-pressed', String(isActive));
      });

      // Update cards
      cards.forEach((card, i) => {
        const isActive = i === index;
        card.setAttribute('data-active', String(isActive));
        card.setAttribute('aria-hidden', String(!isActive));
      });
    }

    // Desktop: Hover to switch
    navItems.forEach((item, index) => {
      item.addEventListener('mouseenter', () => setActiveCard(index));
    });

    // Desktop: Click also works (for accessibility)
    navItems.forEach((item, index) => {
      item.addEventListener('click', () => setActiveCard(index));
    });

    // Keyboard navigation
    navItems.forEach((item, index) => {
      item.addEventListener('keydown', ((e: KeyboardEvent) => {
        if (e.key === 'ArrowDown' || e.key === 'ArrowRight') {
          e.preventDefault();
          const nextIndex = (index + 1) % navItems.length;
          setActiveCard(nextIndex);
          (navItems[nextIndex] as HTMLElement).focus();
        } else if (e.key === 'ArrowUp' || e.key === 'ArrowLeft') {
          e.preventDefault();
          const prevIndex = (index - 1 + navItems.length) % navItems.length;
          setActiveCard(prevIndex);
          (navItems[prevIndex] as HTMLElement).focus();
        }
      }) as EventListener);
    });

    // ========================================
    // MOBILE: Accordion functionality
    // ========================================
    const accordionItems = document.querySelectorAll(
      '.experience-accordion__item'
    );
    const accordionHeaders = document.querySelectorAll(
      '.experience-accordion__header'
    );

    function setActiveAccordion(index: number) {
      accordionItems.forEach((item, i) => {
        const isActive = i === index;
        const wasActive = item.getAttribute('data-active') === 'true';

        // Toggle: if clicking the already active item, close it
        if (i === index && wasActive) {
          item.setAttribute('data-active', 'false');
          item
            .querySelector('.experience-accordion__header')
            ?.setAttribute('aria-expanded', 'false');
        } else {
          item.setAttribute('data-active', String(isActive));
          item
            .querySelector('.experience-accordion__header')
            ?.setAttribute('aria-expanded', String(isActive));
        }
      });
    }

    accordionHeaders.forEach((header, index) => {
      header.addEventListener('click', () => setActiveAccordion(index));
    });

    // ========================================
    // GSAP: Entrance animations (optional)
    // ========================================
    // Fade in the header
    createFadeIn('.experience-section__header', { y: 30 });

    // Staggered fade in for nav items (desktop)
    if (window.innerWidth > 900) {
      createFadeIn('.experience-nav__item', { y: 20, stagger: 0.1 });
      createFadeIn('.experience-cards', { y: 20 });
    }

    // Staggered fade in for accordion items (mobile)
    if (window.innerWidth <= 900) {
      createFadeIn('.experience-accordion__item', { y: 20, stagger: 0.08 });
    }
  });
</script>
