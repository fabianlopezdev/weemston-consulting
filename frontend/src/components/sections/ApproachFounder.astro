---
import { urlForImageWithSeoFilename } from '@lib/sanity/image';

interface ImageAsset {
  _id: string;
  url: string;
  metadata?: {
    lqip?: string;
    dimensions?: {
      width: number;
      height: number;
      aspectRatio: number;
    };
  };
}

interface SanityImage {
  asset?: ImageAsset;
  alt?: string;
  seoFilename?: string;
  hotspot?: { x: number; y: number };
  crop?: { top: number; bottom: number; left: number; right: number };
}

interface Props {
  tagline?: string;
  title: string;
  content?: string;
  quote?: string;
  image?: SanityImage;
}

const { tagline, title, content, quote, image } = Astro.props;

// Generate image URL
const imageUrl = image?.asset
  ? urlForImageWithSeoFilename(image, { width: 800, quality: 85 })
  : null;

const imageLqip = image?.asset?.metadata?.lqip;

// Split content into parts: before quote, quote, after quote
// Each part is further split into paragraphs by double newlines
interface ContentPart {
  type: 'paragraph' | 'quote';
  text: string;
}

function parseContent(content: string, quote?: string): ContentPart[] {
  if (!content) return [];

  if (!quote || !content.includes(quote)) {
    // No quote or quote not found - just split into paragraphs
    return content
      .split(/\n\n+/)
      .map((text) => text.trim())
      .filter((text) => text.length > 0)
      .map((text) => ({ type: 'paragraph' as const, text }));
  }

  const parts: ContentPart[] = [];
  const quoteIndex = content.indexOf(quote);

  // Text before quote
  const beforeQuote = content.slice(0, quoteIndex).trim();
  if (beforeQuote) {
    beforeQuote
      .split(/\n\n+/)
      .map((text) => text.trim())
      .filter((text) => text.length > 0)
      .forEach((text) => parts.push({ type: 'paragraph', text }));
  }

  // The quote itself
  parts.push({ type: 'quote', text: quote });

  // Text after quote
  const afterQuote = content.slice(quoteIndex + quote.length).trim();
  if (afterQuote) {
    afterQuote
      .split(/\n\n+/)
      .map((text) => text.trim())
      .filter((text) => text.length > 0)
      .forEach((text) => parts.push({ type: 'paragraph', text }));
  }

  return parts;
}

const contentParts = parseContent(content || '', quote);
---

<section class="founder-section">
  <div class="container">
    <div class="founder-section__grid">
      {imageUrl && (
        <div class="founder-section__image-wrapper">
          <img
            src={imageUrl}
            alt={image?.alt || ''}
            class="founder-section__image"
            loading="lazy"
            decoding="async"
            style={imageLqip ? `background-image: url(${imageLqip}); background-size: cover;` : ''}
          />
        </div>
      )}
      <div class="founder-section__content">
        {tagline && (
          <span class="founder-section__tagline">{tagline}</span>
        )}
        <h2 class="founder-section__title">{title}</h2>
        <div class="founder-section__text">
          {contentParts.map((part) => (
            part.type === 'quote' ? (
              <blockquote class="founder-section__quote">
                "{part.text}"
              </blockquote>
            ) : (
              <p>{part.text}</p>
            )
          ))}
        </div>
      </div>
    </div>
  </div>
</section>

<style>
  .founder-section {
    padding: var(--space-2xl) 0;
  }

  .founder-section__grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-xl);
    align-items: center;
  }

  @media (min-width: 768px) {
    .founder-section__grid {
      grid-template-columns: 1fr 1fr;
      gap: var(--space-2xl);
    }
  }

  .founder-section__image-wrapper {
    position: relative;
    aspect-ratio: 4 / 5;
    overflow: hidden;
    background-color: var(--color-border, #e5e5e5);
    max-width: 450px;
    width: 100%;
    margin: 0 auto;
  }

  .founder-section__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .founder-section__content {
    padding: var(--space-md) 0;
  }

  .founder-section__tagline {
    display: block;
    font-size: 0.875rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-accent);
    margin-bottom: var(--space-sm);
  }

  .founder-section__title {
    font-family: var(--font-heading);
    font-size: clamp(1.75rem, 4vw, 2.5rem);
    font-weight: 500;
    line-height: 1.2;
    color: var(--color-accent);
    margin: 0 0 var(--space-lg);
  }

  .founder-section__text {
    color: var(--color-text-muted);
  }

  .founder-section__text p {
    margin: 0 0 var(--space-md);
    line-height: 1.7;
  }

  .founder-section__text p:last-child {
    margin-bottom: 0;
  }

  .founder-section__quote {
    border-left: 3px solid var(--color-accent);
    padding-left: var(--space-md);
    margin: var(--space-lg) 0;
    font-family: var(--font-heading);
    font-size: clamp(1.125rem, 2.5vw, 1.35rem);
    font-style: italic;
    color: var(--color-accent);
    line-height: 1.5;
  }

  .founder-section__quote:last-child {
    margin-bottom: 0;
  }

  .founder-section__quote + p {
    margin-top: var(--space-lg);
  }
</style>
