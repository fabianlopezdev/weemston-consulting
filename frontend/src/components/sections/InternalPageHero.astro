---
import { resolveColorSelection } from '@lib/sanity/colorResolver';
import { sanityClient as client } from 'sanity:client';
import { siteSettingsQuery } from '@lib/sanity/queries';

interface ColorData {
  label?: string;
  value: string;
}

interface GradientColorData {
  colorType?: 'primary' | 'secondary' | 'accent' | 'custom';
  shade?: number;
  customColor?: ColorData;
}

interface GradientData {
  direction?: string;
  startColor?: GradientColorData;
  endColor?: GradientColorData;
}

interface Props {
  heading: string;
  headingHighlight?: string;
  highlightColorType?: 'primary' | 'secondary' | 'accent' | 'custom';
  highlightColorShade?: number;
  highlightCustomColor?: ColorData;
  showDivider?: boolean;
  dividerColorType?: 'primary' | 'secondary' | 'accent' | 'custom';
  dividerColorShade?: number;
  dividerCustomColor?: ColorData;
  tagline?: string;
  taglineColor?: 'base' | 'muted' | 'contrast';
  backgroundColorType?: 'primary' | 'secondary' | 'accent' | 'custom';
  backgroundColorMode?: 'solid' | 'gradient';
  backgroundColorShade?: number;
  backgroundCustomColor?: ColorData;
  backgroundGradient?: GradientData;
}

const {
  heading,
  headingHighlight,
  highlightColorType = 'accent',
  highlightColorShade = 0,
  highlightCustomColor,
  showDivider = true,
  dividerColorType = 'secondary',
  dividerColorShade = 0,
  dividerCustomColor,
  tagline,
  taglineColor = 'muted',
  backgroundColorType = 'primary',
  backgroundColorMode = 'solid',
  backgroundColorShade = 90,
  backgroundCustomColor,
  backgroundGradient,
} = Astro.props;

// Fetch site settings for colors
const settings = await client.fetch(siteSettingsQuery);
const siteColors = settings?.colors;

// Resolve background color
const backgroundColor =
  backgroundColorMode === 'gradient' && backgroundGradient
    ? `linear-gradient(${backgroundGradient.direction || '135deg'}, ${resolveColorSelection(backgroundGradient.startColor, siteColors)}, ${resolveColorSelection(backgroundGradient.endColor, siteColors)})`
    : resolveColorSelection(
        {
          colorType: backgroundColorType,
          shade: backgroundColorShade,
          customColor: backgroundCustomColor,
        },
        siteColors
      );

// Resolve highlight color
let highlightColor: string;
if (highlightColorType === 'custom' && highlightCustomColor?.value) {
  highlightColor = highlightCustomColor.value;
} else {
  highlightColor = resolveColorSelection(
    {
      colorType: highlightColorType,
      shade: highlightColorShade,
      customColor: highlightCustomColor,
    },
    siteColors
  );
}

// Resolve divider color
let dividerColor: string;
if (dividerColorType === 'custom' && dividerCustomColor?.value) {
  dividerColor = dividerCustomColor.value;
} else {
  dividerColor = resolveColorSelection(
    {
      colorType: dividerColorType,
      shade: dividerColorShade,
      customColor: dividerCustomColor,
    },
    siteColors
  );
}

// Resolve tagline color
const taglineColorMap: Record<string, string> = {
  base: 'var(--color-text-base)',
  muted: 'var(--color-text-muted)',
  contrast: 'var(--color-text-contrast)',
};
const resolvedTaglineColor =
  taglineColorMap[taglineColor] || taglineColorMap.muted;

const cssVars = `--internal-page-hero-bg: ${backgroundColor}; --internal-page-hero-highlight: ${highlightColor}; --internal-page-hero-divider: ${dividerColor}; --internal-page-hero-tagline: ${resolvedTaglineColor}`;

// Split heading into parts if highlight text is provided and found
function renderHeadingParts() {
  if (!headingHighlight || !heading.includes(headingHighlight)) {
    return { before: heading, highlight: null, after: null };
  }
  const index = heading.indexOf(headingHighlight);
  return {
    before: heading.slice(0, index),
    highlight: headingHighlight,
    after: heading.slice(index + headingHighlight.length),
  };
}

const parts = renderHeadingParts();
---

<section class="internal-page-hero" style={cssVars}>
  <div class="internal-page-hero__container">
    <h1 class="internal-page-hero__heading">
      {
        parts.highlight ? (
          <>
            {parts.before}
            <span class="internal-page-hero__highlight">{parts.highlight}</span>
            {parts.after}
          </>
        ) : (
          heading
        )
      }
    </h1>
    {showDivider && <div class="internal-page-hero__divider" />}
    {tagline && <p class="internal-page-hero__tagline">{tagline}</p>}
  </div>
</section>

<style>
  .internal-page-hero {
    background: var(--internal-page-hero-bg, var(--color-primary-light));
    padding: clamp(6rem, 10vw, 8rem) var(--space-md) clamp(4rem, 8vw, 6rem);
    text-align: center;
  }

  .internal-page-hero__container {
    max-width: 900px;
    margin: 0 auto;
  }

  .internal-page-hero__heading {
    font-family: var(--font-heading);
    font-size: clamp(2rem, 5vw, 3.5rem);
    font-weight: 500;
    line-height: 1.2;
    color: var(--color-accent);
    margin: 0 0 var(--space-lg);
  }

  .internal-page-hero__highlight {
    font-style: italic;
    color: var(--internal-page-hero-highlight, var(--color-text-muted));
  }

  .internal-page-hero__divider {
    width: 6rem;
    height: 0.25rem;
    background-color: var(--internal-page-hero-divider, var(--color-secondary));
    margin: 0 auto;
    border-radius: 9999px;
  }

  .internal-page-hero__tagline {
    font-size: var(--font-size-lg);
    color: var(--internal-page-hero-tagline, var(--color-text-muted));
    line-height: 1.6;
    margin: var(--space-lg) 0 0;
    max-width: 700px;
    margin-inline: auto;
  }

  /* Word reveal wrapper for editorial animation */
  .internal-page-hero__heading :global(.internal-page-hero__word-wrapper) {
    display: inline-block;
    overflow: hidden;
    vertical-align: top;
    padding-bottom: 0.15em;
  }

  /* Reduced motion: show all immediately */
  @media (prefers-reduced-motion: reduce) {
    .internal-page-hero__heading,
    .internal-page-hero__divider,
    .internal-page-hero__tagline {
      opacity: 1 !important;
      transform: none !important;
    }
  }
</style>

<script>
  import {
    setupAnimationLifecycle,
    gsap,
    SplitText,
    ScrollTrigger,
  } from '@lib/animation/utils';
  import { ANIMATION_CONFIG } from '@lib/animation/config';

  setupAnimationLifecycle(() => {
    // Check for reduced motion preference
    const prefersReducedMotion = window.matchMedia(
      '(prefers-reduced-motion: reduce)'
    ).matches;

    const heading = document.querySelector(
      '.internal-page-hero__heading'
    ) as HTMLElement;
    const divider = document.querySelector('.internal-page-hero__divider');
    const tagline = document.querySelector('.internal-page-hero__tagline');

    if (!heading) return;

    // If reduced motion, show everything immediately
    if (prefersReducedMotion) {
      gsap.set([heading, divider, tagline].filter(Boolean), {
        opacity: 1,
        transform: 'none',
      });
      return;
    }

    // Split heading into words for editorial reveal
    const headingSplit = new SplitText(heading, { type: 'words' });
    const headingWords = headingSplit.words as HTMLElement[];

    // Wrap each word for clip overflow
    headingWords.forEach((word) => {
      const wrapper = document.createElement('span');
      wrapper.style.display = 'inline-block';
      wrapper.style.overflow = 'hidden';
      wrapper.style.verticalAlign = 'top';
      wrapper.style.paddingBottom = '0.15em'; // Extra padding for descenders
      wrapper.classList.add('internal-page-hero__word-wrapper');

      word.parentNode?.insertBefore(wrapper, word);
      wrapper.appendChild(word);

      // Set initial state
      gsap.set(word, { y: '100%', opacity: 0 });
    });

    // Initial states for other elements
    if (divider) {
      gsap.set(divider, { opacity: 0, scaleX: 0 });
    }
    if (tagline) {
      gsap.set(tagline, { opacity: 0, y: 20 });
    }

    // Create entrance timeline
    const tl = gsap.timeline({
      scrollTrigger: {
        trigger: '.internal-page-hero',
        start: 'top 80%',
        once: true,
        markers: ANIMATION_CONFIG.scrollTrigger.markers,
      },
    });

    // Heading words reveal with editorial stagger
    tl.to(headingWords, {
      y: 0,
      opacity: 1,
      duration: 0.7,
      stagger: 0.05,
      ease: 'power3.out',
    });

    // Divider expands from center (overlaps with heading end)
    if (divider) {
      tl.to(
        divider,
        {
          opacity: 1,
          scaleX: 1,
          duration: 0.6,
          ease: 'power2.out',
        },
        '-=0.3'
      );
    }

    // Tagline fades in
    if (tagline) {
      tl.to(
        tagline,
        {
          opacity: 1,
          y: 0,
          duration: 0.6,
          ease: 'power2.out',
        },
        '-=0.2'
      );
    }

    // Subtle parallax on scroll - only affects visible words
    ScrollTrigger.create({
      trigger: '.internal-page-hero',
      start: 'top top',
      end: 'bottom top',
      scrub: 1,
      onUpdate: (self) => {
        const progress = self.progress;
        // Apply parallax to the word wrappers, not the words themselves
        const wrappers = document.querySelectorAll(
          '.internal-page-hero__word-wrapper'
        );
        gsap.set(wrappers, { y: progress * 30 });
      },
    });
  });
</script>
