---
import PortableText from '@components/sanity/PortableText.astro';
import { resolveColorSelection } from '@lib/sanity/colorResolver';
import { sanityClient as client } from 'sanity:client';
import { siteSettingsQuery } from '@lib/sanity/queries';
import type { PortableTextBlock } from '@portabletext/types';

interface ColorData {
  label?: string;
  value: string;
}

interface Props {
  title: string;
  titleColorType?: 'primary' | 'secondary' | 'accent' | 'custom';
  titleColorShade?: number;
  titleCustomColor?: ColorData;
  content?: PortableTextBlock[];
  textColor?: 'base' | 'muted' | 'contrast';
  backgroundColorType?: 'primary' | 'secondary' | 'accent' | 'custom';
  backgroundColorShade?: number;
  backgroundCustomColor?: ColorData;
}

const {
  title,
  titleColorType = 'accent',
  titleColorShade = 0,
  titleCustomColor,
  content,
  textColor = 'base',
  backgroundColorType = 'accent',
  backgroundColorShade = 0,
  backgroundCustomColor,
} = Astro.props;

// Fetch site settings for colors
const settings = await client.fetch(siteSettingsQuery);
const siteColors = settings?.colors;

// Resolve background color
const backgroundColor = resolveColorSelection(
  {
    colorType: backgroundColorType,
    shade: backgroundColorShade,
    customColor: backgroundCustomColor,
  },
  siteColors
);

// Resolve title color
const titleColor = resolveColorSelection(
  {
    colorType: titleColorType,
    shade: titleColorShade,
    customColor: titleCustomColor,
  },
  siteColors
);

// Determine colors based on props
const textColorMap = {
  base: 'var(--color-text)',
  muted: 'var(--color-text-muted)',
  contrast: 'rgba(255, 255, 255, 0.9)',
};

const cssVars = [
  `--highlight-bg: ${backgroundColor}`,
  `--highlight-title-color: ${titleColor}`,
  `--highlight-text-color: ${textColorMap[textColor]}`,
].join('; ');
---

<section class="highlight-section" style={cssVars}>
  <div class="highlight-section__compass" aria-hidden="true">
    <svg
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="1"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <circle cx="12" cy="12" r="10"></circle>
      <polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"
      ></polygon>
    </svg>
  </div>
  <div class="container highlight-section__container">
    <h2 class="highlight-section__title">{title}</h2>
    {
      content && (
        <div class="highlight-section__content">
          <PortableText content={content} />
        </div>
      )
    }
  </div>
</section>

<style>
  .highlight-section {
    background-color: var(--highlight-bg, var(--color-accent));
    padding: var(--space-2xl) 0;
    text-align: center;
    position: relative;
    overflow: hidden;
  }

  .highlight-section__compass {
    position: absolute;
    top: 0;
    right: 0;
    width: clamp(250px, 30vw, 400px);
    height: clamp(250px, 30vw, 400px);
    opacity: 0.1;
    color: var(--highlight-title-color);
    transform: translate(20%, -20%);
    pointer-events: none;
  }

  .highlight-section__compass svg {
    width: 100%;
    height: 100%;
  }

  .highlight-section__container {
    position: relative;
    z-index: 1;
  }

  .highlight-section__title {
    font-family: var(--font-heading);
    font-size: clamp(1.75rem, 4vw, 2.5rem);
    font-weight: 500;
    line-height: 1.2;
    color: var(--highlight-title-color);
    margin: 0 0 var(--space-lg);
  }

  .highlight-section__content {
    max-width: 800px;
    margin: 0 auto;
    color: var(--highlight-text-color);
  }

  .highlight-section__content :global(p) {
    margin-bottom: var(--space-md);
    line-height: 1.7;
  }

  .highlight-section__content :global(p:last-child) {
    margin-bottom: 0;
  }

  .highlight-section__content :global(a) {
    color: var(--highlight-title-color);
    text-decoration: underline;
  }
</style>

<script>
  import { setupAnimationLifecycle, gsap } from '@lib/animation/utils';
  import { ANIMATION_CONFIG } from '@lib/animation/config';

  setupAnimationLifecycle(() => {
    const compass = document.querySelector('.highlight-section__compass');
    const title = document.querySelector('.highlight-section__title');
    const content = document.querySelector('.highlight-section__content');
    const section = document.querySelector('.highlight-section');

    if (!section) return;

    // Continuous slow rotation for compass (non-scroll-triggered)
    if (compass) {
      gsap.to(compass, {
        rotation: 360,
        duration: 60,
        ease: 'none',
        repeat: -1,
        transformOrigin: 'center center',
      });

      // Subtle scale on scroll
      gsap.fromTo(
        compass,
        { scale: 0.9, opacity: 0.05 },
        {
          scale: 1.1,
          opacity: 0.15,
          ease: 'none',
          scrollTrigger: {
            trigger: section,
            start: 'top bottom',
            end: 'bottom top',
            scrub: 1,
            markers: ANIMATION_CONFIG.scrollTrigger.markers,
          },
        }
      );
    }

    // Initial states for content
    if (title) gsap.set(title, { opacity: 0, y: 30 });
    if (content) gsap.set(content, { opacity: 0, y: 20 });

    // Content timeline
    const tl = gsap.timeline({
      scrollTrigger: {
        trigger: section,
        start: 'top 70%',
        once: true,
        markers: ANIMATION_CONFIG.scrollTrigger.markers,
      },
    });

    if (title) {
      tl.to(title, {
        opacity: 1,
        y: 0,
        duration: 0.7,
        ease: 'power3.out',
      });
    }

    if (content) {
      tl.to(
        content,
        {
          opacity: 1,
          y: 0,
          duration: 0.6,
          ease: 'power2.out',
        },
        '-=0.4'
      );
    }
  });
</script>
