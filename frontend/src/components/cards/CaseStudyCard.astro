---
import { resolveColorSelection } from '@lib/sanity/colorResolver';
import { sanityClient as client } from 'sanity:client';
import { siteSettingsQuery } from '@lib/sanity/queries';
import Image from '@components/media/Image.astro';
import PortableText from '@components/sanity/PortableText.astro';
import { Icon } from 'astro-icon/components';
import type { PortableTextBlock } from '@portabletext/types';

interface ColorData {
  label?: string;
  value: string;
}

interface ImageData {
  asset?: { _id: string; url?: string };
  alt?: string;
  hotspot?: { x: number; y: number };
  crop?: { top: number; bottom: number; left: number; right: number };
}

interface Props {
  // Hero Section
  mainImage: ImageData;
  icon?: { name?: string };
  category: string;
  client: string;
  role?: string;
  // Hero Colors
  overlayColorType?: 'primary' | 'secondary' | 'accent' | 'custom';
  overlayColorShade?: number;
  overlayCustomColor?: ColorData;
  overlayOpacity?: number;
  iconBgColorType?: 'primary' | 'secondary' | 'accent' | 'custom';
  iconBgColorShade?: number;
  iconBgCustomColor?: ColorData;
  iconColorType?: 'primary' | 'secondary' | 'accent' | 'custom';
  iconColorShade?: number;
  iconCustomColor?: ColorData;
  categoryColor?: 'base' | 'muted' | 'contrast';
  clientColor?: 'base' | 'muted' | 'contrast';
  roleColor?: 'base' | 'muted' | 'contrast';
  // Content Section
  date?: string;
  description?: PortableTextBlock[];
  contributionsTitle?: string;
  contributions?: string[];
  // Content Colors
  contentBgColorType?:
    | 'default'
    | 'primary'
    | 'secondary'
    | 'accent'
    | 'custom';
  contentBgColorShade?: number;
  contentBgCustomColor?: ColorData;
  dateColorType?: 'primary' | 'secondary' | 'accent' | 'custom';
  dateColorShade?: number;
  dateCustomColor?: ColorData;
  dividerColorType?: 'primary' | 'secondary' | 'accent' | 'custom';
  dividerColorShade?: number;
  dividerCustomColor?: ColorData;
  descriptionColor?: 'base' | 'muted' | 'contrast';
  contributionsTitleColorType?: 'primary' | 'secondary' | 'accent' | 'custom';
  contributionsTitleColorShade?: number;
  contributionsTitleCustomColor?: ColorData;
  contributionsTextColor?: 'base' | 'muted' | 'contrast';
  bulletColorType?: 'primary' | 'secondary' | 'accent' | 'custom';
  bulletColorShade?: number;
  bulletCustomColor?: ColorData;
}

const {
  // Hero
  mainImage,
  icon,
  category,
  client: clientName,
  role,
  overlayColorType = 'primary',
  overlayColorShade = 0,
  overlayCustomColor,
  overlayOpacity = 70,
  iconBgColorType = 'primary',
  iconBgColorShade = 100,
  iconBgCustomColor,
  iconColorType = 'accent',
  iconColorShade = 0,
  iconCustomColor,
  categoryColor = 'contrast',
  clientColor = 'contrast',
  roleColor = 'contrast',
  // Content
  date,
  description,
  contributionsTitle = 'KEY CONTRIBUTIONS',
  contributions = [],
  contentBgColorType = 'default',
  contentBgColorShade = 95,
  contentBgCustomColor,
  dateColorType = 'secondary',
  dateColorShade = 0,
  dateCustomColor,
  dividerColorType = 'secondary',
  dividerColorShade = 0,
  dividerCustomColor,
  descriptionColor = 'base',
  contributionsTitleColorType = 'accent',
  contributionsTitleColorShade = 0,
  contributionsTitleCustomColor,
  contributionsTextColor = 'base',
  bulletColorType = 'accent',
  bulletColorShade = 0,
  bulletCustomColor,
} = Astro.props;

// Fetch site settings for colors
const settings = await client.fetch(siteSettingsQuery);
const siteColors = settings?.colors;

// Resolve hero colors
const overlayColor = resolveColorSelection(
  {
    colorType: overlayColorType,
    shade: overlayColorShade,
    customColor: overlayCustomColor,
  },
  siteColors
);

const iconBgColor = resolveColorSelection(
  {
    colorType: iconBgColorType,
    shade: iconBgColorShade,
    customColor: iconBgCustomColor,
  },
  siteColors
);

const iconColor = resolveColorSelection(
  {
    colorType: iconColorType,
    shade: iconColorShade,
    customColor: iconCustomColor,
  },
  siteColors
);

// Resolve content colors
const contentBgColor =
  contentBgColorType === 'default' || !contentBgColorType
    ? null
    : resolveColorSelection(
        {
          colorType: contentBgColorType,
          shade: contentBgColorShade,
          customColor: contentBgCustomColor,
        },
        siteColors
      );

const contributionsTitleColor = resolveColorSelection(
  {
    colorType: contributionsTitleColorType,
    shade: contributionsTitleColorShade,
    customColor: contributionsTitleCustomColor,
  },
  siteColors
);

const bulletColor = resolveColorSelection(
  {
    colorType: bulletColorType,
    shade: bulletColorShade,
    customColor: bulletCustomColor,
  },
  siteColors
);

const dateColor = resolveColorSelection(
  {
    colorType: dateColorType,
    shade: dateColorShade,
    customColor: dateCustomColor,
  },
  siteColors
);

const dividerColor = resolveColorSelection(
  {
    colorType: dividerColorType,
    shade: dividerColorShade,
    customColor: dividerCustomColor,
  },
  siteColors
);

// Text color map
const textColorMap: Record<string, string> = {
  base: 'var(--color-text)',
  muted: 'var(--color-text-muted)',
  contrast: 'var(--color-text-contrast)',
};

const resolvedCategoryColor =
  textColorMap[categoryColor] || textColorMap.contrast;
const resolvedClientColor = textColorMap[clientColor] || textColorMap.contrast;
const resolvedRoleColor = textColorMap[roleColor] || textColorMap.contrast;
const resolvedDescriptionColor =
  textColorMap[descriptionColor] || textColorMap.base;
const resolvedContributionsTextColor =
  textColorMap[contributionsTextColor] || textColorMap.base;

// Build CSS variables
const cssVarParts: string[] = [
  `--cs-overlay: ${overlayColor}`,
  `--cs-overlay-opacity: ${overlayOpacity / 100}`,
  `--cs-icon-bg: ${iconBgColor}`,
  `--cs-icon-color: ${iconColor}`,
  `--cs-category-color: ${resolvedCategoryColor}`,
  `--cs-client-color: ${resolvedClientColor}`,
  `--cs-role-color: ${resolvedRoleColor}`,
  `--cs-date: ${dateColor}`,
  `--cs-description: ${resolvedDescriptionColor}`,
  `--cs-title: ${contributionsTitleColor}`,
  `--cs-contributions-text: ${resolvedContributionsTextColor}`,
  `--cs-bullet: ${bulletColor}`,
  `--cs-divider: ${dividerColor}`,
];
if (contentBgColor) cssVarParts.push(`--cs-content-bg: ${contentBgColor}`);
const cssVars = cssVarParts.join('; ');
---

<article class="case-study-card" style={cssVars} data-animate="case-study">
  {/* Hero Section - Top Half */}
  <div class="case-study-card__hero">
    <div class="case-study-card__image-wrapper">
      <Image
        image={mainImage}
        alt={mainImage.alt || clientName}
        class="case-study-card__image"
        sizes="(max-width: 768px) 100vw, 50vw"
      />
      <div class="case-study-card__overlay"></div>
    </div>

    <div class="case-study-card__hero-content">
      <div class="case-study-card__badge-row">
        {
          icon?.name && (
            <div class="case-study-card__icon-wrapper">
              <Icon name={icon.name} class="case-study-card__icon" />
            </div>
          )
        }
        <span class="case-study-card__category">{category}</span>
      </div>
      {role && <p class="case-study-card__role">{role}</p>}
      <h3 class="case-study-card__client">{clientName}</h3>
    </div>
  </div>

  {/* Content Section - Bottom Half */}
  <div class="case-study-card__content">
    <div class="case-study-card__content-grid">
      <div class="case-study-card__left">
        {date && <span class="case-study-card__date">{date}</span>}
        {
          description && description.length > 0 && (
            <div class="case-study-card__description">
              <PortableText content={description} />
            </div>
          )
        }
      </div>

      {
        contributions && contributions.length > 0 && (
          <div class="case-study-card__right">
            <h4 class="case-study-card__contributions-title">
              {contributionsTitle}
            </h4>
            <ul class="case-study-card__list">
              {contributions.map((item) => (
                <li>
                  <span class="case-study-card__bullet" aria-hidden="true">
                    &bull;
                  </span>
                  {item}
                </li>
              ))}
            </ul>
          </div>
        )
      }
    </div>
  </div>
</article>

<style>
  .case-study-card {
    display: flex;
    flex-direction: column;
    border-radius: 0.75rem;
    overflow: hidden;
  }

  /* Hero Section */
  .case-study-card__hero {
    position: relative;
    min-block-size: 20rem; /* 320px mobile */
    display: flex;
    align-items: flex-end;
  }

  @media (min-width: 768px) {
    .case-study-card__hero {
      min-block-size: 31.25rem; /* 500px desktop */
    }
  }

  .case-study-card__image-wrapper {
    position: absolute;
    inset: 0;
    z-index: 0;
    overflow: hidden;
  }

  .case-study-card__image-wrapper :global(.image-blur-wrapper),
  .case-study-card__image-wrapper :global(img) {
    inline-size: 100%;
    block-size: 100%;
    object-fit: cover;
    object-position: top;
    transition: transform 700ms ease-out;
  }

  .case-study-card__overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(
      to top,
      color-mix(
        in srgb,
        var(--cs-overlay) calc(var(--cs-overlay-opacity) * 100%),
        transparent
      ),
      color-mix(
        in srgb,
        var(--cs-overlay) calc(var(--cs-overlay-opacity) * 40%),
        transparent
      ),
      transparent
    );
  }

  .case-study-card__hero-content {
    position: relative;
    z-index: 1;
    inline-size: 100%;
    padding: var(--space-lg);
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: var(--space-xs);
  }

  @media (min-width: 768px) {
    .case-study-card__hero-content {
      padding: var(--space-xl);
    }
  }

  .case-study-card__badge-row {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    margin-block-end: var(--space-xs);
  }

  .case-study-card__icon-wrapper {
    inline-size: 2.5rem;
    block-size: 2.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: color-mix(
      in srgb,
      var(--cs-icon-bg, var(--color-primary-light)) 15%,
      transparent
    );
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
    border-radius: 50%;
  }

  .case-study-card__icon {
    inline-size: 1.25rem;
    block-size: 1.25rem;
    color: var(--cs-icon-color, var(--color-text-contrast));
  }

  .case-study-card__category {
    font-size: var(--font-size-base);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    color: var(--cs-category-color, var(--color-text-contrast));
  }

  .case-study-card__role {
    font-family: var(--font-heading);
    font-size: clamp(2rem, 3vw + 1rem, 3rem);
    font-weight: 500;
    line-height: 1.1;
    color: var(--cs-role-color, var(--color-text-contrast));
    margin: 0;
  }

  .case-study-card__client {
    font-size: clamp(1.25rem, 1vw + 1rem, 1.5rem); /* 20px to 24px */
    font-weight: 300;
    color: var(--cs-client-color, var(--color-text-contrast));
    margin: 0;
    opacity: 0.9;
  }

  /* Content Section */
  .case-study-card__content {
    background-color: var(--cs-content-bg, var(--color-surface));
    padding: var(--space-lg);
    flex: 1;
  }

  @media (min-width: 768px) {
    .case-study-card__content {
      padding: var(--space-xl);
    }
  }

  .case-study-card__content-grid {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
  }

  @media (min-width: 768px) {
    .case-study-card__content-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-lg);
    }
  }

  .case-study-card__left {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
  }

  .case-study-card__date {
    font-size: var(--font-size-base);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--cs-date, var(--color-text-muted));
    margin-block-end: 1.5rem; /* 24px spacing to description */
  }

  .case-study-card__description {
    font-size: var(--font-size-base);
    font-weight: 500;
    line-height: 1.6;
    color: var(--cs-description, var(--color-text));
  }

  .case-study-card__description :global(p) {
    margin: 0;
  }

  .case-study-card__description :global(p + p) {
    margin-block-start: 0.5em;
  }

  .case-study-card__right {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
    border-block-start: 1px solid var(--cs-divider, rgba(180, 180, 180, 0.3));
    padding-block-start: var(--space-md);
  }

  @media (min-width: 768px) {
    .case-study-card__right {
      border-block-start: 0;
      border-inline-start: 1px solid var(--cs-divider, rgba(180, 180, 180, 0.3));
      padding-block-start: 0;
      padding-inline-start: var(--space-lg);
    }
  }

  .case-study-card__contributions-title {
    font-size: var(--font-size-base);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--cs-title, var(--color-accent));
    margin: 0;
    margin-block-end: 1.5rem; /* 24px spacing to list */
  }

  .case-study-card__list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 1rem; /* 16px between list items */
  }

  .case-study-card__list li {
    display: flex;
    align-items: flex-start;
    gap: 1rem; /* 16px gap between bullet and text */
    color: var(--cs-contributions-text, var(--color-text));
    font-size: var(--font-size-base);
    line-height: 1.5;
  }

  .case-study-card__bullet {
    flex-shrink: 0;
    color: var(--cs-bullet, var(--color-accent));
    font-size: 1.25rem;
    line-height: 1;
    margin-block-start: 0.35rem; /* center with first line of text */
  }

  /* Hover Effects */
  .case-study-card:hover .case-study-card__image-wrapper :global(img) {
    transform: scale(1.05);
  }

  /* Reduced Motion Support */
  @media (prefers-reduced-motion: reduce) {
    .case-study-card__image-wrapper :global(img) {
      transition: none;
    }

    .case-study-card:hover .case-study-card__image-wrapper :global(img) {
      transform: none;
    }
  }
</style>

<script>
  import { setupAnimationLifecycle, gsap } from '@lib/animation';

  setupAnimationLifecycle(() => {
    // Respect reduced motion preference
    const prefersReducedMotion = window.matchMedia(
      '(prefers-reduced-motion: reduce)'
    ).matches;
    if (prefersReducedMotion) return;

    const cards = document.querySelectorAll('[data-animate="case-study"]');

    if (!cards.length) return;

    cards.forEach((card) => {
      gsap.fromTo(
        card,
        { opacity: 0, y: 40 },
        {
          opacity: 1,
          y: 0,
          duration: 0.8,
          ease: 'power2.out',
          scrollTrigger: {
            trigger: card,
            start: 'top 85%',
            toggleActions: 'play none none none',
          },
        }
      );
    });
  });
</script>
