---
import type { GetStaticPaths } from 'astro';
import BaseLayout from '@layouts/BaseLayout.astro';
import { client } from '@lib/sanity/client';
import { caseStudyQuery, allCaseStudiesQuery } from '@lib/sanity/queries';
import Image from '@components/media/Image.astro';

export const getStaticPaths = (async () => {
  const caseStudies = await client.fetch(allCaseStudiesQuery, {
    language: 'en',
  });
  return caseStudies.map((caseStudy) => ({
    params: { slug: caseStudy.slug.current },
  }));
}) satisfies GetStaticPaths;

const { slug } = Astro.params;
const lang = Astro.locals.lang || 'en';
const caseStudy = await client.fetch(caseStudyQuery, { slug, language: lang });

if (!caseStudy) {
  return Astro.redirect('/404');
}
---

<BaseLayout
  title={caseStudy.seo?.metaTitle || caseStudy.title}
  description={caseStudy.seo?.metaDescription || undefined}
  image={caseStudy.mainImage ? caseStudy.mainImage.asset._ref : undefined}
>
  <article class="container">
    {
      caseStudy.mainImage && (
        <Image
          image={caseStudy.mainImage}
          alt={caseStudy.mainImage.alt}
          width={1200}
          class="featured-image"
        />
      )
    }

    <header>
      {caseStudy.client && <span class="client-name">{caseStudy.client}</span>}
      <h1>{caseStudy.title}</h1>
      {caseStudy.industry && <p class="industry">{caseStudy.industry}</p>}
    </header>

    {
      caseStudy.challenge && (
        <section class="case-study-section">
          <h2>Challenge</h2>
        </section>
      )
    }

    {
      caseStudy.solution && (
        <section class="case-study-section">
          <h2>Solution</h2>
        </section>
      )
    }

    {
      caseStudy.results && (
        <section class="case-study-section">
          <h2>Results</h2>
        </section>
      )
    }

    {
      caseStudy.testimonial && caseStudy.testimonial.quote && (
        <blockquote class="testimonial">
          <p>"{caseStudy.testimonial.quote}"</p>
          {caseStudy.testimonial.author && (
            <footer>
              <cite>
                {caseStudy.testimonial.author}
                {caseStudy.testimonial.position &&
                  `, ${caseStudy.testimonial.position}`}
              </cite>
            </footer>
          )}
        </blockquote>
      )
    }

    {
      caseStudy.gallery && caseStudy.gallery.length > 0 && (
        <div class="gallery">
          {caseStudy.gallery.map((image) => (
            <figure>
              <Image
                image={image}
                alt={image.alt}
                width={800}
                class="gallery-image"
              />
              {image.caption && <figcaption>{image.caption}</figcaption>}
            </figure>
          ))}
        </div>
      )
    }
  </article>
</BaseLayout>

<style>
  .featured-image {
    margin-block-end: var(--space-2xl);
    border-radius: var(--border-radius-lg);
  }

  header {
    margin-block-end: var(--space-2xl);
  }

  .client-name {
    display: block;
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-semibold);
    color: var(--color-primary);
    margin-block-end: var(--space-sm);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .industry {
    font-size: var(--font-size-base);
    color: var(--color-text-muted);
    margin-block-start: var(--space-sm);
  }

  .case-study-section {
    margin-block-end: var(--space-2xl);
  }

  .case-study-section h2 {
    font-size: var(--font-size-2xl);
    margin-block-end: var(--space-md);
    color: var(--color-primary);
  }

  .case-study-section p {
    font-size: var(--font-size-lg);
    line-height: var(--line-height-relaxed);
    color: var(--color-text-muted);
  }

  .testimonial {
    margin-block: var(--space-3xl);
    padding: var(--space-xl);
    background-color: var(--color-surface-secondary);
    border-inline-start: var(--border-width-thick) solid var(--color-primary);
    border-radius: var(--border-radius-md);
  }

  .testimonial p {
    font-size: var(--font-size-xl);
    font-style: italic;
    line-height: var(--line-height-relaxed);
    margin-block-end: var(--space-md);
  }

  .testimonial footer {
    font-size: var(--font-size-base);
    color: var(--color-text-muted);
  }

  .testimonial cite {
    font-style: normal;
    font-weight: var(--font-weight-semibold);
  }

  .gallery {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: var(--space-lg);
    margin-block-start: var(--space-3xl);
  }

  .gallery figure {
    margin: 0;
  }

  .gallery-image {
    border-radius: var(--border-radius-md);
  }

  .gallery figcaption {
    margin-block-start: var(--space-xs);
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
    text-align: center;
  }
</style>
