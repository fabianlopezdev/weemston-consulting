---
import BaseLayout from '@layouts/BaseLayout.astro';
import { sanityClient as client } from 'sanity:client';
import { allCaseStudiesQuery } from '@lib/sanity/queries';
import { createTranslator } from '@lib/i18n/translations';
import CaseStudyCard from '@components/cards/CaseStudyCard.astro';

const lang = Astro.locals.lang || 'en';
const t = createTranslator(lang);
const caseStudies = await client.fetch(allCaseStudiesQuery, { language: lang });
---

<BaseLayout title={t('seo.case_studies_title')}>
  <div class="container case-studies-page">
    <h1>{t('nav.case_studies')}</h1>
    <div class="case-studies-grid" data-animate="case-study-grid">
      {
        caseStudies.map((caseStudy: any) => (
          <CaseStudyCard
            mainImage={caseStudy.mainImage}
            icon={caseStudy.icon}
            category={caseStudy.category}
            client={caseStudy.client}
            role={caseStudy.role}
            overlayColorType={caseStudy.overlayColorType}
            overlayColorShade={caseStudy.overlayColorShade}
            overlayCustomColor={caseStudy.overlayCustomColor}
            overlayOpacity={caseStudy.overlayOpacity}
            iconBgColorType={caseStudy.iconBgColorType}
            iconBgColorShade={caseStudy.iconBgColorShade}
            iconBgCustomColor={caseStudy.iconBgCustomColor}
            iconColorType={caseStudy.iconColorType}
            iconColorShade={caseStudy.iconColorShade}
            iconCustomColor={caseStudy.iconCustomColor}
            categoryColor={caseStudy.categoryColor}
            clientColor={caseStudy.clientColor}
            roleColor={caseStudy.roleColor}
            date={caseStudy.date}
            description={caseStudy.description}
            contributionsTitle={caseStudy.contributionsTitle}
            contributions={caseStudy.contributions}
            contentBgColorType={caseStudy.contentBgColorType}
            contentBgColorShade={caseStudy.contentBgColorShade}
            contentBgCustomColor={caseStudy.contentBgCustomColor}
            dateColor={caseStudy.dateColor}
            descriptionColor={caseStudy.descriptionColor}
            contributionsTitleColorType={caseStudy.contributionsTitleColorType}
            contributionsTitleColorShade={
              caseStudy.contributionsTitleColorShade
            }
            contributionsTitleCustomColor={
              caseStudy.contributionsTitleCustomColor
            }
            contributionsTextColor={caseStudy.contributionsTextColor}
            bulletColorType={caseStudy.bulletColorType}
            bulletColorShade={caseStudy.bulletColorShade}
            bulletCustomColor={caseStudy.bulletCustomColor}
          />
        ))
      }
    </div>
  </div>
</BaseLayout>

<style>
  .case-studies-page {
    padding-top: var(--space-2xl);
    padding-bottom: var(--space-2xl);
  }

  .case-studies-page h1 {
    margin-bottom: var(--space-xl);
  }

  .case-studies-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-xl);
  }

  @media (min-width: 1024px) {
    .case-studies-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }
</style>

<script>
  import { setupAnimationLifecycle, gsap } from '@lib/animation';

  setupAnimationLifecycle(() => {
    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    if (prefersReducedMotion) return;

    const grid = document.querySelector('[data-animate="case-study-grid"]');
    if (!grid) return;

    const cards = grid.querySelectorAll('[data-animate="case-study"]');
    if (!cards.length) return;

    // Clear any animations set by individual cards
    gsap.set(cards, { clearProps: 'all' });

    // Set initial state
    gsap.set(cards, {
      opacity: 0,
      y: 60,
    });

    // Create staggered entrance with ScrollTrigger
    gsap.to(cards, {
      opacity: 1,
      y: 0,
      duration: 0.6,
      ease: 'power2.out',
      stagger: 0.15,
      scrollTrigger: {
        trigger: grid,
        start: 'top 80%',
        toggleActions: 'play none none none',
      },
    });
  });
</script>
