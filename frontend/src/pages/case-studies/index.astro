---
import BaseLayout from '@layouts/BaseLayout.astro';
import { sanityClient as client } from 'sanity:client';
import {
  allCaseStudiesQuery,
  caseStudiesPageQuery,
  servicesForFilterQuery,
  siteSettingsQuery,
} from '@lib/sanity/queries';
import { createTranslator } from '@lib/i18n/translations';
import { resolveColorSelection } from '@lib/sanity/colorResolver';
import CaseStudyCard from '@components/cards/CaseStudyCard.astro';
import InternalPageHero from '@components/sections/InternalPageHero.astro';
import SectionTitle from '@components/ui/SectionTitle.astro';

const lang = Astro.locals.lang || 'en';
const t = createTranslator(lang);

// Fetch all data
const [page, caseStudies, services, settings] = await Promise.all([
  client.fetch(caseStudiesPageQuery),
  client.fetch(allCaseStudiesQuery, { language: lang }),
  client.fetch(servicesForFilterQuery, { language: lang }),
  client.fetch(siteSettingsQuery),
]);

const siteColors = settings?.colors;

// Resolve intro title color
const introTitleColor = resolveColorSelection(
  {
    colorType: page?.introTitleColorType || 'accent',
    shade: page?.introTitleColorShade || 0,
    customColor: page?.introTitleCustomColor,
  },
  siteColors
);

// Text color map for description
const textColorMap: Record<string, string> = {
  base: 'var(--color-text)',
  muted: 'var(--color-text-muted)',
  contrast: 'var(--color-text-contrast)',
};

const introDescriptionColorResolved =
  textColorMap[page?.introDescriptionColor || 'base'] || textColorMap.base;

// Resolve intro footer color
const introFooterColor = resolveColorSelection(
  {
    colorType: page?.introFooterColorType || 'accent',
    shade: page?.introFooterColorShade || 0,
    customColor: page?.introFooterCustomColor,
  },
  siteColors
);

// Resolve filter colors
const filterActiveColor = resolveColorSelection(
  {
    colorType: page?.filterActiveColorType || 'accent',
    shade: page?.filterActiveColorShade || 0,
    customColor: page?.filterActiveCustomColor,
  },
  siteColors
);

const filterInactiveColor = resolveColorSelection(
  {
    colorType: page?.filterInactiveColorType || 'secondary',
    shade: page?.filterInactiveColorShade || 0,
    customColor: page?.filterInactiveCustomColor,
  },
  siteColors
);

const filterActiveTextResolved =
  textColorMap[page?.filterActiveTextColor || 'contrast'] ||
  textColorMap.contrast;
const filterInactiveTextResolved =
  textColorMap[page?.filterInactiveTextColor || 'muted'] || textColorMap.muted;

// Build filter CSS variables
const filterCssVars = [
  `--filter-active-bg: ${filterActiveColor}`,
  `--filter-active-text: ${filterActiveTextResolved}`,
  `--filter-inactive-border: ${filterInactiveColor}`,
  `--filter-inactive-text: ${filterInactiveTextResolved}`,
].join('; ');
---

<BaseLayout title={page?.metaDescription || t('seo.case_studies_title')}>
  {/* Hero Section */}
  {
    page?.heroHeading && (
      <InternalPageHero
        heading={page.heroHeading}
        headingHighlight={page.heroHeadingHighlight}
        highlightColorType={page.heroHighlightColorType}
        highlightColorShade={page.heroHighlightColorShade}
        highlightCustomColor={page.heroHighlightCustomColor}
        showDivider={page.heroShowDivider}
        dividerColorType={page.heroDividerColorType}
        dividerColorShade={page.heroDividerColorShade}
        dividerCustomColor={page.heroDividerCustomColor}
        tagline={page.heroTagline}
        taglineColor={page.heroTaglineColor}
        backgroundColorType={page.heroBackgroundColorType}
        backgroundColorShade={page.heroBackgroundColorShade}
        backgroundCustomColor={page.heroBackgroundCustomColor}
      />
    )
  }

  {/* Intro Section */}
  {
    (page?.introTitle || page?.introDescription) && (
      <section class="case-studies-intro">
        <div class="container">
          <div class="intro-grid">
            {page.introTitle && (
              <div class="intro-left">
                <SectionTitle
                  title={page.introTitle}
                  align="left"
                  color={introTitleColor}
                  class="intro-title"
                />
              </div>
            )}
            <div class="intro-right">
              {page.introDescription && (
                <p
                  class="intro-description"
                  style={`color: ${introDescriptionColorResolved}`}
                >
                  {page.introDescription}
                </p>
              )}
              {page.introFooter && (
                <p class="intro-footer" style={`color: ${introFooterColor}`}>
                  {page.introFooter}
                </p>
              )}
            </div>
          </div>
        </div>
      </section>
    )
  }

  {/* Filter Bar */}
  {
    services && services.length > 0 && (
      <div class="filter-bar" style={filterCssVars}>
        <div class="container">
          <div class="filter-buttons">
            <button data-filter="all" class="filter-btn active">
              All
            </button>
            {services.map((service: { _id: string; title: string }) => (
              <button data-filter={service._id} class="filter-btn">
                {service.title}
              </button>
            ))}
          </div>
        </div>
      </div>
    )
  }

  {/* Case Studies Grid */}
  <section class="case-studies-content">
    <div class="container">
      <div class="case-studies-grid" data-animate="case-study-grid">
        {
          caseStudies.map((caseStudy: any) => (
            <div
              class="case-study-wrapper"
              data-service-id={caseStudy.relatedService?._id}
            >
              <CaseStudyCard
                mainImage={caseStudy.mainImage}
                icon={caseStudy.icon}
                category={caseStudy.category}
                client={caseStudy.client}
                role={caseStudy.role}
                overlayColorType={caseStudy.overlayColorType}
                overlayColorShade={caseStudy.overlayColorShade}
                overlayCustomColor={caseStudy.overlayCustomColor}
                overlayOpacity={caseStudy.overlayOpacity}
                iconBgColorType={caseStudy.iconBgColorType}
                iconBgColorShade={caseStudy.iconBgColorShade}
                iconBgCustomColor={caseStudy.iconBgCustomColor}
                iconColorType={caseStudy.iconColorType}
                iconColorShade={caseStudy.iconColorShade}
                iconCustomColor={caseStudy.iconCustomColor}
                categoryColor={caseStudy.categoryColor}
                clientColor={caseStudy.clientColor}
                roleColor={caseStudy.roleColor}
                date={caseStudy.date}
                description={caseStudy.description}
                contributionsTitle={caseStudy.contributionsTitle}
                contributions={caseStudy.contributions}
                contentBgColorType={caseStudy.contentBgColorType}
                contentBgColorShade={caseStudy.contentBgColorShade}
                contentBgCustomColor={caseStudy.contentBgCustomColor}
                dateColor={caseStudy.dateColor}
                descriptionColor={caseStudy.descriptionColor}
                contributionsTitleColorType={
                  caseStudy.contributionsTitleColorType
                }
                contributionsTitleColorShade={
                  caseStudy.contributionsTitleColorShade
                }
                contributionsTitleCustomColor={
                  caseStudy.contributionsTitleCustomColor
                }
                contributionsTextColor={caseStudy.contributionsTextColor}
                bulletColorType={caseStudy.bulletColorType}
                bulletColorShade={caseStudy.bulletColorShade}
                bulletCustomColor={caseStudy.bulletCustomColor}
              />
            </div>
          ))
        }
      </div>

      {
        caseStudies.length === 0 && (
          <p class="no-results">No case studies available yet.</p>
        )
      }
    </div>
  </section>
</BaseLayout>

<style>
  /* Intro Section */
  .case-studies-intro {
    padding-block: var(--space-xl);
  }

  .intro-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-lg);
  }

  @media (min-width: 768px) {
    .intro-grid {
      grid-template-columns: 1fr 1fr;
      gap: var(--space-xl);
    }
  }

  .intro-left {
    /* Left column container */
  }

  .intro-left :global(.intro-title) {
    margin-block-end: 0;
  }

  .intro-right {
    /* Right column container */
  }

  .intro-description {
    font-size: var(--font-size-base);
    line-height: var(--line-height-relaxed);
    margin: 0;
    margin-block-end: var(--space-md);
  }

  .intro-footer {
    font-family: var(--font-heading);
    font-size: var(--font-size-base);
    font-style: italic;
    font-weight: 500;
    margin: 0;
  }

  /* Filter Bar */
  .filter-bar {
    padding-block: var(--space-md);
    position: sticky;
    inset-block-start: var(--header-height);
    background-color: var(--color-background);
    z-index: var(--z-sticky);
  }

  .filter-bar .container {
    border-block-start: 1px solid var(--color-border);
    border-block-end: 1px solid var(--color-border);
    padding-block: var(--space-md);
  }

  .filter-buttons {
    display: flex;
    justify-content: center;
    gap: var(--space-sm);
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
  }

  .filter-buttons::-webkit-scrollbar {
    display: none;
  }

  .filter-btn {
    padding-inline: var(--space-md);
    padding-block: var(--space-sm);
    border-radius: var(--border-radius-full);
    font-size: var(--font-size-sm);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    white-space: nowrap;
    transition: all var(--transition-base);
    cursor: pointer;

    /* Inactive state */
    background: transparent;
    border: 1px solid var(--filter-inactive-border);
    color: var(--filter-inactive-text);
  }

  .filter-btn:hover {
    background: var(--filter-active-bg);
    border-color: var(--filter-active-bg);
    color: var(--filter-active-text);
  }

  .filter-btn:active {
    transform: scale(0.95);
  }

  .filter-btn.active {
    background: var(--filter-active-bg);
    border-color: var(--filter-active-bg);
    color: var(--filter-active-text);
  }

  /* Content Section */
  .case-studies-content {
    padding-block: var(--space-2xl);
  }

  .case-studies-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-xl);
  }

  .case-study-wrapper {
    display: block;
  }

  .case-study-wrapper[style*='display: none'] {
    display: none !important;
  }

  .no-results {
    text-align: center;
    color: var(--color-text-muted);
    padding-block: var(--space-2xl);
  }
</style>

<script>
  import { setupAnimationLifecycle, gsap } from '@lib/animation';

  setupAnimationLifecycle(() => {
    const prefersReducedMotion = window.matchMedia(
      '(prefers-reduced-motion: reduce)'
    ).matches;

    const grid = document.querySelector('[data-animate="case-study-grid"]');
    const filterButtons = document.querySelectorAll('[data-filter]');
    const cardWrappers = document.querySelectorAll('[data-service-id]');

    if (!grid) return;

    // Initial animation for all cards
    const allCards = grid.querySelectorAll('[data-animate="case-study"]');
    if (allCards.length && !prefersReducedMotion) {
      gsap.set(cardWrappers, { clearProps: 'all' });
      gsap.set(cardWrappers, { opacity: 0, y: 60 });

      gsap.to(cardWrappers, {
        opacity: 1,
        y: 0,
        duration: 0.6,
        ease: 'power2.out',
        stagger: 0.15,
        scrollTrigger: {
          trigger: grid,
          start: 'top 80%',
          toggleActions: 'play none none none',
        },
      });
    }

    // Filter functionality
    if (filterButtons.length && cardWrappers.length) {
      filterButtons.forEach((btn) => {
        btn.addEventListener('click', () => {
          const filter = (btn as HTMLElement).dataset.filter;

          // Update active state
          filterButtons.forEach((b) => b.classList.remove('active'));
          btn.classList.add('active');

          // Filter cards with animation
          let visibleIndex = 0;
          cardWrappers.forEach((wrapper) => {
            const serviceId = (wrapper as HTMLElement).dataset.serviceId;
            const shouldShow = filter === 'all' || serviceId === filter;

            if (shouldShow) {
              (wrapper as HTMLElement).style.display = '';

              if (!prefersReducedMotion) {
                gsap.fromTo(
                  wrapper,
                  { opacity: 0, y: 30 },
                  {
                    opacity: 1,
                    y: 0,
                    duration: 0.4,
                    ease: 'power2.out',
                    delay: visibleIndex * 0.1,
                  }
                );
              }
              visibleIndex++;
            } else {
              (wrapper as HTMLElement).style.display = 'none';
            }
          });
        });
      });
    }
  });
</script>
