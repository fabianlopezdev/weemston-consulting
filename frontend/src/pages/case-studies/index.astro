---
import BaseLayout from '@layouts/BaseLayout.astro';
import { sanityClient as client } from 'sanity:client';
import {
  caseStudiesPageQuery,
  servicesForFilterQuery,
  siteSettingsQuery,
} from '@lib/sanity/queries';
import { createTranslator } from '@lib/i18n/translations';
import { resolveColorSelection } from '@lib/sanity/colorResolver';
import { slugify } from '@lib/utils/url';
import CaseStudyBox from '@components/cards/CaseStudyBox.astro';
import CaseStudyModal from '@components/ui/CaseStudyModal.astro';
import InternalPageHero from '@components/sections/InternalPageHero.astro';
import SectionTitle from '@components/ui/SectionTitle.astro';
import PortableText from '@components/sanity/PortableText.astro';

const lang = Astro.locals.lang || 'en';
const t = createTranslator(lang);

// Fetch all data
const [page, services, settings] = await Promise.all([
  client.fetch(caseStudiesPageQuery),
  client.fetch(servicesForFilterQuery, { language: lang }),
  client.fetch(siteSettingsQuery),
]);

const caseStudies = page?.caseStudies || [];

const siteColors = settings?.colors;

// Build service mapping: CaseStudy ID -> Array of Services that feature it
// This uses the inverse relationship (services have featuredCaseStudies array)
interface ServiceWithCaseStudies {
  _id: string;
  title: string;
  featuredCaseStudies?: Array<{ _id: string }>;
}

const caseStudyToServices = new Map<
  string,
  Array<{ _id: string; title: string }>
>();

(services as ServiceWithCaseStudies[])?.forEach((service) => {
  service.featuredCaseStudies?.forEach((cs) => {
    if (!caseStudyToServices.has(cs._id)) {
      caseStudyToServices.set(cs._id, []);
    }
    caseStudyToServices
      .get(cs._id)!
      .push({ _id: service._id, title: service.title });
  });
});

// Resolve intro title color
const introTitleColor = resolveColorSelection(
  {
    colorType: page?.introTitleColorType || 'accent',
    shade: page?.introTitleColorShade || 0,
    customColor: page?.introTitleCustomColor,
  },
  siteColors
);

// Text color map for description
const textColorMap: Record<string, string> = {
  base: 'var(--color-text)',
  muted: 'var(--color-text-muted)',
  contrast: 'var(--color-text-contrast)',
};

const introDescriptionColorResolved =
  textColorMap[page?.introDescriptionColor || 'base'] || textColorMap.base;

// Resolve intro footer color
const introFooterColor = resolveColorSelection(
  {
    colorType: page?.introFooterColorType || 'accent',
    shade: page?.introFooterColorShade || 0,
    customColor: page?.introFooterCustomColor,
  },
  siteColors
);

// Resolve filter colors
const filterActiveColor = resolveColorSelection(
  {
    colorType: page?.filterActiveColorType || 'accent',
    shade: page?.filterActiveColorShade || 0,
    customColor: page?.filterActiveCustomColor,
  },
  siteColors
);

const filterInactiveColor = resolveColorSelection(
  {
    colorType: page?.filterInactiveColorType || 'secondary',
    shade: page?.filterInactiveColorShade || 0,
    customColor: page?.filterInactiveCustomColor,
  },
  siteColors
);

const filterActiveTextResolved =
  textColorMap[page?.filterActiveTextColor || 'contrast'] ||
  textColorMap.contrast;
const filterInactiveTextResolved =
  textColorMap[page?.filterInactiveTextColor || 'muted'] || textColorMap.muted;

// Build filter CSS variables
const filterCssVars = [
  `--filter-active-bg: ${filterActiveColor}`,
  `--filter-active-text: ${filterActiveTextResolved}`,
  `--filter-inactive-border: ${filterInactiveColor}`,
  `--filter-inactive-text: ${filterInactiveTextResolved}`,
].join('; ');
---

<BaseLayout title={page?.title || t('seo.case_studies_title')}>
  {/* Hero Section */}
  {
    page?.heroHeading && (
      <InternalPageHero
        heading={page.heroHeading}
        headingHighlight={page.heroHeadingHighlight}
        highlightColorType={page.heroHighlightColorType}
        highlightColorShade={page.heroHighlightColorShade}
        highlightCustomColor={page.heroHighlightCustomColor}
        showDivider={page.heroShowDivider}
        dividerColorType={page.heroDividerColorType}
        dividerColorShade={page.heroDividerColorShade}
        dividerCustomColor={page.heroDividerCustomColor}
        tagline={page.heroTagline}
        taglineColor={page.heroTaglineColor}
        backgroundColorType={page.heroBackgroundColorType}
        backgroundColorShade={page.heroBackgroundColorShade}
        backgroundCustomColor={page.heroBackgroundCustomColor}
      />
    )
  }

  {/* Intro Section */}
  {
    (page?.introTitle || page?.introDescription) && (
      <section class="case-studies-intro">
        <div class="container">
          <div class="intro-content">
            {page.introTitle && (
              <SectionTitle
                title={page.introTitle}
                align="center"
                color={introTitleColor}
                class="intro-title"
              />
            )}
            {page.introDescription && page.introDescription.length > 0 && (
              <div
                class="intro-description"
                style={`color: ${introDescriptionColorResolved}`}
              >
                <PortableText content={page.introDescription} />
              </div>
            )}
            {page.introFooter && (
              <p class="intro-footer" style={`color: ${introFooterColor}`}>
                {page.introFooter}
              </p>
            )}
          </div>
        </div>
      </section>
    )
  }

  {/* Filter Bar */}
  {
    services && services.length > 0 && (
      <div class="filter-bar" style={filterCssVars}>
        <div class="container">
          <div class="filter-buttons">
            <button data-filter="all" class="filter-btn active">
              All
            </button>
            {(services as ServiceWithCaseStudies[]).map((service) => (
              <button data-filter={service._id} class="filter-btn">
                {service.title}
              </button>
            ))}
          </div>
        </div>
      </div>
    )
  }

  {/* Case Studies Grid */}
  <section class="case-studies-content">
    <div class="container">
      <div class="case-studies-grid" data-animate="case-study-grid">
        {
          caseStudies.map((caseStudy: any) => {
            const serviceTags = caseStudyToServices.get(caseStudy._id) || [];
            return (
              <div
                id={slugify(caseStudy.client)}
                class="case-study-wrapper"
                data-service-ids={serviceTags.map((s) => s._id).join(',')}
              >
                <CaseStudyBox
                  id={caseStudy._id}
                  client={caseStudy.client}
                  clientLogo={caseStudy.clientLogo}
                  logoVariant={caseStudy.logoVariant}
                  serviceTags={serviceTags}
                  boxBgColorType={page?.boxBgColorType}
                  boxBgColorShade={page?.boxBgColorShade}
                  boxBgCustomColor={page?.boxBgCustomColor}
                  boxHoverBgColorType={page?.boxHoverBgColorType}
                  boxHoverBgColorShade={page?.boxHoverBgColorShade}
                  boxHoverBgCustomColor={page?.boxHoverBgCustomColor}
                  tagColorType={page?.tagColorType}
                  tagColorShade={page?.tagColorShade}
                  tagCustomColor={page?.tagCustomColor}
                  ctaTextColor={page?.ctaTextColor}
                />
              </div>
            );
          })
        }
      </div>

      {
        caseStudies.length === 0 && (
          <p class="no-results">No case studies available yet.</p>
        )
      }
    </div>
  </section>

  {/* Case Study Modal */}
  <CaseStudyModal
    caseStudies={caseStudies}
    leftPanelBgColorType={page?.modalLeftBgColorType}
    leftPanelBgColorShade={page?.modalLeftBgColorShade}
    leftPanelBgCustomColor={page?.modalLeftBgCustomColor}
    backdropColorType={page?.modalBackdropColorType}
    backdropColorShade={page?.modalBackdropColorShade}
    backdropCustomColor={page?.modalBackdropCustomColor}
    clientNameColorType={page?.modalClientNameColorType}
    clientNameColorShade={page?.modalClientNameColorShade}
    clientNameCustomColor={page?.modalClientNameCustomColor}
    dateColorType={page?.modalDateColorType}
    dateColorShade={page?.modalDateColorShade}
    dateCustomColor={page?.modalDateCustomColor}
    dividerColorType={page?.modalDividerColorType}
    dividerColorShade={page?.modalDividerColorShade}
    dividerCustomColor={page?.modalDividerCustomColor}
    descriptionColor={page?.modalDescriptionColor}
    contributionsTitleColorType={page?.modalContributionsTitleColorType}
    contributionsTitleColorShade={page?.modalContributionsTitleColorShade}
    contributionsTitleCustomColor={page?.modalContributionsTitleCustomColor}
    contributionsTextColor={page?.modalContributionsTextColor}
    bulletColorType={page?.modalBulletColorType}
    bulletColorShade={page?.modalBulletColorShade}
    bulletCustomColor={page?.modalBulletCustomColor}
  />
</BaseLayout>

<style>
  /* Intro Section */
  .case-studies-intro {
    padding-block: var(--space-xl);
  }

  .intro-content {
    text-align: center;
    max-width: 800px;
    margin-inline: auto;
  }

  .intro-content :global(.intro-title) {
    margin-block-end: var(--space-md);
  }

  .intro-description {
    font-size: var(--font-size-base);
    line-height: var(--line-height-relaxed);
    margin: 0;
    margin-block-end: var(--space-md);
  }

  .intro-description :global(p) {
    margin: 0;
  }

  .intro-description :global(p + p) {
    margin-block-start: 0.75em;
  }

  .intro-footer {
    font-family: var(--font-heading);
    font-size: var(--font-size-base);
    font-style: italic;
    font-weight: 500;
    margin: 0;
    width: 100%;
    max-inline-size: none;
  }

  /* Filter Bar */
  .filter-bar {
    padding-block: var(--space-md);
    position: sticky;
    inset-block-start: var(--header-height);
    background-color: var(--color-background);
    z-index: var(--z-sticky);
  }

  .filter-bar .container {
    border-block-start: 1px solid var(--color-border);
    border-block-end: 1px solid var(--color-border);
    padding-block: var(--space-md);
  }

  .filter-buttons {
    display: flex;
    justify-content: center;
    gap: var(--space-sm);
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
  }

  .filter-buttons::-webkit-scrollbar {
    display: none;
  }

  .filter-btn {
    padding-inline: var(--button-padding-horizontal, var(--space-md));
    padding-block: var(--button-padding-vertical, var(--space-sm));
    border-radius: var(--button-border-radius, var(--border-radius-full));
    font-size: var(--font-size-sm);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    white-space: nowrap;
    transition: all var(--transition-base);
    cursor: pointer;

    /* Inactive state */
    background: transparent;
    border: 1px solid var(--filter-inactive-border);
    color: var(--filter-inactive-text);
  }

  .filter-btn:hover {
    background: var(--filter-active-bg);
    border-color: var(--filter-active-bg);
    color: var(--filter-active-text);
  }

  .filter-btn:active {
    transform: scale(0.95);
  }

  .filter-btn.active {
    background: var(--filter-active-bg);
    border-color: var(--filter-active-bg);
    color: var(--filter-active-text);
  }

  /* Content Section */
  .case-studies-content {
    padding-block: var(--space-2xl);
  }

  /* Grid Layout - Multi-column */
  .case-studies-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-lg);
  }

  @media (min-width: 640px) {
    .case-studies-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (min-width: 1024px) {
    .case-studies-grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  .case-study-wrapper {
    display: block;
  }

  .case-study-wrapper[style*='display: none'] {
    display: none !important;
  }

  .no-results {
    text-align: center;
    color: var(--color-text-muted);
    padding-block: var(--space-2xl);
  }
</style>

<script>
  import { setupAnimationLifecycle, gsap } from '@lib/animation';

  setupAnimationLifecycle(() => {
    const grid = document.querySelector(
      '[data-animate="case-study-grid"]'
    ) as HTMLElement | null;

    if (!grid || grid.dataset.initialized === 'true') return;
    grid.dataset.initialized = 'true';

    const prefersReducedMotion = window.matchMedia(
      '(prefers-reduced-motion: reduce)'
    ).matches;

    const filterButtons = document.querySelectorAll('[data-filter]');
    const boxWrappers = document.querySelectorAll('[data-service-ids]');

    // Initial page load animation only
    const allBoxes = grid.querySelectorAll('.case-study-wrapper');
    if (allBoxes.length && !prefersReducedMotion) {
      gsap.set(allBoxes, { clearProps: 'all' });
      gsap.set(allBoxes, { y: 40 });

      gsap.to(allBoxes, {
        y: 0,
        duration: 0.5,
        ease: 'power2.out',
        stagger: 0.08,
        scrollTrigger: {
          trigger: grid,
          start: 'top 80%',
          toggleActions: 'play none none none',
        },
      });
    }

    // Filter functionality - no animation, just show/hide
    if (filterButtons.length && boxWrappers.length) {
      filterButtons.forEach((btn) => {
        btn.addEventListener('click', () => {
          const filter = (btn as HTMLElement).dataset.filter;

          filterButtons.forEach((b) => b.classList.remove('active'));
          btn.classList.add('active');

          boxWrappers.forEach((wrapper) => {
            const serviceIds =
              (wrapper as HTMLElement).dataset.serviceIds
                ?.split(',')
                .filter(Boolean) || [];
            const shouldShow =
              filter === 'all' || (filter && serviceIds.includes(filter));

            (wrapper as HTMLElement).style.display = shouldShow ? '' : 'none';
          });
        });
      });
    }
  });
</script>
