---
import BaseLayout from '@layouts/BaseLayout.astro';
import { sanityClient as client } from 'sanity:client';
import { servicesPageQuery } from '@lib/sanity/queries';
import HeroSection from '@components/sections/HeroSection.astro';
import SectionRenderer from '@components/sections/SectionRenderer.astro';
import { urlForImage } from '@lib/sanity/image';
import PortableText from '@components/sanity/PortableText.astro';

const lang = Astro.locals.lang || 'en';
const servicesPage = await client.fetch(servicesPageQuery, {
  documentId: `servicesPage-${lang}`,
});

if (!servicesPage) {
  return Astro.redirect('/404');
}

// Filter enabled sections
const visibleSections =
  servicesPage.sections?.filter((section: any) => section.enabled) || [];
---

<BaseLayout
  title={servicesPage.title}
  description={servicesPage.metaDescription}
>
  {servicesPage.hero && <HeroSection {...servicesPage.hero} />}

  {
    servicesPage.intro && (
      <section class="services-intro">
        <div class="container">
          <p class="intro-text">{servicesPage.intro}</p>
        </div>
      </section>
    )
  }

  {
    servicesPage.services && servicesPage.services.length > 0 && (
      <section class="services-list">
        <div class="container">
          <div class="services-grid">
            {servicesPage.services.map((service: any) => {
              const iconUrl = service.icon
                ? urlForImage(service.icon).width(100).height(100).url()
                : null;

              return (
                <div class="service-card">
                  {iconUrl && (
                    <div class="service-card__icon">
                      <img src={iconUrl} alt="" />
                    </div>
                  )}
                  <h3 class="service-card__title">{service.title}</h3>
                  {service.content && (
                    <div class="service-card__description">
                      <PortableText content={service.content} />
                    </div>
                  )}
                </div>
              );
            })}
          </div>
        </div>
      </section>
    )
  }

  {visibleSections.map((section: any) => <SectionRenderer section={section} />)}
</BaseLayout>

<style>
  .services-intro {
    padding: var(--space-xl) 0;
    background: var(--color-surface-alt, #f9f9f9);
  }

  .intro-text {
    font-size: var(--font-size-lg);
    line-height: 1.8;
    max-width: 800px;
    margin-inline: auto;
    text-align: center;
    opacity: 0.9;
  }

  .services-list {
    padding: var(--space-2xl) 0;
  }

  .services-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: var(--space-lg);
  }

  .service-card {
    padding: var(--space-lg);
    border: 1px solid var(--color-border, #e0e0e0);
    border-radius: var(--border-radius, 8px);
    transition:
      transform 0.2s,
      box-shadow 0.2s;
  }

  .service-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
  }

  .service-card__icon {
    width: 60px;
    height: 60px;
    margin-block-end: var(--space-md);
  }

  .service-card__icon img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  .service-card__title {
    font-size: var(--font-size-lg);
    margin-block-end: var(--space-sm);
  }

  .service-card__description {
    font-size: var(--font-size-sm);
    opacity: 0.8;
    line-height: 1.6;
  }
</style>
