---
import BaseLayout from '@layouts/BaseLayout.astro';
import { sanityClient as client } from 'sanity:client';
import { aboutPageQuery } from '@lib/sanity/queries';
import HeroSection from '@components/sections/HeroSection.astro';

const lang = Astro.locals.lang || 'en';
const aboutPage = await client.fetch(aboutPageQuery, {
  documentId: `aboutPage-${lang}`,
});

if (!aboutPage) {
  return Astro.redirect('/404');
}

// Extract plain text from portable text
const getPlainText = (blocks: any[]) => {
  if (!blocks || !Array.isArray(blocks)) return '';
  return blocks
    .filter((block) => block._type === 'block')
    .map((block) => {
      return block.children?.map((child: any) => child.text).join('');
    })
    .join('\n\n');
};

const content = aboutPage.content ? getPlainText(aboutPage.content) : '';
---

<BaseLayout title={aboutPage.title} description={aboutPage.metaDescription}>
  {aboutPage.hero && <HeroSection {...aboutPage.hero} />}

  {
    content && (
      <section class="about-content">
        <div class="container">
          {content.split('\n\n').map((paragraph) => (
            <p class="about-paragraph">{paragraph}</p>
          ))}
        </div>
      </section>
    )
  }
</BaseLayout>

<style>
  .about-content {
    padding: var(--space-2xl) 0;
  }

  .container {
    max-width: 900px;
    margin-inline: auto;
    padding-inline: var(--space-md);
  }

  .about-paragraph {
    font-size: var(--font-size-base);
    line-height: 1.8;
    margin-block-end: var(--space-md);
  }

  .about-paragraph:last-child {
    margin-block-end: 0;
  }
</style>
